<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XX中學圖書館 | 每週新書速遞</title>
    <script type="module">
        // 引入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, get, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyAJhvIuZh_Fo96OTpil-7aAu1k7H61A3GQ",
            authDomain: "newbookf-a73de-5a312.firebaseapp.com",
            databaseURL: "https://newbookf-a73de-5a312-default-rtdb.firebaseio.com",
            projectId: "newbookf-a73de-5a312",
            storageBucket: "newbookf-a73de-5a312.appspot.com",
            messagingSenderId: "1006721196866",
            appId: "1:1006721196866:web:134b572dd122bf221bdedb"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 全域資料（掛載到window確保所有地方可訪問）
        window.libraryData = {
            issues: {},
            reserveRecords: [],
            recommendRecords: [],
            latestIssue: 1,
            allBooks: []
        };

        // 從 Firebase 載入資料
        async function loadData() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                // 优先加载必要数据（最新一期+系统设置）
                const [settingsSnapshot, latestIssueSnapshot] = await Promise.all([
                    get(ref(db, "settings/system")), // 系统设置（最新期数）
                    get(ref(db, `issues/${window.libraryData.latestIssue || 1}`)) // 只加载最新一期数据
                ]);

                // 初始化基础数据
                window.libraryData.latestIssue = settingsSnapshot.exists() ? settingsSnapshot.val().latestIssue : 1;
                window.libraryData.issues = {};
                // 只保存最新一期数据
                if (latestIssueSnapshot.exists()) {
                    window.libraryData.issues[window.libraryData.latestIssue] = latestIssueSnapshot.val();
                }

                // 延迟加载非必要数据（预约/推荐记录）
                setTimeout(async () => {
                    const reservesSnapshot = await get(ref(db, "reserves"));
                    window.libraryData.reserveRecords = reservesSnapshot.exists() 
                        ? Object.values(reservesSnapshot.val()).map((r, i) => ({ ...r, id: Object.keys(reservesSnapshot.val())[i] }))
                        : [];

                    const recommendsSnapshot = await get(ref(db, "recommends"));
                    window.libraryData.recommendRecords = recommendsSnapshot.exists()
                        ? Object.values(recommendsSnapshot.val()).map((r, i) => ({ ...r, id: Object.keys(recommendsSnapshot.val())[i] }))
                        : [];
                    renderUserRecommendList(); // 延迟渲染推荐列表
                }, 1000); // 延迟1秒加载，优先保证主页面显示

                // 收集最新一期书籍（而非全部）
                collectAllBooks();
                init();
                document.getElementById('loadingIndicator').style.display = 'none';
            } catch (err) {
                console.error("載入失敗:", err);
                alert("資料載入失敗，請重新整理頁面");
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // 收集所有書籍（確保海報書籍被正確收錄）
        function collectAllBooks() {
            window.libraryData.allBooks = [];
            // 遍历所有期数
            for (const issue in window.libraryData.issues) {
                const issueData = window.libraryData.issues[issue];
                // 遍历所有海報
                for (const poster in issueData.books) {
                    const posterBooks = issueData.books[poster];
                    // 遍历所有书籍
                    for (const bookNum in posterBooks) {
                        const book = { ...posterBooks[bookNum] };
                        // 强制设置标准ID
                        book.id = `issue-${issue}-poster-${poster}-book-${bookNum}`;
                        book.issue = issue;
                        book.posterNum = poster;
                        book.bookNum = bookNum;
                        window.libraryData.allBooks.push(book);
                    }
                }
            }
        }

        // 儲存資料到 Firebase
        async function saveData() {
            try {
                await set(ref(db, "issues"), window.libraryData.issues);
                await set(ref(db, "settings/system"), { latestIssue: window.libraryData.latestIssue });
                collectAllBooks();
            } catch (err) {
                alert("儲存失敗，請重試");
            }
        }

        // 儲存預約記錄（預約成功自動改為"已被預約"）
        window.saveReserveRecord = async function(record) {
            try {
                const recordId = Date.now().toString();
                await set(ref(db, `reserves/${recordId}`), record);
                record.id = recordId;
                window.libraryData.reserveRecords.push(record);
                
                // 解析标准化ID（适配新的ID格式）
                const idParts = record.bookId.split('-'); // 格式：issue-x-poster-y-book-z
                const issue = idParts[1];       // 提取期数
                const poster = idParts[3];      // 提取海報号
                const bookNum = idParts[5];     // 提取书籍号

                // 更新书籍状态为"已被預約"
                if (window.libraryData.issues[issue]?.books[poster]?.[bookNum]) {
                    window.libraryData.issues[issue].books[poster][bookNum].status = 'reserved';
                    await saveData();
                    collectAllBooks();
                    renderCurrentView(); // 立即刷新当前页面的书籍卡片
                }
                renderReserveRecords();
            } catch (err) {
                console.error("預約失敗:", err);
                alert("預約失敗，請重試");
            }
        }

        // 更新預約狀態（修復狀態同步）
        window.updateReserveStatus = async function(index, status) {
            try {
                const record = window.libraryData.reserveRecords[index];
                record.status = status;
                await update(ref(db, `reserves/${record.id}`), { status });
                
                // 解析标准化ID
                const idParts = record.bookId.split('-');
                const issue = idParts[1];
                const poster = idParts[3];
                const bookNum = idParts[5];

                // 根据不同状态更新书籍状态
                if (window.libraryData.issues[issue]?.books[poster]?.[bookNum]) {
                    let bookStatus;
                    if (status === '已還書' || status === '找不到') {
                        bookStatus = 'in'; // 已還書或找不到时，恢复可预约
                    } else if (status === '借走了') {
                        bookStatus = 'out'; // 借走了时，标记为不在架
                    } else {
                        bookStatus = 'reserved'; // 其他状态（已预约/处理中）保持已预约
                    }

                    window.libraryData.issues[issue].books[poster][bookNum].status = bookStatus;
                    await saveData();
                    collectAllBooks();
                    renderCurrentView(); // 刷新当前页面显示
                }
                renderReserveRecords(); // 刷新预约记录列表
            } catch (err) {
                console.error("更新失敗:", err);
                alert("更新失敗");
            }
        }

        // 儲存推薦記錄
        window.saveRecommendRecord = async function(record) {
            try {
                const recordId = Date.now().toString();
                await set(ref(db, `recommends/${recordId}`), record);
                record.id = recordId;
                window.libraryData.recommendRecords.push(record);
                renderRecommendRecords();
                renderUserRecommendList();
            } catch (err) {
                alert("推薦失敗");
            }
        }

        // 更新推薦狀態
        window.updateRecommendStatus = async function(index, status) {
            try {
                const record = window.libraryData.recommendRecords[index];
                record.status = status;
                await update(ref(db, `recommends/${record.id}`), { status });
                renderUserRecommendList();
            } catch (err) {
                alert("更新失敗");
            }
        }

        // 初始化頁面
        function init() {
            renderIssueSelectors();
            showLatestIssue();
            initCategoryDropdown();
            renderUserRecommendList();
            // 顯示海報容器
            document.getElementById('posterThumbContainer').style.display = 'flex';
            // 初始化时默认选中"最新一期"
            document.querySelector('.nav-item').classList.add('active');
            
            // 初始化手机版组件（如果是手机端）
            if (document.body.classList.contains('device-mobile')) {
                initMobileIssueSelector();
                renderMobilePosters(window.libraryData.latestIssue);
                renderMobileBooks(window.libraryData.latestIssue, 1);
                // 绑定分类和搜索的点击事件
                document.getElementById('categoryToggle').addEventListener('click', toggleCategorySidebar);
                document.getElementById('categoryClose').addEventListener('click', closeCategorySidebar);
                document.getElementById('searchToggle').addEventListener('click', toggleSearchPanel);
            }
// 点击空白处收起分类侧边栏（手机版）
document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('categorySidebar');
    const toggleBtn = document.getElementById('categoryToggle');
    // 点击空白且侧边栏已展开时收起
    if (sidebar.classList.contains('open') && 
        !sidebar.contains(e.target) && 
        e.target !== toggleBtn) {
        sidebar.classList.remove('open');
    }
});
        }

        // 渲染期數選擇器
        function renderIssueSelectors() {
            const issues = Object.keys(window.libraryData.issues).map(Number).sort((a, b) => a - b);
            const selectors = [
                document.getElementById('issueSelect'),
                document.getElementById('posterIssueSelect'),
                document.getElementById('bookIssueSelect')
            ];
            
            selectors.forEach(sel => {
                sel.innerHTML = '';
                issues.forEach(issue => {
                    sel.innerHTML += `<option value="${issue}">第${issue}期</option>`;
                });
                sel.value = window.libraryData.latestIssue;
            });
        }

        // 切換期數
        window.switchIssue = function(issue) {
            const issueNum = Number(issue);
            document.getElementById('currentIssueTitle').textContent = `第${issueNum}期海報`;
            renderPosterThumbs(issueNum);
            renderBooks(issueNum, 1);
            // 顯示海報
            document.getElementById('posterThumbContainer').style.display = 'flex';
            showSection('posterSection');
            
            // 手机版切换期数同步更新
            if (document.body.classList.contains('device-mobile')) {
                renderMobilePosters(issueNum);
                renderMobileBooks(issueNum, 1);
                document.getElementById('mobileIssueSelect').value = issueNum;
            }
        }

        // 顯示最新一期
        window.showLatestIssue = function() {
            window.switchIssue(window.libraryData.latestIssue);
            document.getElementById('issueSelect').value = window.libraryData.latestIssue;
        }

        // 初始化分類下拉
        function initCategoryDropdown() {
            const trigger = document.querySelector('.category-trigger');
            const menu = document.getElementById('categoryMenu');
            let isShow = false;

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                isShow = !isShow;
                menu.classList.toggle('visible', isShow);
            });

            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const category = item.dataset.category;
                    filterByCategory(category);
                    isShow = false;
                    menu.classList.remove('visible');
                });
            });

            document.addEventListener('click', () => {
                isShow = false;
                menu.classList.remove('visible');
            });
        }

        // 分類篩選（修復預約無法送出的問題）
        function filterByCategory(category) {
            const books = window.libraryData.allBooks;
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            // 隱藏海報
            document.getElementById('posterThumbContainer').style.display = 'none';

            const filtered = category === 'all' ? books : books.filter(b => b.classCode === category);
            
            filtered.forEach((book, index) => {
                const card = createBookCard(book);
                card.dataset.group = Math.ceil((index + 1) / 3);
                container.appendChild(card);
            });

            showSection('posterSection');
            document.getElementById('currentIssueTitle').textContent = category === 'all' ? '全部書籍' : `${category} 分類書籍`;
            // 確保數據同步
            collectAllBooks();
            
            // 手机版分类筛选同步更新
            if (document.body.classList.contains('device-mobile')) {
                const container = document.getElementById('mobileBooksGrid');
                container.innerHTML = '';
                
                if (filtered.length === 0) {
                    container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--text-light);">沒有找到匹配的書籍</div>';
                } else {
                    filtered.forEach(book => {
                        let statusClass = 'status-in-mobile';
                        let statusText = '在架（可預約）';
                        if (book.status === 'out') {
                            statusClass = 'status-out-mobile';
                            statusText = '不在架';
                        } else if (book.status === 'reserved') {
                            statusClass = 'status-reserved-mobile';
                            statusText = '已被預約';
                        }

                        const card = document.createElement('div');
                        card.className = 'book-card-mobile';
                        card.innerHTML = `
                            <img src="${book.cover || 'https://via.placeholder.com/80x120?text=封面'}" class="book-cover-mobile">
                            <div class="book-title-mobile">${book.title || '未知書名'}</div>
                            <div class="book-meta-mobile">作者: ${book.author || '待編輯'}</div>
                            <div class="book-status-mobile ${statusClass}">${statusText}</div>
                            ${book.status === 'in' ? `<button class="reserve-btn-mobile" onclick="
    showReserveModal('${book.id}');
    event.stopPropagation();
">預約</button>` : ''}
                        `;
                        container.appendChild(card);
                    });
                }
            }
        }

        // 渲染用戶推薦列表
        function renderUserRecommendList() {
            const list = document.getElementById('userRecommendList');
            list.innerHTML = '';
            const sorted = [...window.libraryData.recommendRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                list.innerHTML = '<p>暫無推薦記錄</p>';
                return;
            }

            sorted.forEach((r, i) => {
                let statusText = r.status === '已推薦' ? '推薦中' : r.status === '已記錄' ? '已記錄' : '不合規定';
                let statusClass = r.status === '已推薦' ? 'status-pending' : r.status === '已記錄' ? 'status-recorded' : 'status-invalid';
                // 獲取隨機顏色
                const randomColor = window.getRandomSoftColor();
                list.innerHTML += `
                    <div class="recommend-item">
                        <span class="recommend-index" style="background: ${randomColor}">${i + 1}</span>
                        <span class="recommend-name">${r.bookName}</span>
                        <span class="recommend-status ${statusClass}">${statusText}</span>
                    </div>
                `;
            });
        }

        // 渲染海報
        function renderPosterThumbs(issue) {
            const container = document.getElementById('posterThumbContainer');
            container.innerHTML = '';

            for (let i = 1; i <= 2; i++) {
                const url = window.libraryData.issues[issue]?.posters[i] || '';
                if (url) {
                    container.innerHTML += `<img src="${url}" class="poster-thumb" data-poster="${i}" onclick="renderBooks(${issue}, ${i})" loading="lazy">`;
                } else {
                    container.innerHTML += `<div class="poster-thumb placeholder" data-poster="${i}" onclick="renderBooks(${issue}, ${i})">海報${i}<br>[暫未上傳]</div>`;
                }
            }
        }

        // 创建书籍卡片（添加编辑点击事件）
        function createBookCard(book) {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.dataset.classCode = book.classCode;
            card.dataset.id = book.id;

            // 解析书籍ID获取期数/海報/序号信息（用于编辑）
            const idParts = book.id.split('-'); // 格式：issue-x-poster-y-book-z
            const issue = idParts[1];
            const poster = idParts[3];
            const bookNum = idParts[5];
            // 生成编辑点击事件（仅管理员可见，普通用户点击无反应）
            const editOnClick = `onclick="fillBookEditor('${issue}', '${poster}', '${bookNum}')"`;

            let statusText, statusClass, reserveBtn;
            if (book.status === 'in') {
                statusText = '在架（可預約）';
                statusClass = 'status-in';
                reserveBtn = `<button class="reserve-btn" onclick="showReserveModal('${book.id}')">預約</button>`;
            } else if (book.status === 'out') {
                statusText = '不在架';
                statusClass = 'status-out';
                reserveBtn = '';
            } else {
                statusText = '已被預約';
                statusClass = 'status-reserved';
                reserveBtn = '';
            }

            // 卡片内容（添加编辑点击事件）
            card.innerHTML = `
                <div ${editOnClick} style="cursor: pointer;">
                    <img src="${book.cover || 'https://via.placeholder.com/80x120?text=封面'}" class="book-cover" loading="lazy">
                    <h3 class="book-title">${book.title}</h3>
                    <p>作者: ${book.author || '待編輯'}</p>
                    <p>簡介: ${book.intro || '待編輯'}</p>
                    <p>適合: ${book.suitable || '待編輯'}</p>
                    <div class="book-status-bar">
                        <span class="book-status ${statusClass}">${statusText}</span>
                        ${reserveBtn}
                    </div>
                    <p class="book-callno">索書號: ${book.callNo || '待編輯'}</p>
                </div>
            `;

            return card;
        }

        // 渲染書籍列表（彻底修复预约找不到书籍的问题）
        window.renderBooks = function(issue, posterNum) {
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            // 确保期数和书籍容器存在
            if (!window.libraryData.issues[issue]) {
                window.libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
            }
            if (!window.libraryData.issues[issue].books[posterNum]) {
                window.libraryData.issues[issue].books[posterNum] = {};
            }
            const books = window.libraryData.issues[issue].books[posterNum];

            for (let i = 1; i <= 9; i++) {
                // 强制初始化书籍信息，确保每个卡片都有完整数据
                let book = books[i] || {
                    id: `issue-${issue}-poster-${posterNum}-book-${i}`,
                    issue: issue.toString(), // 确保是字符串类型
                    posterNum: posterNum.toString(), // 确保是字符串类型
                    bookNum: i.toString(),
                    callNo: '待編輯',
                    title: '新書' + i,
                    classCode: '000',
                    author: '待編輯',
                    intro: '待編輯',
                    suitable: '待編輯',
                    status: 'in', // 默认设为可预约状态，方便测试
                    cover: `https://via.placeholder.com/80x120?text=新書${i}`
                };
                // 强制写入数据，确保不会丢失
                books[i] = book;
                window.libraryData.issues[issue].books[posterNum][i] = book;
                
                const card = createBookCard(book);
                card.dataset.group = Math.ceil(i / 3);
                container.appendChild(card);
            }
            // 强制更新全局书籍列表和Firebase数据
            collectAllBooks();
            saveData(); // 立即保存到数据库，确保数据不丢失
        }

        // 渲染當前視圖
        function renderCurrentView() {
            const activeSec = document.querySelector('.content-section:not(.hidden)');
            if (activeSec.id === 'posterSection') {
                const issue = document.getElementById('issueSelect').value;
                const poster = document.querySelector('.poster-thumb:hover')?.dataset.poster || '1';
                window.renderBooks(issue, poster);
            }
        }

        // 渲染預約記錄
        function renderReserveRecords() {
            const container = document.getElementById('reserveRecordsContainer');
            container.innerHTML = '';
            const sorted = [...window.libraryData.reserveRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                container.innerHTML = '<p>暫無預約記錄</p>';
                return;
            }

            sorted.forEach((r, i) => {
                container.innerHTML += `
                    <div class="record-item">
                        <div>${r.time} | ${r.bookTitle} | ${r.className} ${r.studentName}</div>
                        <select onchange="updateReserveStatus(${i}, this.value)">
                            <option ${r.status === '已預約' ? 'selected' : ''}>已預約</option>
                            <option ${r.status === '處理中' ? 'selected' : ''}>處理中</option>
                            <option ${r.status === '借走了' ? 'selected' : ''}>借走了</option>
                            <option ${r.status === '找不到' ? 'selected' : ''}>找不到</option>
                            <option ${r.status === '已還書' ? 'selected' : ''}>已還書</option>
                        </select>
                    </div>
                `;
            });
        }

        // 渲染推薦記錄
        function renderRecommendRecords() {
            const container = document.getElementById('recommendRecordsContainer');
            container.innerHTML = '';
            const sorted = [...window.libraryData.recommendRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                container.innerHTML = '<p>暫無推薦記錄</p>';
                return;
            }

            sorted.forEach((r, i) => {
                container.innerHTML += `
                    <div class="record-item">
                        <div>${r.time} | 書名: ${r.bookName} | 理由: ${r.reason}</div>
                        <select onchange="updateRecommendStatus(${i}, this.value)">
                            <option ${r.status === '已推薦' ? 'selected' : ''}>已推薦</option>
                            <option ${r.status === '已記錄' ? 'selected' : ''}>已記錄</option>
                            <option ${r.status === '不合規定' ? 'selected' : ''}>不合規定</option>
                        </select>
                    </div>
                `;
            });
        }

        // 顯示預約彈窗（修复找不到书籍的问题）
        window.showReserveModal = function(bookId) {
            // 双重检查：先从allBooks找，找不到则直接从原数据解析
            let book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                // 直接从bookId解析出书的位置并读取
                const idParts = bookId.split('-');
                const issue = idParts[1];
                const poster = idParts[3];
                const bookNum = idParts[5];
                if (window.libraryData.issues[issue]?.books[poster]?.[bookNum]) {
                    book = window.libraryData.issues[issue].books[poster][bookNum];
                }
            }
            if (!book) {
                alert('未找到這本書的資訊，請刷新頁面重試');
                return;
            }
            document.getElementById('bookReserveInfo').innerText = `書名: ${book.title || '未知書名'}`;
            document.getElementById('reserveBookId').value = bookId;
            document.getElementById('reserveModal').style.display = 'flex';
        }

        // 提交預約
        window.submitReserve = function() {
            const bookId = document.getElementById('reserveBookId').value;
            const book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                alert('書籍資訊不存在');
                return;
            }

            const className = document.getElementById('className').value.trim();
            const studentName = document.getElementById('studentName').value.trim();

            if (!className) {
                alert('請填寫班級');
                return;
            }
            if (!studentName) {
                alert('請填寫姓名');
                return;
            }

            const newReserve = {
                bookId,
                bookTitle: book.title,
                className,
                studentName,
                time: new Date().toLocaleString(),
                status: '已預約'
            };

            window.saveReserveRecord(newReserve);
            document.getElementById('reserveModal').style.display = 'none';
            alert('預約成功！請1小時內到圖書館確認，書籍保留2天');
            
            // 清空表單
            document.getElementById('className').value = '';
            document.getElementById('studentName').value = '';
        }

        // 顯示推薦表單
        window.showRecommendForm = function() {
            document.getElementById('recommendModal').style.display = 'flex';
        }

        // 提交推薦
        window.submitRecommend = function() {
            const bookName = document.getElementById('recommendBookName').value.trim();
            const reason = document.getElementById('recommendReason').value.trim();

            if (!bookName) {
                alert('請填寫書名');
                return;
            }
            if (!reason) {
                alert('請填寫推薦理由');
                return;
            }

            const newRecommend = {
                bookName,
                reason,
                time: new Date().toLocaleString(),
                status: '已推薦'
            };

            window.saveRecommendRecord(newRecommend);
            document.getElementById('recommendModal').style.display = 'none';
            alert('推薦成功，感謝你的建議！');
            
            // 清空表單
            document.getElementById('recommendBookName').value = '';
            document.getElementById('recommendReason').value = '';
        }

        // 搜索書籍（修復預約無法送出的問題）
        window.searchBooks = function() {
            const keyword = document.getElementById('keywordInput').value.toLowerCase();
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            // 隱藏海報
            document.getElementById('posterThumbContainer').style.display = 'none';

            if (!keyword) {
                showLatestIssue();
                return;
            }

            // 重新收集所有書籍，確保匹配數據最新
            collectAllBooks();
            const matched = window.libraryData.allBooks.filter(book => 
                book.title.toLowerCase().includes(keyword) ||
                book.author.toLowerCase().includes(keyword) ||
                book.callNo.toLowerCase().includes(keyword) ||
                book.intro.toLowerCase().includes(keyword)
            );

            if (matched.length === 0) {
                container.innerHTML = '<p>沒有找到匹配的書籍</p>';
            } else {
                matched.forEach((book, index) => {
                    const card = createBookCard(book);
                    card.dataset.group = Math.ceil((index + 1) / 3);
                    container.appendChild(card);
                });
            }

            showSection('posterSection');
            document.getElementById('currentIssueTitle').textContent = `搜索結果: "${keyword}"`;
        }

        // 顯示指定區域
        window.showSection = function(sectionId) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            
            // 手机版切换区域同步更新
            if (document.body.classList.contains('device-mobile') && sectionId === 'userRecommendsSection') {
                // 手机版推荐书籍区单独渲染
                const mobileContainer = document.getElementById('mobileBooksGrid');
                mobileContainer.innerHTML = '';
                mobileContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--text-primary); font-size: 1.1em; font-weight: 600;">
                        推薦購書列表
                    </div>
                `;
                const sorted = [...window.libraryData.recommendRecords].sort((a, b) => new Date(b.time) - new Date(a.time));
                if (sorted.length === 0) {
                    mobileContainer.innerHTML += '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-light);">暫無推薦記錄</div>';
                } else {
                    sorted.forEach((r, i) => {
                        const randomColor = window.getRandomSoftColor();
                        mobileContainer.innerHTML += `
                            <div class="book-card-mobile" style="flex-direction: column; align-items: flex-start; padding: 15px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <span style="width: 24px; height: 24px; background: ${randomColor}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; margin-right: 10px;">${i + 1}</span>
                                    <span style="font-weight: 600;">${r.bookName}</span>
                                </div>
                                <div style="font-size: 0.8em; color: var(--text-light); margin-bottom: 8px;">推薦理由: ${r.reason}</div>
                                <div style="font-size: 0.7em; color: var(--text-light);">狀態: ${r.status === '已推薦' ? '推薦中' : r.status === '已記錄' ? '已記錄' : '不合規定'}</div>
                            </div>
                        `;
                    });
                }
            }
        }

        // 顯示管理員登錄
        window.showAdminLogin = function() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        // 管理員登錄
        window.adminLogin = function() {
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            if (user === '123' && pass === '123') {
                window.closeAllModals();
                document.getElementById('adminPanel').classList.remove('hidden');
                renderReserveRecords();
                renderRecommendRecords();
            } else {
                alert('賬號或密碼錯誤');
            }
        }

        // 退出管理員
        window.logoutAdmin = function() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // 關閉所有彈窗
        window.closeAllModals = function() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // 设置导航项活跃状态
        window.setActiveNav = function(element) {
            // 移除所有导航项的活跃状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // 给当前点击的导航项添加活跃状态
            element.classList.add('active');
        }

        // 生成隨機柔和顏色（用於推薦書籍序號）
        window.getRandomSoftColor = function() {
            // 預定柔和色譜，避免刺眼顏色
            const colors = [
                '#0071e3', '#34c759', '#ff9500', '#5856d6', '#af52de',
                '#ff3b30', '#00c6ff', '#ff2d55', '#32ade6', '#4cd964'
            ];
            // 隨機返回一種顏色
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // 上傳海報
        window.uploadPoster = function() {
            const issue = document.getElementById('posterIssueSelect').value;
            const num = document.getElementById('posterNumSelect').value;
            const file = document.getElementById('posterUpload').files[0];
            
            if (!file) {
                alert('請選擇圖片');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                if (!window.libraryData.issues[issue]) {
                    window.libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
                }
                window.libraryData.issues[issue].posters[num] = e.target.result;
                saveData();
                renderPosterThumbs(issue);
                // 手机版同步更新海報
                if (document.body.classList.contains('device-mobile')) {
                    renderMobilePosters(issue);
                }
                alert('上傳成功');
                document.getElementById('posterUpload').value = '';
            };
            reader.readAsDataURL(file);
        }

        // 刪除單張海報
        window.deleteSinglePoster = function() {
            const issue = document.getElementById('posterIssueSelect').value;
            const num = document.getElementById('posterNumSelect').value;
            
            if (!window.libraryData.issues[issue]?.posters[num]) {
                alert('該海報不存在');
                return;
            }

            if (confirm(`確定要刪除第${issue}期第${num}張海報嗎？`)) {
                window.libraryData.issues[issue].posters[num] = '';
                saveData();
                renderPosterThumbs(issue);
                // 手机版同步删除海報
                if (document.body.classList.contains('device-mobile')) {
                    renderMobilePosters(issue);
                }
            }
        }

        // 刪除整期
        window.deleteWholeIssue = async function() {
            const issue = document.getElementById('posterIssueSelect').value;
            if (!window.libraryData.issues[issue]) {
                alert('該期不存在');
                return;
            }

            if (confirm(`確定要刪除第${issue}期所有內容嗎？`)) {
                await remove(ref(db, `issues/${issue}`));
                delete window.libraryData.issues[issue];
                const issues = Object.keys(window.libraryData.issues).map(Number).sort((a, b) => b - a);
                window.libraryData.latestIssue = issues.length > 0 ? issues[0] : 1;
                await saveData();
                renderIssueSelectors();
                showLatestIssue();
                // 手机版同步更新期数
                if (document.body.classList.contains('device-mobile')) {
                    initMobileIssueSelector();
                    renderMobilePosters(window.libraryData.latestIssue);
                    renderMobileBooks(window.libraryData.latestIssue, 1);
                }
            }
        }

        // 新增期數
        window.addNewIssue = async function() {
            const newIssue = window.libraryData.latestIssue + 1;
            window.libraryData.issues[newIssue] = {
                posters: {1: '', 2: ''},
                books: {1: {}, 2: {}}
            };
            window.libraryData.latestIssue = newIssue;
            await saveData();
            renderIssueSelectors();
            // 手机版同步新增期数
            if (document.body.classList.contains('device-mobile')) {
                initMobileIssueSelector();
            }
            alert(`已新增第${newIssue}期`);
        }

        // 保存書籍信息
        window.saveBookInfo = function() {
            const title = document.getElementById('bookTitle').value.trim();
            if (!title) {
                alert('請輸入書名');
                return;
            }

            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;

            if (!window.libraryData.issues[issue]) {
                window.libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
            }
            if (!window.libraryData.issues[issue].books[posterNum]) {
                window.libraryData.issues[issue].books[posterNum] = {};
            }

            let coverUrl = window.libraryData.issues[issue].books[posterNum][bookNum]?.cover || 'https://via.placeholder.com/80x120?text=封面';
            const coverFile = document.getElementById('bookCoverUpload').files[0];
            
            if (coverFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    coverUrl = e.target.result;
                    saveBookData(coverUrl);
                };
                reader.readAsDataURL(coverFile);
            } else {
                saveBookData(coverUrl);
            }

            function saveBookData(cover) {
                const book = {
                    id: `issue-${issue}-poster-${posterNum}-book-${bookNum}`,
                    issue: issue,
                    posterNum: posterNum,
                    bookNum: bookNum,
                    callNo: document.getElementById('bookCallNo').value,
                    title: title,
                    classCode: document.getElementById('bookClassCode').value,
                    author: document.getElementById('bookAuthor').value,
                    intro: document.getElementById('bookIntro').value,
                    suitable: document.getElementById('bookSuitable').value,
                    status: document.getElementById('bookStatus').value,
                    cover: cover
                };
                window.libraryData.issues[issue].books[posterNum][bookNum] = book;
                saveData();
                renderBooks(issue, posterNum);
                // 手机版同步更新书籍
                if (document.body.classList.contains('device-mobile')) {
                    renderMobileBooks(issue, posterNum);
                }
                alert('儲存成功');
                document.getElementById('bookCoverUpload').value = '';
            }
        }

        // 刪除書籍
        window.deleteBookInfo = function() {
            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;
            
            if (!window.libraryData.issues[issue]?.books[posterNum]?.[bookNum]) {
                alert('該書籍不存在');
                return;
            }

            if (confirm('確定要刪除此書籍嗎？')) {
                delete window.libraryData.issues[issue].books[posterNum][bookNum];
                saveData();
                renderBooks(issue, posterNum);
                // 手机版同步删除书籍
                if (document.body.classList.contains('device-mobile')) {
                    renderMobileBooks(issue, posterNum);
                }
            }
        }

        // 填充书籍编辑表单
        window.fillBookEditor = function(issue, posterNum, bookNum) {
            // 检查是否为管理员状态（未登录则提示）
            if (document.getElementById('adminPanel').classList.contains('hidden')) {
                // 普通用户点击不执行任何操作（或提示需要登录）
                return;
            }

            // 跳转到管理后台的书籍编辑区域
            document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
            
            // 选中对应的期数/海報/序号下拉框
            document.getElementById('bookIssueSelect').value = issue;
            document.getElementById('bookPosterSelect').value = posterNum;
            document.getElementById('bookNumSelect').value = bookNum;

            // 获取书籍数据并填充表单
            const book = window.libraryData.issues[issue]?.books[posterNum]?.[bookNum];
            if (book) {
                document.getElementById('bookCallNo').value = book.callNo || '';
                document.getElementById('bookTitle').value = book.title || '';
                document.getElementById('bookClassCode').value = book.classCode || '000';
                document.getElementById('bookAuthor').value = book.author || '';
                document.getElementById('bookIntro').value = book.intro || '';
                document.getElementById('bookSuitable').value = book.suitable || '';
                document.getElementById('bookStatus').value = book.status || 'in';
            }
        }

        // ---------------- 手机版专属函数 ----------------
        // 手机版渲染书籍卡片
        window.renderMobileBooks = function(issue, posterNum) {
            const container = document.getElementById('mobileBooksGrid');
            container.innerHTML = '';
            const books = window.libraryData.issues[issue]?.books[posterNum] || {};

            for (let i = 1; i <= 9; i++) {
                let book = books[i];
                if (!book) {
                    book = {
                        id: `issue-${issue}-poster-${posterNum}-book-${i}`,
                        issue: issue.toString(),
                        posterNum: posterNum.toString(),
                        bookNum: i.toString(),
                        callNo: '待編輯',
                        title: '新書' + i,
                        classCode: '000',
                        author: '待編輯',
                        intro: '待編輯',
                        suitable: '待編輯',
                        status: 'in',
                        cover: `https://via.placeholder.com/80x120?text=新書${i}`
                    };
                    if (!window.libraryData.issues[issue]) window.libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
                    if (!window.libraryData.issues[issue].books[posterNum]) window.libraryData.issues[issue].books[posterNum] = {};
                    window.libraryData.issues[issue].books[posterNum][i] = book;
                }

                // 状态样式映射
                let statusClass = 'status-in-mobile';
                let statusText = '在架（可預約）';
                if (book.status === 'out') {
                    statusClass = 'status-out-mobile';
                    statusText = '不在架';
                } else if (book.status === 'reserved') {
                    statusClass = 'status-reserved-mobile';
                    statusText = '已被預約';
                }

// 创建手机版书籍卡片
const card = document.createElement('div');
card.className = 'book-card-mobile';
card.setAttribute('onclick', `showBookDetail('${book.id}')`);
card.innerHTML = `
    <img src="${book.cover || 'https://via.placeholder.com/80x120?text=封面'}" class="book-cover-mobile" style="margin: 0 auto; display: block;">
    <div class="book-title-mobile" style="text-align: center; font-weight: 600;">${book.title || '未知書名'}</div>
    <div class="book-meta-mobile">作者: ${book.author || '待編輯'}</div>
    <div class="book-status-mobile ${statusClass}">${statusText}</div>
    ${book.status === 'in' ? `<button class="reserve-btn-mobile" onclick="
    showReserveModal('${book.id}');
    event.stopPropagation();
">預約</button>` : ''}
`;
                container.appendChild(card);
            }
            collectAllBooks();
        }
// 海報放大
window.enlargePoster = function(posterNum) {
    const overlay = document.getElementById('posterOverlay');
    const issue = window.libraryData.latestIssue;
    const posterUrl = window.libraryData.issues[issue]?.posters[posterNum];
    
    if (posterUrl) {
        overlay.innerHTML = `<img src="${posterUrl}" class="poster-large">`;
    } else {
        overlay.innerHTML = `<div style="color: white; font-size: 1.2em;">海報${posterNum}<br>[暫未上傳]</div>`;
    }
    
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden'; // 禁止背景滚动
}

// 关闭海報放大
window.closeEnlargePoster = function() {
    const overlay = document.getElementById('posterOverlay');
    overlay.classList.remove('show');
    overlay.innerHTML = '';
    document.body.style.overflow = 'auto'; // 恢复滚动
}

// 显示书籍详情
window.showBookDetail = function(bookId) {
    const book = window.libraryData.allBooks.find(b => b.id === bookId);
    if (!book) return;
    
    const content = `
        <img src="${book.cover || 'https://via.placeholder.com/150x220?text=封面'}" class="detail-cover">
        <div class="detail-title">${book.title || '未知書名'}</div>
        <div class="detail-info"><strong>作者：</strong>${book.author || '待編輯'}</div>
        <div class="detail-info"><strong>索書號：</strong>${book.callNo || '待編輯'}</div>
        <div class="detail-info"><strong>分類：</strong>${book.classCode || '000'}</div>
        <div class="detail-info"><strong>簡介：</strong>${book.intro || '無簡介'}</div>
        <div class="detail-info"><strong>適合對象：</strong>${book.suitable || '待編輯'}</div>
        <div class="detail-info"><strong>狀態：</strong>${book.status === 'in' ? '在架（可預約）' : book.status === 'out' ? '不在架' : '已被預約'}</div>
        ${book.status === 'in' ? `<button class="reserve-btn-mobile" style="width: 100%; margin-top: 20px;" onclick="
    document.getElementById('reserveModal').style.display = 'flex';
    showReserveModal('${book.id}');
    closeBookDetail();
    event.stopPropagation();
">預約這本書</button>` : ''}
    `;
    
    document.getElementById('bookDetailContent').innerHTML = content;
    document.getElementById('bookDetailOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
}

// 关闭书籍详情
window.closeBookDetail = function() {
    document.getElementById('bookDetailOverlay').classList.remove('show');
    document.body.style.overflow = 'auto';
}

        // 手机版搜索函数
        window.mobileSearch = function() {
            const keyword = document.getElementById('mobileKeywordInput').value.toLowerCase();
            if (!keyword) return;

            // 隐藏搜索面板
            document.getElementById('searchPanel').classList.remove('open');
            // 显示返回按钮
            document.getElementById('backBtn').classList.add('show');
            // 收集最新书籍数据
            collectAllBooks();

            const matched = window.libraryData.allBooks.filter(book => 
                book.title.toLowerCase().includes(keyword) ||
                book.author.toLowerCase().includes(keyword) ||
                book.callNo.toLowerCase().includes(keyword)
            );

            const container = document.getElementById('mobileBooksGrid');
            container.innerHTML = '';

            if (matched.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--text-light);">沒有找到匹配的書籍</div>';
            } else {
                matched.forEach(book => {
                    let statusClass = 'status-in-mobile';
                    let statusText = '在架（可預約）';
                    if (book.status === 'out') {
                        statusClass = 'status-out-mobile';
                        statusText = '不在架';
                    } else if (book.status === 'reserved') {
                        statusClass = 'status-reserved-mobile';
                        statusText = '已被預約';
                    }

                    const card = document.createElement('div');
                    card.className = 'book-card-mobile';
                    card.innerHTML = `
                        <img src="${book.cover || 'https://via.placeholder.com/80x120?text=封面'}" class="book-cover-mobile">
                        <div class="book-title-mobile">${book.title || '未知書名'}</div>
                        <div class="book-meta-mobile">作者: ${book.author || '待編輯'}</div>
                        <div class="book-status-mobile ${statusClass}">${statusText}</div>
                       ${book.status === 'in' ? `<button class="reserve-btn-mobile" onclick="
    showReserveModal('${book.id}');
    event.stopPropagation();
">預約</button>` : ''}
                    `;
                    container.appendChild(card);
                });
            }
        }

        // 手机版返回上一视图
        window.backToPreviousView = function() {
            document.getElementById('backBtn').classList.remove('show');
            showLatestIssue();
            document.getElementById('mobileKeywordInput').value = '';
        }

        // 滚动到顶部
        window.scrollToTop = function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 分类侧边栏控制
        window.toggleCategorySidebar = function() {
            const sidebar = document.getElementById('categorySidebar');
            sidebar.classList.toggle('open');
        }

        // 关闭分类侧边栏
        window.closeCategorySidebar = function() {
            document.getElementById('categorySidebar').classList.remove('open');
        }

        // 搜索面板控制
        window.toggleSearchPanel = function() {
            const panel = document.getElementById('searchPanel');
            panel.classList.toggle('open');
        }

        // 初始化手机版期数选择器
        window.initMobileIssueSelector = function() {
            const issues = Object.keys(window.libraryData.issues).map(Number).sort((a, b) => a - b);
            const selector = document.getElementById('mobileIssueSelect');
            selector.innerHTML = '';
            issues.forEach(issue => {
                selector.innerHTML += `<option value="${issue}">第${issue}期</option>`;
            });
            selector.value = window.libraryData.latestIssue;
        }

        // 渲染手机版海報
        window.renderMobilePosters = function(issue) {
            const poster1 = window.libraryData.issues[issue]?.posters[1];
            const poster2 = window.libraryData.issues[issue]?.posters[2];
            
            if (poster1) {
                document.getElementById('mobilePoster1').innerHTML = `<img src="${poster1}" style="width:100%; height:100%; object-fit:contain;">`;
            } else {
                document.getElementById('mobilePoster1').innerHTML = '海報1<br>[暫未上傳]';
            }
            
            if (poster2) {
                document.getElementById('mobilePoster2').innerHTML = `<img src="${poster2}" style="width:100%; height:100%; object-fit:contain;">`;
            } else {
                document.getElementById('mobilePoster2').innerHTML = '海報2<br>[暫未上傳]';
            }
        }

        // ---------------- 设备选择逻辑 ----------------
        // 设备类型选择
        window.selectDevice = function(deviceType) {
            // 保存用户选择到本地存储（下次打开自动生效）
            localStorage.setItem('deviceType', deviceType);
            // 隐藏选择弹窗
            document.getElementById('deviceSelectModal').classList.add('hidden');
            // 加载数据（继续原本的初始化流程）
            loadData();
            // 给body添加设备类型类名，用于区分样式
            document.body.classList.add(`device-${deviceType}`);
        }

        // 页面加载时检查是否有历史选择
window.checkSavedDevice = function() {
    const saved = localStorage.getItem('deviceType');
    if (saved) {
        // 仅添加设备类名，不自动隐藏弹窗（让用户手动确认）
        document.body.classList.add(`device-${saved}`);
        return true;
    }
    return false;
}

        // 初始加载逻辑：先检查设备选择
window.onload = function() {
    // 强制显示设备选择弹窗，无论是否有历史记录（确保首次打开必选）
    document.getElementById('deviceSelectModal').style.display = 'flex';
    document.getElementById('loadingIndicator').style.display = 'none';
    
    // 如果有历史选择，点击对应按钮（但仍需用户确认）
    const saved = localStorage.getItem('deviceType');
    if (saved === 'mobile') {
        document.querySelector('button[onclick="selectDevice(\'mobile\')"]').focus();
    } else if (saved === 'desktop') {
        document.querySelector('button[onclick="selectDevice(\'desktop\')"]').focus();
    }
}
    </script>
    <style>
        /* 基礎樣式 */
        :root {
            --primary: #0071e3;
            --secondary: #ff9500;
            --success: #34c759;
            --danger: #ff3b30;
            --gray-light: #f5f5f7;
            --gray: #e2e2e7;
            --gray-dark: #8e8e93;
            --text: #1d1d1f;
            --text-light: #6e6e73;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: "SF Pro Text", "PingFang TC", "Helvetica Neue", sans-serif; 
            max-width: 1440px; 
            margin: 0 auto; 
            color: var(--text);
            background-color: var(--gray-light);
            line-height: 1.6;
            padding-bottom: 50px;
        }
        .hidden { display: none !important; }
        button, input, select, textarea { 
            padding: 8px 16px; 
            margin: 5px; 
            border: 1px solid var(--gray); 
            border-radius: var(--radius); 
            font-family: inherit;
            transition: var(--transition);
        }
        button { 
            cursor: pointer; 
            border: none; 
            font-weight: 500;
        }
        button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* 按鈕樣式 */
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-text { background: transparent; color: var(--primary); }

        /* 頂部區域 */
        .header { 
            text-align: center; 
            padding: 60px 20px 40px;
            background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(245,245,247,1) 100%);
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: linear-gradient(90deg, #f0f0f0 1px, transparent 1px),
                        linear-gradient(#f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.4;
            z-index: 1;
        }
        .header h1 { 
            color: var(--text); 
            margin: 10px 0 20px; 
            font-weight: 600;
            font-size: clamp(2rem, 5vw, 3rem); /* 響應式字體 */
            letter-spacing: -0.02em; /* 緊湊字距 */
            line-height: 1.1;
            position: relative;
            z-index: 2;
            background: linear-gradient(90deg, #1d1d1f, #6e6e73);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent; /* 漸變文字 */
        }
        .issue-selector { margin: 15px 0; }

        /* 導航欄 */
        .nav-bar { 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 10px; 
            padding: 15px 20px; 
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 5;
            margin-bottom: 30px;
        }
        .nav-item { 
            padding: 10px 18px; 
            border-radius: 20px; 
            cursor: pointer; 
            white-space: nowrap;
            font-weight: 500;
            transition: var(--transition);
        }
        .nav-item:hover { 
            background: var(--gray-light);
            color: var(--primary);
        }

        /* 导航项活跃状态 */
        .nav-item.active {
            background: var(--primary);
            color: white;
        }
        .nav-item.category-dropdown.active .category-trigger {
            color: white;
        }

        .keyword-search { 
            margin-left: auto; 
            display: flex;
            align-items: center;
        }
        .keyword-search input {
            min-width: 250px;
            background: var(--gray-light);
            border: none;
        }

        /* 分類下拉菜單 */
        .category-dropdown { position: relative; }
        .category-trigger { display: flex; align-items: center; gap: 5px; }
        .category-trigger::after {
            content: "▼";
            font-size: 0.8em;
            opacity: 0.7;
        }
        .category-menu { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            background: white; 
            border-radius: var(--radius); 
            padding: 10px 0; 
            width: 200px; 
            z-index: 10; 
            display: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 8px;
        }
        .category-menu.visible { display: block; }
        .category-item { 
            padding: 10px 16px; 
            cursor: pointer; 
            transition: var(--transition);
        }
        .category-item:hover { 
            background: var(--gray-light);
            color: var(--primary);
        }

        /* 海報區 */
        .poster-section { 
            margin: 0 20px 40px; 
            padding: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        .poster-thumbnails { 
            display: flex; 
            gap: 30px; 
            margin: 30px 0; 
            justify-content: center;
            width: 100%;
        }
        .poster-thumb { 
            flex: 1;
            max-width: 500px;
            height: auto; 
            min-height: 300px;
            object-fit: contain; 
            cursor: pointer; 
            border-radius: var(--radius); 
            background: var(--gray-light); 
            padding: 20px;
            transition: var(--transition);
        }
        .poster-thumb:hover { transform: scale(1.02); }
        .poster-thumb.placeholder { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: var(--gray-dark); 
            font-size: 1.2em;
        }

        /* 書籍資料格（固定3列） */
        .books-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); /* 固定3列 */
            gap: 30px; 
            margin: 30px 0; 
            max-width: 1200px;
            margin-left: auto; 
            margin-right: auto;
        }
        .book-card { 
            padding: 20px; 
            border-radius: var(--radius); 
            transition: var(--transition); 
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .book-card[data-group="1"],
        .book-card[data-group="3"],
        .book-card[data-group="5"] { 
            border-top: 3px solid var(--primary);
        }
        .book-card[data-group="2"],
        .book-card[data-group="4"],
        .book-card[data-group="6"] { 
            border-top: 3px solid var(--secondary);
        }
        .book-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
        }
        .book-cover { 
            width: 100px; 
            height: 150px; 
            object-fit: cover; 
            margin: 0 auto 20px; 
            display: block; 
            border-radius: 6px;
        }
        .book-title { 
            text-align: center; 
            margin: 10px 0 20px; 
            font-size: 1.1em;
            min-height: 40px;
            font-weight: 600;
        }
        .book-card p { margin: 8px 0; font-size: 0.95em; }
        .book-status-bar { 
            margin: 20px 0 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .book-status { 
            font-weight: 500; 
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .status-in { color: var(--success); background: rgba(52, 199, 89, 0.1); }
        .status-out { color: var(--danger); background: rgba(255, 59, 48, 0.1); }
        .status-reserved { color: var(--secondary); background: rgba(255, 149, 0, 0.1); }
        .reserve-btn { 
            background: var(--primary); 
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
        }

        /* 推薦購書區 */
        .user-recommends { 
            margin: 0 20px 40px; 
            padding: 30px; 
            background: white; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow);
        }
        .recommend-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        .recommend-header h3 { 
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
        }
        .recommend-list { 
            display: flex; 
            flex-direction: column;
            gap: 15px; 
            margin-top: 15px;
        }
        .recommend-item { 
            padding: 15px 20px; 
            border: 1px solid var(--gray-light); 
            border-radius: var(--radius); 
            background: white;
            display: flex;
            align-items: center;
        }
        .recommend-index { 
            width: 30px; 
            height: 30px;
            text-align: center; 
            line-height: 30px;
            margin-right: 15px; 
            color: white;
            background: var(--primary);
            border-radius: 50%;
        }
        .recommend-name { flex: 1; font-weight: 500; }
        .recommend-status { 
            padding: 4px 12px;
            border-radius: 20px; 
            font-size: 0.85em; 
            margin-left: 15px; 
        }
        .status-recorded { background: rgba(52, 199, 89, 0.1); color: var(--success); }
        .status-invalid { background: rgba(255, 59, 48, 0.1); color: var(--danger); }
        .status-pending { background: rgba(255, 149, 0, 0.1); color: var(--secondary); }

        /* 彈窗樣式 */
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.3); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
            backdrop-filter: blur(2px);
        }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: var(--radius); 
            width: 90%; 
            max-width: 400px; 
            position: relative; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }
        .close-modal { 
            position: absolute; 
            top: 20px; 
            right: 25px; 
            cursor: pointer; 
            font-size: 1.5em; 
            color: var(--gray-dark);
        }
        .close-modal:hover { color: var(--danger); }
        .modal-content h3 {
            color: var(--text);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
            font-size: 1.3em;
        }

        /* 預約按鈕靠右 */
        .reserve-submit-btn {
            display: block;
            margin-left: auto;
            margin-top: 15px;
        }

        /* 管理員後台 */
        .admin-panel { 
            margin: 20px; 
            padding: 30px; 
            background: white; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow);
        }
        .admin-panel h2 {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        .form-group { 
            margin: 30px 0; 
            padding: 25px; 
            border: 1px solid var(--gray-light); 
            border-radius: var(--radius); 
            background: var(--gray-light); 
        }
        .form-group h3 { margin-bottom: 20px; }
        .book-editor { 
            margin: 15px 0; 
            padding: 20px; 
            border: 1px dashed var(--gray); 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            background: white;
            border-radius: 8px;
        }
        .record-item { 
            padding: 15px; 
            border-bottom: 1px solid var(--gray-light); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        /* 載入提示 */
        #loadingIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.5em;
            color: var(--primary);
        }

        /* 隱藏的管理員入口 */
        .hidden-admin-entry {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.5;
            z-index: 4;
        }

        /* 响应式调整（电脑端） */
        @media (max-width: 768px) {
            .books-grid { grid-template-columns: 1fr 1fr; }
            .poster-thumbnails { flex-direction: column; }
            .poster-thumb { max-width: 100%; }
            .nav-bar { flex-direction: column; align-items: stretch; }
            .keyword-search { margin-left: 0; width: 100%; }
            .keyword-search input { width: 70%; }
        }

        @media (max-width: 480px) {
            .books-grid { grid-template-columns: 1fr; }
            .header { padding: 40px 15px 20px; }
            .header h1 { font-size: 2rem; }
            .poster-section, .user-recommends { padding: 20px 15px; margin: 0 10px 20px; }
            .book-cover { width: 80px; height: 120px; }
        }

        /* ---------------- 手机版专属样式 ---------------- */
        /* 设备专属样式 - 手机端（核心样式） */
        .device-mobile {
            --primary: #0071e3;
            --dark-bg: #1d1d1f; /* 顶部深色栏背景 */
            --light-bg: #f5f5f7;
            --card-bg: white;
            --text-primary: #1d1d1f;
            --text-light: #6e6e73;
            --border-radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
/* 海報放大样式 */
.device-mobile .poster-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.device-mobile .poster-overlay.show {
    display: flex;
}
.device-mobile .poster-large {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
    border-radius: 8px;
}
/* 书籍详情弹窗样式 */
.device-mobile .book-detail-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    z-index: 9999;
    padding: 20px;
    overflow-y: auto;
    display: none;
}
.device-mobile .book-detail-overlay.show {
    display: block;
}
.device-mobile .detail-close {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 1.5em;
    z-index: 10000;
}
.device-mobile .detail-cover {
    width: 150px;
    height: 220px;
    margin: 0 auto 20px;
    display: block;
}
.device-mobile .detail-title {
    text-align: center;
    font-size: 1.3em;
    font-weight: bold;
    margin-bottom: 15px;
}
.device-mobile .detail-info {
    margin: 10px 0;
    line-height: 1.8;
}

        /* 手机版顶部固定导航栏 */
        .device-mobile .mobile-top-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 56px;
            background: var(--dark-bg);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* 顶部导航栏元素 */
        .device-mobile .nav-icon {
            font-size: 1.5em;
            cursor: pointer;
            z-index: 1000;
        }
        .device-mobile .nav-latest {
            margin-left: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }
        .device-mobile .nav-title {
            flex: 1;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            letter-spacing: -0.02em;
            cursor: pointer;
        }
        .device-mobile .nav-recommend {
            margin-right: 15px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            color: #86c7ff;
        }
        .device-mobile .nav-search {
            color: white;
        }

        /* 分类侧边栏（展开/收起） */
        .device-mobile .category-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 0;
            height: 100vh;
            background: var(--dark-bg);
            color: white;
            z-index: 998;
            overflow: hidden;
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .device-mobile .category-sidebar.open {
            width: 85%;
            max-width: 300px;
            padding: 70px 20px 20px;
        }
        .device-mobile .category-close {
            position: absolute;
            top: 20px;
            right: 15px;
            font-size: 1.5em;
            cursor: pointer;
        }
        .device-mobile .category-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .device-mobile .category-item {
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background 0.3s;
        }
        .device-mobile .category-item:hover {
            background: rgba(255,255,255,0.2);
        }

        /* 搜索展开栏 */
        .device-mobile .search-panel {
            position: fixed;
            top: 56px;
            left: 0;
            width: 100%;
            background: var(--dark-bg);
            padding: 15px;
            z-index: 997;
            display: none;
        }
        .device-mobile .search-panel.open {
            display: block;
        }
        .device-mobile .search-input-group {
            display: flex;
            gap: 10px;
        }
        .device-mobile .search-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: none;
            outline: none;
            font-size: 0.9em;
        }
        .device-mobile .search-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: 500;
        }

        /* 手机版主内容区 */
        .device-mobile .main-content {
            margin-top: 70px;
            padding: 0 15px 80px;
        }

        /* 期数选择区 */
        .device-mobile .issue-selector-mobile {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .device-mobile .issue-label {
            font-size: 0.95em;
            font-weight: 500;
        }
        .device-mobile .issue-select-mobile {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e2e2e7;
            font-size: 0.9em;
        }
        .device-mobile .latest-btn-mobile {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
        }

        /* 海報横向滑动 */
        .device-mobile .poster-slider {
            width: 100%;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 10px;
        }
        .device-mobile .poster-slide {
            flex: 0 0 100%;
            height: 220px;
            background: var(--light-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            scroll-snap-align: start;
        }
        .device-mobile .poster-slide img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .device-mobile .poster-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 1.1em;
        }

        /* 书籍卡片2列布局（2个2个排列） */
        .device-mobile .books-grid-mobile {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        .device-mobile .book-card-mobile {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }
        .device-mobile .book-card-mobile:hover {
            transform: translateY(-3px);
        }
        .device-mobile .book-cover-mobile {
            width: 80px;
            height: 120px;
            object-fit: cover;
            margin: 0 auto 12px;
            border-radius: 6px;
        }
        .device-mobile .book-title-mobile {
            text-align: center;
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 8px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .device-mobile .book-meta-mobile {
            font-size: 0.8em;
            color: var(--text-light);
            text-align: center;
            margin-bottom: 10px;
        }
        .device-mobile .book-status-mobile {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 10px;
        }
        .device-mobile .status-in-mobile {
            color: #34c759;
            background: rgba(52, 199, 89, 0.1);
        }
        .device-mobile .status-out-mobile {
            color: #ff3b30;
            background: rgba(255, 59, 48, 0.1);
        }
        .device-mobile .status-reserved-mobile {
            color: #ff9500;
            background: rgba(255, 149, 0, 0.1);
        }
        .device-mobile .reserve-btn-mobile {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 0;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
        }

        /* 推荐新书按钮 */
        .device-mobile .recommend-new-btn {
            width: 100%;
            background: linear-gradient(90deg, #0071e3, #0077ed);
            color: white;
            border: none;
            padding: 15px 0;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 15px rgba(0, 113, 227, 0.2);
            transition: transform 0.3s;
        }
        .device-mobile .recommend-new-btn:hover {
            transform: translateY(-2px);
        }

        /* 搜索返回按钮 */
        .device-mobile .back-btn {
            position: fixed;
            top: 65px;
            left: 15px;
            background: rgba(255,255,255,0.9);
            color: var(--primary);
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 990;
            display: none;
        }
        .device-mobile .back-btn.show {
            display: block;
        }

/* 修復手機版彈窗顯示問題 */
.device-mobile .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    padding: 20px;
}

.device-mobile .modal-content {
    background: white;
    padding: 25px;
    border-radius: 12px;
    width: 100%;
    max-width: 350px;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.device-mobile .close-modal {
    position: absolute;
    top: 15px;
    right: 20px;
    cursor: pointer;
    font-size: 1.3em;
    color: #8e8e93;
}

.device-mobile .close-modal:hover {
    color: #ff3b30;
}

/* 確保預約彈窗表單元素可見 */
.device-mobile .modal-content input,
.device-mobile .modal-content button {
    width: 100%;
    margin: 8px 0;
    padding: 12px;
    font-size: 1em;
}

.device-mobile .reserve-submit-btn {
    background: #0071e3;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    margin-top: 15px;
}


        /* 电脑/平板端隐藏手机版元素 */
        .device-desktop .mobile-only {
            display: none !important;
        }

        /* 手机版隐藏电脑端元素 */
        .device-mobile .desktop-only {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 设备选择弹窗 -->
    <div id="deviceSelectModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h3 style="text-align: center;">请选择您的设备</h3>
            <p style="margin: 20px 0; text-align: center;">选择后将为您展示最佳排版</p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn-primary" onclick="selectDevice('mobile')">手机端</button>
                <button class="btn-primary" onclick="selectDevice('desktop')">电脑/平板端</button>
            </div>
        </div>
    </div>

    <!-- 加载提示 -->
    <div id="loadingIndicator" style="display: none;">
        <div>正在加载图书数据...</div>
        <div style="font-size: 0.9em; margin-top: 10px;">手机加载可能需要几秒，请稍候</div>
    </div>

    <!-- 手机版专属元素（mobile-only） -->
    <div class="mobile-only">
<!-- 手机版顶部固定导航栏 -->
<div class="mobile-top-nav">
    <div class="nav-icon" id="categoryToggle">☰</div>
    <div class="nav-title" onclick="scrollToTop()">新書速遞</div>
    <div class="nav-recommend" onclick="showSection('userRecommendsSection'); setActiveNav(document.querySelectorAll('.nav-item')[2])">推薦書籍</div>
    <div class="nav-icon nav-search" id="searchToggle">🔍</div>
</div>

        <!-- 分类侧边栏 -->
        <div class="category-sidebar" id="categorySidebar">
            <div class="category-close" id="categoryClose">✕</div>
            <div class="category-list">
                <div class="category-item" data-category="all" onclick="filterByCategory('all'); closeCategorySidebar()">全部書籍</div>
                <div class="category-item" data-category="000" onclick="filterByCategory('000'); closeCategorySidebar()">000 總類</div>
                <div class="category-item" data-category="100" onclick="filterByCategory('100'); closeCategorySidebar()">100 哲學</div>
                <div class="category-item" data-category="200" onclick="filterByCategory('200'); closeCategorySidebar()">200 宗教</div>
                <div class="category-item" data-category="300" onclick="filterByCategory('300'); closeCategorySidebar()">300 科學</div>
                <div class="category-item" data-category="400" onclick="filterByCategory('400'); closeCategorySidebar()">400 應用科學</div>
                <div class="category-item" data-category="500" onclick="filterByCategory('500'); closeCategorySidebar()">500 社科</div>
                <div class="category-item" data-category="600" onclick="filterByCategory('600'); closeCategorySidebar()">600 歷史</div>
                <div class="category-item" data-category="700" onclick="filterByCategory('700'); closeCategorySidebar()">700 世界史</div>
                <div class="category-item" data-category="800" onclick="filterByCategory('800'); closeCategorySidebar()">800 語文</div>
                <div class="category-item" data-category="900" onclick="filterByCategory('900'); closeCategorySidebar()">900 藝術</div>
            </div>
        </div>

        <!-- 搜索展开栏 -->
        <div class="search-panel" id="searchPanel">
            <div class="search-input-group">
                <input type="text" class="search-input" id="mobileKeywordInput" placeholder="輸入書名/作者/索書號...">
                <button class="search-btn" onclick="mobileSearch()">查詢</button>
            </div>
        </div>

        <!-- 返回按钮 -->
        <button class="back-btn" id="backBtn" onclick="backToPreviousView()">返回上一頁</button>

        <!-- 手机版主内容区 -->
        <div class="main-content mobile-only" id="mobileMainContent">
            <!-- 期数选择区 -->
            <div class="issue-selector-mobile">
                <div class="issue-label">選擇期數:</div>
                <select id="mobileIssueSelect" class="issue-select-mobile" onchange="switchIssue(this.value)">
                    <option value="1">第1期</option>
                </select>
                <button class="latest-btn-mobile" onclick="showLatestIssue()">最新一期</button>
            </div>

            <!-- 海報横向滑动 -->
          <!-- 海報横向滑动 -->
<div class="poster-slider" id="mobilePosterSlider">
    <div class="poster-slide" data-poster="1" onclick="renderMobileBooks(window.libraryData.latestIssue, 1)">
        <div class="poster-placeholder" id="mobilePoster1" onclick="event.stopPropagation(); enlargePoster(1)">海報1<br>[暫未上傳]</div>
    </div>
    <div class="poster-slide" data-poster="2" onclick="renderMobileBooks(window.libraryData.latestIssue, 2)">
        <div class="poster-placeholder" id="mobilePoster2" onclick="event.stopPropagation(); enlargePoster(2)">海報2<br>[暫未上傳]</div>
    </div>
</div>
<!-- 海報放大弹窗容器 -->
<div class="poster-overlay mobile-only" id="posterOverlay" onclick="closeEnlargePoster()"></div>
            <!-- 手机版书籍卡片区 -->
            <div class="books-grid-mobile" id="mobileBooksGrid">
                <!-- 手机版书籍卡片动态生成 -->
            </div>

<!-- 推荐新书按钮 -->
<button class="recommend-new-btn" onclick="
    document.getElementById('recommendModal').style.display = 'flex';
">推薦新書</button>

<!-- 书籍详情弹窗 -->
<div class="book-detail-overlay mobile-only" id="bookDetailOverlay">
    <div class="detail-close" onclick="closeBookDetail()">✕</div>
    <div id="bookDetailContent"></div>
</div>
        </div>
    </div>

    <!-- 电脑版内容（desktop-only） -->
    <div class="desktop-only">
        <!-- 顶部标题区 -->
        <div class="header">
            <h1>XX中學圖書館</h1>
            <div class="issue-selector">
                <label for="issueSelect">選擇期數：</label>
                <select id="issueSelect" onchange="switchIssue(this.value)"></select>
            </div>
        </div>

        <!-- 导航栏 -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="showLatestIssue(); setActiveNav(this)">最新一期</div>
            <div class="nav-item category-dropdown" onclick="event.stopPropagation()">
                <div class="category-trigger">分類</div>
                <div class="category-menu" id="categoryMenu">
                    <div class="category-item" data-category="all">全部書籍</div>
                    <div class="category-item" data-category="000">000 總類</div>
                    <div class="category-item" data-category="100">100 哲學</div>
                    <div class="category-item" data-category="200">200 宗教</div>
                    <div class="category-item" data-category="300">300 科學</div>
                    <div class="category-item" data-category="400">400 應用科學</div>
                    <div class="category-item" data-category="500">500 社科</div>
                    <div class="category-item" data-category="600">600 歷史</div>
                    <div class="category-item" data-category="700">700 世界史</div>
                    <div class="category-item" data-category="800">800 語文</div>
                    <div class="category-item" data-category="900">900 藝術</div>
                </div>
            </div>
            <div class="nav-item" onclick="showSection('userRecommendsSection'); setActiveNav(this)">推薦購書</div>
            <div class="keyword-search">
                <input type="text" id="keywordInput" placeholder="搜索書名/作者/索書號...">
                <button class="btn-primary" onclick="searchBooks()">查詢</button>
            </div>
        </div>

        <!-- 海報區 -->
        <div class="poster-section content-section" id="posterSection">
            <h2 id="currentIssueTitle">第1期海報</h2>
            <div class="poster-thumbnails" id="posterThumbContainer"></div>
            <div class="books-grid" id="booksContainer"></div>
        </div>

        <!-- 推薦購書區 -->
        <div class="user-recommends content-section hidden" id="userRecommendsSection">
            <div class="recommend-header">
                <h3>推薦購書列表</h3>
                <button class="btn-primary" onclick="showRecommendForm()">推薦新書</button>
            </div>
            <div class="recommend-list" id="userRecommendList"></div>
        </div>

        <!-- 管理員後台 -->
        <div class="admin-panel hidden" id="adminPanel">
            <h2>管理員後台</h2>

            <!-- 海報管理 -->
            <div class="form-group">
                <h3>海報管理</h3>
                <label for="posterIssueSelect">選擇期數：</label>
                <select id="posterIssueSelect"></select>
                <label for="posterNumSelect">選擇海報：</label>
                <select id="posterNumSelect">
                    <option value="1">海報1</option>
                    <option value="2">海報2</option>
                </select>
                <input type="file" id="posterUpload" accept="image/*">
                <button class="btn-primary" onclick="uploadPoster()">上傳海報</button>
                <button class="btn-danger" onclick="deleteSinglePoster()">刪除海報</button>
                <button class="btn-secondary" onclick="addNewIssue()">新增期數</button>
                <button class="btn-danger" onclick="deleteWholeIssue()">刪除整期</button>
            </div>

            <!-- 書籍管理 -->
            <div class="form-group">
                <h3>書籍管理</h3>
                <label for="bookIssueSelect">選擇期數：</label>
                <select id="bookIssueSelect"></select>
                <label for="bookPosterSelect">選擇海報：</label>
                <select id="bookPosterSelect">
                    <option value="1">海報1</option>
                    <option value="2">海報2</option>
                </select>
                <label for="bookNumSelect">選擇書籍序號：</label>
                <select id="bookNumSelect">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
                <div class="book-editor">
                    <div>
                        <label>索書號：</label>
                        <input type="text" id="bookCallNo">
                    </div>
                    <div>
                        <label>書名：</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                    <div>
                        <label>作者：</label>
                        <input type="text" id="bookAuthor">
                    </div>
                    <div>
                        <label>分類：</label>
                        <select id="bookClassCode">
                            <option value="000">000 總類</option>
                            <option value="100">100 哲學</option>
                            <option value="200">200 宗教</option>
                            <option value="300">300 科學</option>
                            <option value="400">400 應用科學</option>
                            <option value="500">500 社科</option>
                            <option value="600">600 歷史</option>
                            <option value="700">700 世界史</option>
                            <option value="800">800 語文</option>
                            <option value="900">900 藝術</option>
                        </select>
                    </div>
                    <div>
                        <label>簡介：</label>
                        <textarea id="bookIntro" rows="3"></textarea>
                    </div>
                    <div>
                        <label>適合對象：</label>
                        <input type="text" id="bookSuitable">
                    </div>
                    <div>
                        <label>狀態：</label>
                        <select id="bookStatus">
                            <option value="in">在架（可預約）</option>
                            <option value="out">不在架</option>
                            <option value="reserved">已被預約</option>
                        </select>
                    </div>
                    <div>
                        <label>上傳封面：</label>
                        <input type="file" id="bookCoverUpload" accept="image/*">
                    </div>
                </div>
                <button class="btn-primary" onclick="saveBookInfo()">保存書籍信息</button>
                <button class="btn-danger" onclick="deleteBookInfo()">刪除書籍</button>
            </div>

            <!-- 預約記錄管理 -->
            <div class="form-group">
                <h3>預約記錄管理</h3>
                <div id="reserveRecordsContainer"></div>
            </div>

            <!-- 推薦記錄管理 -->
            <div class="form-group">
                <h3>推薦記錄管理</h3>
                <div id="recommendRecordsContainer"></div>
            </div>

            <button class="btn-text" onclick="logoutAdmin()">退出管理員</button>
        </div>

        <!-- 隱藏的管理員入口 -->
        <div class="hidden-admin-entry" onclick="showAdminLogin()">管理員入口</div>

<!-- 终极修复版预约弹窗 -->
<div id="reserveModal" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    padding: 20px;
">
    <div style="
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 100%;
        max-width: 350px;
    ">
        <span onclick="document.getElementById('reserveModal').style.display='none'" style="
            position: absolute;
            top:            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            font-size: 1.5em;
            color: #8e8e93;
        ">×</span>
        <h3>預約書籍</h3>
        <div id="bookReserveInfo" style="margin-bottom: 15px;"></div>
        <input type="text" id="className" placeholder="班級" style="width: 100%; margin: 8px 0; padding: 12px;">
        <input type="text" id="studentName" placeholder="姓名" style="width: 100%; margin: 8px 0; padding: 12px;">
        <input type="hidden" id="reserveBookId">
        <button class="reserve-submit-btn" onclick="submitReserve()" style="width: 100%; background: #0071e3; color: white; border: none; padding: 12px; border-radius: 8px; margin-top: 15px;">確認預約</button>
    </div>
</div>

<!-- 推薦書籍彈窗 -->
<div id="recommendModal" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    padding: 20px;
">
    <div style="
        background: white;
        padding: 25px;
        border-radius: 12px;
        width: 100%;
        max-width: 350px;
        position: relative;
    ">
        <span onclick="document.getElementById('recommendModal').style.display='none'" style="
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            font-size: 1.5em;
            color: #8e8e93;
        ">×</span>
        <h3>推薦新書</h3>
        <input type="text" id="recommendBookName" placeholder="書名" style="width: 100%; margin: 8px 0; padding: 12px;">
        <textarea id="recommendReason" placeholder="推薦理由" rows="4" style="width: 100%; margin: 8px 0; padding: 12px;"></textarea>
        <button onclick="submitRecommend()" style="width: 100%; background: #0071e3; color: white; border: none; padding: 12px; border-radius: 8px; margin-top: 15px;">提交推薦</button>
    </div>
</div>

<!-- 管理員登錄彈窗 -->
<div id="adminLoginModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('adminLoginModal').classList.add('hidden')">×</span>
        <h3>管理員登錄</h3>
        <input type="text" id="adminUser" placeholder="賬號">
        <input type="password" id="adminPass" placeholder="密碼">
        <button class="btn-primary" onclick="adminLogin()">登錄</button>
    </div>
</div>

    </div> <!-- 結束 desktop-only div -->

<!-- 推薦書籍彈窗 -->
<div id="recommendModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('recommendModal').style.display='none'">×</span>
        <h3>推薦新書</h3>
        <input type="text" id="recommendBookName" placeholder="書名">
        <textarea id="recommendReason" placeholder="推薦理由" rows="4"></textarea>
        <button class="reserve-submit-btn" onclick="submitRecommend()">提交推薦</button>
    </div>
</div>

<!-- 預約彈窗 -->
<div id="reserveModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('reserveModal').style.display='none'">×</span>
        <h3>預約書籍</h3>
        <div id="bookReserveInfo" style="margin-bottom: 15px;"></div>
        <input type="text" id="className" placeholder="班級">
        <input type="text" id="studentName" placeholder="姓名">
        <input type="hidden" id="reserveBookId">
        <button class="reserve-submit-btn" onclick="submitReserve()">確認預約</button>
    </div>
</div>

</body>
</html>