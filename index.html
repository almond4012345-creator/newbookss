<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XX中学图书馆 | 每周新书速递</title>
    <style>
        /* 基础样式 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "PingFang SC", "Helvetica Neue", sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }
        button, input, select, textarea { padding: 8px 12px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #4CAF50; color: white; cursor: pointer; border: none; }
        button:hover { background: #45a049; }
        .delete-btn { background: #f44336; }
        .delete-btn:hover { background: #d32f2f; }
        .primary-btn { background: #2196F3; }
        .primary-btn:hover { background: #1976D2; }

        /* 顶部区域 */
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #333; margin: 10px 0; }
        .issue-selector { margin: 15px 0; }

        /* 导航栏（检索+分类区） */
        .nav-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; }
        .nav-item { white-space: nowrap; }
        .keyword-search { margin-left: auto; }

        /* 分类下拉菜单 */
        .category-dropdown { position: relative; display: inline-block; }
        .category-trigger { cursor: pointer; }
        .category-menu { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            background: rgba(255,255,255,0.95); 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 10px; 
            width: 200px; 
            z-index: 10; 
            display: none; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .category-menu.visible { display: block; }
        .category-item { padding: 8px; cursor: pointer; border-radius: 2px; }
        .category-item:hover { background: #f0f0f0; }

        /* 海报区 */
        .poster-section { margin: 30px 0; }
        .poster-thumbnails { display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
        .poster-thumb { width: 200px; height: 280px; object-fit: contain; cursor: pointer; border: 2px solid #ddd; border-radius: 4px; background: #f9f9f9; padding: 10px; }
        .poster-thumb:hover { border-color: #2196F3; }
        .poster-thumb.placeholder { display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.9em; }
        .poster-large { max-width: 100%; margin: 20px 0; border: 1px solid #ddd; }

        /* 书籍资料格 */
        .books-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .book-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; transition: transform 0.2s; }
        .book-card:hover { transform: translateY(-3px); }
        .book-cover { width: 100px; height: 150px; object-fit: cover; margin: 0 auto 10px; display: block; }
        .book-status { margin: 10px 0; font-weight: bold; }
        .status-in { color: #4CAF50; }
        .status-out { color: #f44336; }

        /* 推荐购书区（用户可见） */
        .user-recommends { margin: 30px 0; padding: 15px; background: #f9f9f9; border-radius: 8px; }
        .user-recommends h3 { margin-bottom: 10px; }
        .recommend-list { display: flex; flex-wrap: wrap; gap: 15px; }
        .recommend-item { padding: 10px; border: 1px solid #eee; border-radius: 4px; background: white; }
        .recommend-status { font-size: 0.8em; margin-left: 10px; }
        .status-recorded { color: #4CAF50; }
        .status-invalid { color: #f44336; }

        /* 弹窗样式 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 1.5em; }
        .close-modal:hover { color: #f44336; }

        /* 编辑后台 */
        .admin-login { position: fixed; bottom: 10px; right: 10px; font-size: 0.8em; color: #666; cursor: pointer; }
        .admin-panel { margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 8px; }
        .form-group { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: white; }
        .form-group h3 { margin-bottom: 15px; color: #333; }
        .book-editor { margin: 10px 0; padding: 10px; border: 1px dashed #ccc; }
        .warning { color: #f44336; font-size: 0.9em; margin: 5px 0; }
        .record-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .record-status { min-width: 100px; }
    </style>
</head>
<body>
    <!-- 顶部区域 -->
    <div class="header">
        <h1>XX中学图书馆 | 每周新书速递</h1>
        <div class="issue-selector">
            <label>选择期数: </label>
            <select id="issueSelect" onchange="switchIssue(this.value)">
                <option value="1">第一期</option>
            </select>
        </div>
    </div>

    <!-- 导航栏（检索+分类+推荐） -->
    <div class="nav-bar">
        <div class="nav-item">
            <button class="primary-btn" onclick="showLatestIssue()">最新一期</button>
        </div>
        <div class="nav-item category-dropdown">
            <span class="category-trigger">分类 ▼</span>
            <div class="category-menu" id="categoryMenu">
                <div class="category-item" data-category="all">全部</div>
                <div class="category-item" data-category="000">000 总类</div>
                <div class="category-item" data-category="100">100 哲学</div>
                <div class="category-item" data-category="200">200 宗教</div>
                <div class="category-item" data-category="300">300 科学</div>
                <div class="category-item" data-category="400">400 应用科学</div>
                <div class="category-item" data-category="500">500 社科</div>
                <div class="category-item" data-category="600">600 历史</div>
                <div class="category-item" data-category="700">700 世界史</div>
                <div class="category-item" data-category="800">800 语文</div>
                <div class="category-item" data-category="900">900 艺术</div>
            </div>
        </div>
        <div class="nav-item">
            <button onclick="showUserRecommends()">查看大家的推荐</button>
        </div>
        <div class="nav-item keyword-search">
            <label>关键词检索: </label>
            <input type="text" id="keywordInput" placeholder="输入书名/作者/索书号...">
            <button onclick="searchBooks()">搜索</button>
        </div>
    </div>

    <!-- 推荐购书展示区（用户可见） -->
    <div class="user-recommends hidden" id="userRecommendsSection">
        <h3>大家推荐的书籍</h3>
        <div class="recommend-list" id="userRecommendList">
            <!-- 动态生成 -->
        </div>
    </div>

    <!-- 海报区 -->
    <div class="poster-section" id="posterSection">
        <h2 id="currentIssueTitle">第一期海报</h2>
        <div class="poster-thumbnails" id="posterThumbContainer">
            <div class="poster-thumb placeholder" data-poster="1">
                海报1<br>[暂未上传]
            </div>
            <div class="poster-thumb placeholder" data-poster="2">
                海报2<br>[暂未上传]
            </div>
        </div>
        <div id="posterLargeContainer">
            <img src="" class="poster-large hidden" id="posterLarge">
        </div>
        <div id="booksContainer" class="books-grid">
            <!-- 书籍卡片将动态生成 -->
        </div>
    </div>

    <!-- 预约弹窗 -->
    <div class="modal hidden" id="reserveModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>预约书籍</h3>
            <div id="bookReserveInfo"></div>
            <form id="reserveForm">
                <input type="hidden" id="reserveBookId">
                <div class="form-group">
                    <label>班级: </label>
                    <input type="text" id="className" required>
                </div>
                <div class="form-group">
                    <label>姓名: </label>
                    <input type="text" id="studentName" required>
                </div>
                <button type="submit">提交预约</button>
            </form>
        </div>
    </div>

    <!-- 推荐购书弹窗（用户） -->
    <div class="modal hidden" id="recommendModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>推荐购买书籍</h3>
            <form id="recommendForm">
                <div class="form-group">
                    <label>书名: </label>
                    <input type="text" id="recommendBookName" required>
                </div>
                <div class="form-group">
                    <label>推荐理由: </label>
                    <textarea id="recommendReason" required></textarea>
                </div>
                <button type="submit">提交推荐</button>
            </form>
        </div>
    </div>

    <!-- 管理员登录弹窗 -->
    <div class="modal hidden" id="adminLoginModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>管理员登录</h3>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label>账号: </label>
                    <input type="text" id="adminUser" required>
                </div>
                <div class="form-group">
                    <label>密码: </label>
                    <input type="password" id="adminPass" required>
                </div>
                <button type="submit">登录</button>
            </form>
        </div>
    </div>

    <!-- 管理员后台 -->
    <div class="admin-panel hidden" id="adminPanel">
        <h2>管理员后台</h2>
        <button onclick="logoutAdmin()">退出登录</button>

        <!-- 1. 期数管理 -->
        <div class="form-group">
            <h3>1. 期数管理</h3>
            <button class="primary-btn" onclick="addNewIssue()">新增期数</button>
            <div class="warning" id="issueWarning"></div>
        </div>

        <!-- 2. 海报管理 -->
        <div class="form-group">
            <h3>2. 海报管理</h3>
            <label>选择期数: </label>
            <select id="posterIssueSelect" onchange="updatePosterNumSelect()">
                <option value="1">第一期</option>
            </select>
            <label>选择序号: </label>
            <select id="posterNumSelect">
                <option value="1">海报1</option>
                <option value="2">海报2</option>
            </select>
            <input type="file" id="posterUpload" accept="image/*">
            <button onclick="uploadPoster()">重新上传海报</button>
            <button class="delete-btn" onclick="deleteSinglePoster()">删除此海报</button>
            <button class="delete-btn" onclick="deleteWholeIssue()">删除整期海报</button>
            <div class="warning" id="posterWarning"></div>
        </div>

        <!-- 3. 书籍信息编辑 -->
        <div class="form-group">
            <h3>3. 书籍信息管理</h3>
            <div>
                <label>选择期数: </label>
                <select id="bookIssueSelect" onchange="updateBookPosterSelect()">
                    <option value="1">第一期</option>
                </select>
                <label>选择海报序号: </label>
                <select id="bookPosterSelect" onchange="updateBookNumSelect()">
                    <option value="1">海报1</option>
                    <option value="2">海报2</option>
                </select>
                <label>选择书籍序号: </label>
                <select id="bookNumSelect">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>
            
            <div class="book-editor">
                <input type="text" id="bookCallNo" placeholder="索书号">
                <input type="text" id="bookTitle" placeholder="书名" onblur="checkDuplicateTitle()">
                <div class="warning" id="titleWarning"></div>
                <label>分类代码: </label>
                <select id="bookClassCode">
                    <option value="000">000 总类</option>
                    <option value="100">100 哲学</option>
                    <option value="200">200 宗教</option>
                    <option value="300">300 科学</option>
                    <option value="400">400 应用科学</option>
                    <option value="500">500 社科</option>
                    <option value="600">600 历史</option>
                    <option value="700">700 世界史</option>
                    <option value="800">800 语文</option>
                    <option value="900">900 艺术</option>
                </select>
                <input type="text" id="bookAuthor" placeholder="作者">
                <textarea id="bookIntro" placeholder="简介"></textarea>
                <input type="text" id="bookSuitable" placeholder="适合人群">
                <select id="bookCategory">
                    <option value="冒险类">冒险类</option>
                    <option value="推理类">推理类</option>
                    <option value="小说类">小说类</option>
                </select>
                <select id="bookStatus">
                    <option value="in">在架（可预约）</option>
                    <option value="out">不在架</option>
                </select>
                <input type="file" id="bookCoverUpload" accept="image/*">
                <button onclick="saveBookInfo()">保存/修改书籍</button>
                <button class="delete-btn" onclick="deleteBookInfo()">删除书籍</button>
            </div>
        </div>

        <!-- 4. 数据查看 -->
        <div class="form-group">
            <h3>4. 预约记录管理</h3>
            <div id="reserveRecordsContainer">
                <!-- 动态生成 -->
            </div>
        </div>

        <div class="form-group">
            <h3>5. 推荐购书记录管理</h3>
            <div id="recommendRecordsContainer">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 编辑者入口 -->
    <div class="admin-login" onclick="showAdminLogin()">编辑者入口</div>

    <script>
        // 全局数据存储
        const STORAGE_KEY = 'libraryNewBooks';
        let libraryData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
            issues: { 
                1: { 
                    posters: {1: '', 2: ''}, 
                    books: {1: {}, 2: {}} 
                } 
            },
            categories: ['冒险类', '推理类', '小说类'],
            reserveRecords: [],
            recommendRecords: [],
            latestIssue: 1 // 最新期数
        };

        // 初始化页面
        function init() {
            renderIssueSelectors();
            showLatestIssue();
            initCategoryDropdown();
        }

        // 初始化期数选择器（前后台同步）
        function renderIssueSelectors() {
            const issueNumbers = Object.keys(libraryData.issues).map(Number).sort((a, b) => a - b);
            const userSelector = document.getElementById('issueSelect');
            const posterSelector = document.getElementById('posterIssueSelect');
            const bookSelector = document.getElementById('bookIssueSelect');
            
            // 清空现有选项
            userSelector.innerHTML = '';
            posterSelector.innerHTML = '';
            bookSelector.innerHTML = '';
            
            // 添加所有期数选项
            issueNumbers.forEach(issue => {
                const option = `<option value="${issue}">第${issue}期</option>`;
                userSelector.innerHTML += option;
                posterSelector.innerHTML += option;
                bookSelector.innerHTML += option;
            });
            
            // 设置最新期为默认选中
            userSelector.value = libraryData.latestIssue;
            posterSelector.value = libraryData.latestIssue;
            bookSelector.value = libraryData.latestIssue;
        }

        // 切换期数（用户前台）
        function switchIssue(issue) {
            const issueNum = Number(issue);
            document.getElementById('currentIssueTitle').textContent = `第${issueNum}期海报`;
            renderPosterThumbs(issueNum);
            renderBooks(issueNum, 1); // 默认显示第一张海报的书籍
        }

        // 显示最新一期
        function showLatestIssue() {
            switchIssue(libraryData.latestIssue);
            document.getElementById('issueSelect').value = libraryData.latestIssue;
        }

        // 初始化分类下拉菜单
        function initCategoryDropdown() {
            const trigger = document.querySelector('.category-trigger');
            const menu = document.getElementById('categoryMenu');
            let isFixed = false;

            // 鼠标移过显示
            trigger.addEventListener('mouseenter', () => {
                if (!isFixed) menu.classList.add('visible');
            });

            // 鼠标离开隐藏（未固定时）
            menu.addEventListener('mouseleave', () => {
                if (!isFixed) menu.classList.remove('visible');
            });

            // 点击固定/取消固定
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                isFixed = !isFixed;
                menu.classList.toggle('visible', isFixed);
            });

            // 点击分类项筛选
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', () => {
                    const category = item.dataset.category;
                    filterByCategory(category);
                });
            });

            // 点击页面其他地方取消固定
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target) && e.target !== trigger) {
                    isFixed = false;
                    menu.classList.remove('visible');
                }
            });
        }

        // 分类筛选
        function filterByCategory(category) {
            document.querySelectorAll('.book-card').forEach(card => {
                if (category === 'all' || card.dataset.classCode === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // 显示用户推荐区
        function showUserRecommends() {
            const section = document.getElementById('userRecommendsSection');
            const list = document.getElementById('userRecommendList');
            list.innerHTML = '';

            // 只显示已处理的推荐
            const visibleRecommends = libraryData.recommendRecords.filter(r => 
                r.status === '已记录' || r.status === '不合規定'
            );

            if (visibleRecommends.length === 0) {
                list.innerHTML = '<p>暂无推荐记录</p>';
            } else {
                visibleRecommends.forEach(r => {
                    const statusClass = r.status === '已记录' ? 'status-recorded' : 'status-invalid';
                    list.innerHTML += `
                        <div class="recommend-item">
                            ${r.bookName}
                            <span class="recommend-status ${statusClass}">${r.status}</span>
                        </div>
                    `;
                });
            }

            section.classList.toggle('hidden', false);
        }

        // 海报管理相关
        function updatePosterNumSelect() {
            const issue = document.getElementById('posterIssueSelect').value;
            renderPosterThumbs(issue);
        }

        // 渲染海报缩略图
        function renderPosterThumbs(issue) {
            const container = document.getElementById('posterThumbContainer');
            container.innerHTML = '';
            
            for (let i = 1; i <= 2; i++) {
                const posterUrl = libraryData.issues[issue]?.posters[i] || '';
                if (posterUrl) {
                    container.innerHTML += `
                        <img src="${posterUrl}" class="poster-thumb" data-poster="${i}">
                    `;
                } else {
                    container.innerHTML += `
                        <div class="poster-thumb placeholder" data-poster="${i}">
                            海报${i}<br>[暂未上传]
                        </div>
                    `;
                }
            }

            // 绑定海报点击事件
            document.querySelectorAll('.poster-thumb').forEach(thumb => {
                thumb.addEventListener('click', function() {
                    const posterNum = this.dataset.poster;
                    const largeImg = document.getElementById('posterLarge');
                    largeImg.src = libraryData.issues[issue]?.posters[posterNum] || '';
                    largeImg.classList.toggle('hidden', !largeImg.src);
                    renderBooks(issue, posterNum);
                });
            });
        }

        // 上传/更新海报
        function uploadPoster() {
            const issue = document.getElementById('posterIssueSelect').value;
            const num = document.getElementById('posterNumSelect').value;
            const fileInput = document.getElementById('posterUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showWarning('posterWarning', '请选择要上传的海报图片');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showWarning('posterWarning', '请上传图片格式（PNG/JPG等）');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!libraryData.issues[issue]) {
                    libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
                }
                libraryData.issues[issue].posters[num] = e.target.result;
                saveData();
                showWarning('posterWarning', '海报上传成功', 'green');
                renderPosterThumbs(issue);
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        // 删除单张海报
        function deleteSinglePoster() {
            const issue = document.getElementById('posterIssueSelect').value;
            const num = document.getElementById('posterNumSelect').value;
            
            if (!libraryData.issues[issue] || !libraryData.issues[issue].posters[num]) {
                showWarning('posterWarning', '该海报不存在');
                return;
            }
            
            if (confirm(`确定要删除第${issue}期第${num}张海报吗？`)) {
                libraryData.issues[issue].posters[num] = ''; // 设为空，显示[暂未上传]
                saveData();
                renderPosterThumbs(issue);
                showWarning('posterWarning', '海报已删除', 'green');
            }
        }

        // 删除整期海报
        function deleteWholeIssue() {
            const issue = document.getElementById('posterIssueSelect').value;
            if (!libraryData.issues[issue]) {
                showWarning('posterWarning', '该期不存在');
                return;
            }
            
            if (confirm(`确定要删除第${issue}期所有海报和书籍吗？此操作不可恢复！`)) {
                delete libraryData.issues[issue];
                // 更新最新期数（如果删除的是最新期）
                const issues = Object.keys(libraryData.issues).map(Number).sort((a, b) => b - a);
                libraryData.latestIssue = issues.length > 0 ? issues[0] : 0;
                saveData();
                renderIssueSelectors();
                showLatestIssue();
                showWarning('posterWarning', `第${issue}期已全部删除`, 'green');
            }
        }

        // 新增期数
        function addNewIssue() {
            const newIssue = libraryData.latestIssue + 1;
            libraryData.issues[newIssue] = {
                posters: {1: '', 2: ''},
                books: {1: {}, 2: {}}
            };
            libraryData.latestIssue = newIssue;
            saveData();
            renderIssueSelectors();
            showWarning('issueWarning', `已新增第${newIssue}期`, 'green');
            // 自动切换到新期
            document.getElementById('posterIssueSelect').value = newIssue;
            renderPosterThumbs(newIssue);
        }

        // 书籍管理相关
        function updateBookPosterSelect() {
            const issue = document.getElementById('bookIssueSelect').value;
            const posterSelect = document.getElementById('bookPosterSelect');
            posterSelect.innerHTML = '';
            posterSelect.innerHTML = `
                <option value="1">海报1</option>
                <option value="2">海报2</option>
            `;
            updateBookNumSelect();
        }

        function updateBookNumSelect() {
            // 书籍序号固定1-9，无需动态更新
        }

        // 检测书名重复
        function checkDuplicateTitle() {
            const newTitle = document.getElementById('bookTitle').value.trim();
            const titleWarning = document.getElementById('titleWarning');
            
            if (!newTitle) {
                titleWarning.textContent = '';
                return false;
            }
            
            const currentIssue = document.getElementById('bookIssueSelect').value;
            const currentPoster = document.getElementById('bookPosterSelect').value;
            const currentBookNum = document.getElementById('bookNumSelect').value;
            
            for (const issue in libraryData.issues) {
                const books = libraryData.issues[issue].books;
                for (const poster in books) {
                    for (const bookNum in books[poster]) {
                        if (issue === currentIssue && poster === currentPoster && bookNum === currentBookNum) {
                            continue;
                        }
                        if (books[poster][bookNum]?.title === newTitle) {
                            titleWarning.textContent = `警告：往期已有同名书籍“${newTitle}”`;
                            return true;
                        }
                    }
                }
            }
            
            titleWarning.textContent = '';
            return false;
        }

        // 保存/修改书籍
        function saveBookInfo() {
            const title = document.getElementById('bookTitle').value.trim();
            if (!title) {
                alert('请输入书名');
                return;
            }
            
            const isDuplicate = checkDuplicateTitle();
            if (isDuplicate && !confirm(`往期已有同名书籍“${title}”，确定要继续吗？`)) {
                return;
            }
            
            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;
            
            if (!libraryData.issues[issue]) {
                libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
            }
            if (!libraryData.issues[issue].books[posterNum]) {
                libraryData.issues[issue].books[posterNum] = {};
            }
            
            let coverUrl = 'https://via.placeholder.com/100x150?text=封面';
            const coverFile = document.getElementById('bookCoverUpload').files[0];
            const coverInput = document.getElementById('bookCoverUpload');
            
            if (coverFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    coverUrl = e.target.result;
                    saveBookData();
                    coverInput.value = '';
                };
                reader.readAsDataURL(coverFile);
            } else {
                // 如果是修改现有书籍，保留原封面
                const existingBook = libraryData.issues[issue].books[posterNum][bookNum];
                if (existingBook && existingBook.cover) {
                    coverUrl = existingBook.cover;
                }
                saveBookData();
            }

            function saveBookData() {
                libraryData.issues[issue].books[posterNum][bookNum] = {
                    callNo: document.getElementById('bookCallNo').value,
                    title: title,
                    classCode: document.getElementById('bookClassCode').value, // 000-900分类（仅管理员可见）
                    author: document.getElementById('bookAuthor').value,
                    intro: document.getElementById('bookIntro').value,
                    suitable: document.getElementById('bookSuitable').value,
                    category: document.getElementById('bookCategory').value,
                    status: document.getElementById('bookStatus').value,
                    cover: coverUrl
                };
                saveData();
                alert('书籍信息已保存');
                renderBooks(issue, posterNum);
                // 刷新记录中的书籍名称（如果有）
                updateRecordsBookTitle(issue, posterNum, bookNum, title);
            }
        }

        // 删除书籍
        function deleteBookInfo() {
            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;
            const books = libraryData.issues[issue]?.books[posterNum];
            
            if (!books || !books[bookNum]) {
                alert('该书籍不存在');
                return;
            }
            
            if (confirm(`确定要删除第${issue}期第${posterNum}张海报的第${bookNum}本书吗？`)) {
                delete books[bookNum];
                saveData();
                renderBooks(issue, posterNum);
                alert('书籍已删除');
            }
        }

        // 渲染书籍列表
        function renderBooks(issue, posterNum) {
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            const books = libraryData.issues[issue]?.books[posterNum] || {};
            
            for (let i = 1; i <= 9; i++) {
                const book = books[i] || {
                    callNo: '待编辑',
                    title: '新书' + i,
                    classCode: '000',
                    author: '待编辑',
                    intro: '待编辑',
                    suitable: '待编辑',
                    category: '未分类',
                    status: 'out',
                    cover: 'https://via.placeholder.com/100x150?text=新书' + i
                };
                
                const card = document.createElement('div');
                card.className = 'book-card';
                card.dataset.category = book.category;
                card.dataset.classCode = book.classCode; // 用于分类筛选
                card.innerHTML = `
                    <img src="${book.cover}" class="book-cover">
                    <p>索书号: ${book.callNo}</p>
                    <h3>${book.title}</h3>
                    <p>作者: ${book.author}</p>
                    <p>简介: ${book.intro}</p>
                    <p>适合: ${book.suitable}</p>
                    <div class="book-status ${book.status === 'in' ? 'status-in' : 'status-out'}">
                        ${book.status === 'in' ? '✅ 在架（可预约）' : '❌ 不在架'}
                    </div>
                    ${book.status === 'in' ? 
                        `<button onclick="showReserveModal('${issue}-${posterNum}-${i}')">预约</button>` : ''}
                `;
                container.appendChild(card);
            }
        }

        // 预约记录管理
        function renderReserveRecords() {
            const container = document.getElementById('reserveRecordsContainer');
            container.innerHTML = '';
            
            if (libraryData.reserveRecords.length === 0) {
                container.innerHTML = '<p>暂无预约记录</p>';
                return;
            }
            
            libraryData.reserveRecords.forEach((r, i) => {
                const recordId = `reserve-${i}`;
                container.innerHTML += `
                    <div class="record-item">
                        <div>
                            ${r.time} | ${r.bookTitle} | ${r.className} ${r.studentName}
                        </div>
                        <select class="record-status" id="${recordId}" onchange="updateReserveStatus(${i}, this.value)">
                            <option value="已预约" ${r.status === '已预约' ? 'selected' : ''}>已预约</option>
                            <option value="处理中" ${r.status === '处理中' ? 'selected' : ''}>处理中</option>
                            <option value="借走了" ${r.status === '借走了' ? 'selected' : ''}>借走了</option>
                            <option value="找不到" ${r.status === '找不到' ? 'selected' : ''}>找不到</option>
                            <option value="已还书" ${r.status === '已还书' ? 'selected' : ''}>已还书</option>
                        </select>
                    </div>
                `;
            });
        }

        function updateReserveStatus(index, status) {
            libraryData.reserveRecords[index].status = status;
            saveData();
        }

        // 推荐购书记录管理
        function renderRecommendRecords() {
            const container = document.getElementById('recommendRecordsContainer');
            container.innerHTML = '';
            
            if (libraryData.recommendRecords.length === 0) {
                container.innerHTML = '<p>暂无推荐记录</p>';
                return;
            }
            
            libraryData.recommendRecords.forEach((r, i) => {
                const recordId = `recommend-${i}`;
                container.innerHTML += `
                    <div class="record-item">
                        <div>
                            ${r.time} | 书名: ${r.bookName} | 理由: ${r.reason}
                        </div>
                        <select class="record-status" id="${recordId}" onchange="updateRecommendStatus(${i}, this.value)">
                            <option value="已推荐" ${r.status === '已推荐' ? 'selected' : ''}>已推荐</option>
                            <option value="已记录" ${r.status === '已记录' ? 'selected' : ''}>已记录</option>
                            <option value="不合規定" ${r.status === '不合規定' ? 'selected' : ''}>不合規定</option>
                        </select>
                    </div>
                `;
            });
        }

        function updateRecommendStatus(index, status) {
            libraryData.recommendRecords[index].status = status;
            saveData();
        }

        // 辅助函数：更新记录中的书籍名称（当书籍改名时）
        function updateRecordsBookTitle(issue, posterNum, bookNum, newTitle) {
            const bookId = `${issue}-${posterNum}-${bookNum}`;
            libraryData.reserveRecords.forEach(r => {
                if (r.bookId === bookId) {
                    r.bookTitle = newTitle;
                }
            });
            saveData();
        }

        // 预约和推荐功能
        function showReserveModal(bookId) {
            const [issue, posterNum, bookNum] = bookId.split('-');
            const book = libraryData.issues[issue].books[posterNum][bookNum];
            document.getElementById('bookReserveInfo').innerText = `书名: ${book.title}`;
            document.getElementById('reserveBookId').value = bookId;
            document.getElementById('reserveModal').classList.remove('hidden');
        }

        document.getElementById('reserveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const bookId = document.getElementById('reserveBookId').value;
            const [issue, posterNum, bookNum] = bookId.split('-');
            const book = libraryData.issues[issue].books[posterNum][bookNum];
            
            libraryData.reserveRecords.push({
                bookId,
                bookTitle: book.title,
                className: document.getElementById('className').value,
                studentName: document.getElementById('studentName').value,
                time: new Date().toLocaleString(),
                status: '已预约' // 默认状态
            });
            
            saveData();
            closeAllModals();
            alert('预约成功！请1小时内到图书馆确认，书籍保留2天');
            renderReserveRecords(); // 刷新记录
        });

        function showRecommendForm() {
            document.getElementById('recommendModal').classList.remove('hidden');
        }

        document.getElementById('recommendForm').addEventListener('submit', function(e) {
            e.preventDefault();
            libraryData.recommendRecords.push({
                bookName: document.getElementById('recommendBookName').value,
                reason: document.getElementById('recommendReason').value,
                time: new Date().toLocaleString(),
                status: '已推荐' // 默认状态
            });
            
            saveData();
            closeAllModals();
            alert('推荐成功，感谢你的建议！');
            renderRecommendRecords(); // 刷新记录
        });

        // 关键词搜索
        function searchBooks() {
            const keyword = document.getElementById('keywordInput').value.toLowerCase();
            document.querySelectorAll('.book-card').forEach(card => {
                card.style.display = card.innerText.toLowerCase().includes(keyword) ? 'block' : 'none';
            });
        }

        // 管理员登录/退出
        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            if (user === '123' && pass === '123') {
                closeAllModals();
                document.getElementById('adminPanel').classList.remove('hidden');
                renderReserveRecords();
                renderRecommendRecords();
            } else {
                alert('账号或密码错误');
            }
        });

        function logoutAdmin() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // 辅助函数
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
            });
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(libraryData));
        }

        function showWarning(elementId, text, color = '#f44336') {
            const warning = document.getElementById(elementId);
            warning.textContent = text;
            warning.style.color = color;
            setTimeout(() => { warning.textContent = ''; }, 3000);
        }

        // 初始化
        window.onload = init;
    </script>
</body>
</html>