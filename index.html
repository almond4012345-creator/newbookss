<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å­¸åœ–æ›¸é¤¨ | æ¯é€±æ–°æ›¸é€Ÿé</title>
<script type="module">
    // å¼•å…¥ Firebase æ¨¡çµ„
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    // Firebase é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyAdNZnrW2xEh6AYFs5osZ0Zi-Tl5ZPbqfs",
        authDomain: "newbookf-a73de-5a312-47013.firebaseapp.com",
        projectId: "newbookf-a73de-5a312-47013",
        storageBucket: "newbookf-a73de-5a312-47013.firebasestorage.app",
        messagingSenderId: "1022548977720",
        appId: "1:1022548977720:web:b713d061247b81b98d1ecd"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);  // â† æ”¹æˆ Firestore
    const storage = getStorage(app);
// æ¸¬è©¦ Firebase é€£ç·š
console.log("ğŸ”¥ Firebase é€£ç·šæ¸¬è©¦é–‹å§‹...");
console.log("å°ˆæ¡ˆID:", firebaseConfig.projectId);
console.log("Database:", db);
console.log("Storage:", storage);



        // å…¨åŸŸè³‡æ–™ï¼ˆæ›è¼‰åˆ°windowç¢ºä¿æ‰€æœ‰åœ°æ–¹å¯è¨ªå•ï¼‰
        window.libraryData = {
            issues: {},
            reserveRecords: [],
            recommendRecords: [],
            latestIssue: 1,
            allBooks: []
        };

       // å¾ Firebase è¼‰å…¥è³‡æ–™
async function loadData() {
    try {
        document.getElementById('loadingIndicator').style.display = 'block';

        // è¼‰å…¥æœŸæ•¸è³‡æ–™ - Firestore ç‰ˆæœ¬
        const issuesCollection = collection(db, "issues");
        const issuesSnapshot = await getDocs(issuesCollection);
        window.libraryData.issues = {};
        issuesSnapshot.forEach((doc) => {
            window.libraryData.issues[doc.id] = doc.data();
        });

        // è¼‰å…¥é ç´„è¨˜éŒ„ - Firestore ç‰ˆæœ¬
        const reservesCollection = collection(db, "reserves");
        const reservesSnapshot = await getDocs(reservesCollection);
        window.libraryData.reserveRecords = [];
        reservesSnapshot.forEach((doc) => {
            window.libraryData.reserveRecords.push({ ...doc.data(), id: doc.id });
        });

        // è¼‰å…¥æ¨è–¦è¨˜éŒ„ - Firestore ç‰ˆæœ¬
        const recommendsCollection = collection(db, "recommends");
        const recommendsSnapshot = await getDocs(recommendsCollection);
        window.libraryData.recommendRecords = [];
        recommendsSnapshot.forEach((doc) => {
            window.libraryData.recommendRecords.push({ ...doc.data(), id: doc.id });
        });

        // è¼‰å…¥ç³»çµ±è¨­å®š - Firestore ç‰ˆæœ¬
        const settingsDoc = await getDoc(doc(db, "settings", "system"));
        window.libraryData.latestIssue = settingsDoc.exists() ? settingsDoc.data().latestIssue : 1;

        collectAllBooks();
        init();
        document.getElementById('loadingIndicator').style.display = 'none';
    } catch (err) {
        console.error("è¼‰å…¥å¤±æ•—:", err);
        alert("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}
        // æ”¶é›†æ‰€æœ‰æ›¸ç±ï¼ˆç¡®ä¿æµ·å ±ä¹¦ç±è¢«æ­£ç¡®æ”¶å½•ï¼‰
        function collectAllBooks() {
            window.libraryData.allBooks = [];
            // éå†æ‰€æœ‰æœŸæ•°
            for (const issue in window.libraryData.issues) {
                const issueData = window.libraryData.issues[issue];
                // éå†æ‰€æœ‰æµ·å ±
                for (const poster in issueData.books) {
                    const posterBooks = issueData.books[poster];
                    // éå†æ‰€æœ‰ä¹¦ç±
                    for (const bookNum in posterBooks) {
                        const book = { ...posterBooks[bookNum] };
                        // å¼ºåˆ¶è®¾ç½®æ ‡å‡†ID
                        book.id = `issue-${issue}-poster-${poster}-book-${bookNum}`;
                        book.issue = issue;
                        book.posterNum = poster;
                        book.bookNum = bookNum;
                        window.libraryData.allBooks.push(book);
                    }
                }
            }
        }


      // å„²å­˜è³‡æ–™åˆ° Firebase - Firestore ç‰ˆæœ¬
async function saveData() {
    try {
        console.log('æº–å‚™ä¿å­˜çš„è³‡æ–™:', window.libraryData.issues);
        
        // ä¿å­˜æœŸæ•¸è³‡æ–™
        for (const issueId in window.libraryData.issues) {
            await setDoc(doc(db, "issues", issueId), window.libraryData.issues[issueId]);
        }
        
        // ä¿å­˜ç³»çµ±è¨­å®š
        await setDoc(doc(db, "settings", "system"), { 
            latestIssue: window.libraryData.latestIssue 
        });
        
        console.log('ä¿å­˜æˆåŠŸ');
        collectAllBooks();
    } catch (err) {
        console.error("å„²å­˜å¤±æ•—:", err);
        alert("å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
    }
}

// å„²å­˜é ç´„è¨˜éŒ„ - Firestore ç‰ˆæœ¬
window.saveReserveRecord = async function(record) {
    try {
        const recordRef = doc(collection(db, "reserves"));
        await setDoc(recordRef, record);
        record.id = recordRef.id;
        window.libraryData.reserveRecords.push(record);
        
        // è§£ææ¨™æº–åŒ–ID
        const idParts = record.bookId.split('-');
        const issue = idParts[1];
        const poster = idParts[3];
        const bookNum = idParts[5];

        // æ›´æ–°æ›¸ç±ç‹€æ…‹ç‚º"å·²è¢«é ç´„"
        if (window.libraryData.issues[issue]?.books[poster]?.[bookNum]) {
            window.libraryData.issues[issue].books[poster][bookNum].status = 'reserved';
            await saveData();
            collectAllBooks();
            renderCurrentView();
        }
        renderReserveRecords();
    } catch (err) {
        console.error("é ç´„å¤±æ•—:", err);
        alert("é ç´„å¤±æ•—ï¼Œè«‹é‡è©¦");
    }
}

      
// æ›´æ–°é ç´„ç‹€æ…‹ - Firestore ç‰ˆæœ¬
window.updateReserveStatus = async function(index, status) {
    try {
        const record = window.libraryData.reserveRecords[index];
        record.status = status;
        await updateDoc(doc(db, "reserves", record.id), { status });
        
        // è§£ææ¨™æº–åŒ–ID
        const idParts = record.bookId.split('-');
        const issue = idParts[1];
        const poster = idParts[3];
        const bookNum = idParts[5];

        // æ ¹æ“šä¸åŒç‹€æ…‹æ›´æ–°æ›¸ç±ç‹€æ…‹
        if (window.libraryData.issues[issue]?.books[poster]?.[bookNum]) {
            let bookStatus;
            if (status === 'å·²é‚„æ›¸' || status === 'æ‰¾ä¸åˆ°') {
                bookStatus = 'in';
            } else if (status === 'å€Ÿèµ°äº†') {
                bookStatus = 'out';
            } else {
                bookStatus = 'reserved';
            }

            window.libraryData.issues[issue].books[poster][bookNum].status = bookStatus;
            await saveData();
            collectAllBooks();
            renderCurrentView();
        }
        renderReserveRecords();
    } catch (err) {
        console.error("æ›´æ–°å¤±æ•—:", err);
        alert("æ›´æ–°å¤±æ•—");
    }
}


// å„²å­˜æ¨è–¦è¨˜éŒ„ - Firestore ç‰ˆæœ¬
window.saveRecommendRecord = async function(record) {
    try {
        const recordRef = doc(collection(db, "recommends"));
        await setDoc(recordRef, record);
        record.id = recordRef.id;
        window.libraryData.recommendRecords.push(record);
        renderRecommendRecords();
        renderUserRecommendList();
    } catch (err) {
        alert("æ¨è–¦å¤±æ•—");
    }
}

// æ›´æ–°æ¨è–¦ç‹€æ…‹ - Firestore ç‰ˆæœ¬
window.updateRecommendStatus = async function(index, status) {
    try {
        const record = window.libraryData.recommendRecords[index];
        record.status = status;
        await updateDoc(doc(db, "recommends", record.id), { status });
        renderUserRecommendList();
    } catch (err) {
        alert("æ›´æ–°å¤±æ•—");
    }
}

        // åˆå§‹åŒ–é é¢
        function init() {
            renderIssueSelectors();
            showLatestIssue();
            initCategoryDropdown();
            renderUserRecommendList();
            // é¡¯ç¤ºæµ·å ±å®¹å™¨
            document.getElementById('posterThumbContainer').style.display = 'flex';
            document.querySelector('.nav-item').classList.add('active');
        }

        // æ¸²æŸ“æœŸæ•¸é¸æ“‡å™¨
        function renderIssueSelectors() {
            const issues = Object.keys(window.libraryData.issues).map(Number).sort((a, b) => a - b);
            const selectors = [
                document.getElementById('issueSelect'),
                document.getElementById('posterIssueSelect'),
                document.getElementById('bookIssueSelect')
            ];

            selectors.forEach(sel => {
                sel.innerHTML = '';
                issues.forEach(issue => {
                    sel.innerHTML += `<option value="${issue}">ç¬¬${issue}æœŸ</option>`;
                });
                sel.value = window.libraryData.latestIssue;
            });
        }

        // åˆ‡æ›æœŸæ•¸
        window.switchIssue = function (issue) {
            const issueNum = Number(issue);
            document.getElementById('currentIssueTitle').textContent = `ç¬¬${issueNum}æœŸæµ·å ±`;
            renderPosterThumbs(issueNum);
            renderBooks(issueNum, 1);
            // é¡¯ç¤ºæµ·å ±
            document.getElementById('posterThumbContainer').style.display = 'flex';
            showSection('posterSection');
        }

        // é¡¯ç¤ºæœ€æ–°ä¸€æœŸ
        window.showLatestIssue = function () {
            window.switchIssue(window.libraryData.latestIssue);
            document.getElementById('issueSelect').value = window.libraryData.latestIssue;
        }

        // åˆå§‹åŒ–åˆ†é¡ä¸‹æ‹‰
        function initCategoryDropdown() {
            const trigger = document.querySelector('.category-trigger');
            const menu = document.getElementById('categoryMenu');
            let isShow = false;

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                isShow = !isShow;
                menu.classList.toggle('visible', isShow);
            });

            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const category = item.dataset.category;
                    filterByCategory(category);
                    isShow = false;
                    menu.classList.remove('visible');
                });
            });

            document.addEventListener('click', () => {
                isShow = false;
                menu.classList.remove('visible');
            });
        }

        // åˆ†é¡ç¯©é¸ï¼ˆä¿®å¾©é ç´„ç„¡æ³•é€å‡ºçš„å•é¡Œï¼‰
        function filterByCategory(category) {
            const books = window.libraryData.allBooks;
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            // éš±è—æµ·å ±
            document.getElementById('posterThumbContainer').style.display = 'none';

            const filtered = category === 'all' ? books : books.filter(b => b.classCode === category);

            filtered.forEach((book, index) => {
                const card = createBookCard(book);
                card.dataset.group = Math.ceil((index + 1) / 3);
                container.appendChild(card);
            });

            showSection('posterSection');
            document.getElementById('currentIssueTitle').textContent = category === 'all' ? 'å…¨éƒ¨æ›¸ç±' : `${category} åˆ†é¡æ›¸ç±`;
            // ç¢ºä¿æ•¸æ“šåŒæ­¥
            collectAllBooks();
        }

        // æ¸²æŸ“ç”¨æˆ¶æ¨è–¦åˆ—è¡¨
        function renderUserRecommendList() {
            const list = document.getElementById('userRecommendList');
            list.innerHTML = '';
            const sorted = [...window.libraryData.recommendRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                list.innerHTML = '<p>æš«ç„¡æ¨è–¦è¨˜éŒ„</p>';
                return;
            }

            sorted.forEach((r, i) => {
                let statusText = r.status === 'å·²æ¨è–¦' ? 'æ¨è–¦ä¸­' : r.status === 'å·²è¨˜éŒ„' ? 'å·²è¨˜éŒ„' : 'ä¸åˆè¦å®š';
                let statusClass = r.status === 'å·²æ¨è–¦' ? 'status-pending' : r.status === 'å·²è¨˜éŒ„' ? 'status-recorded' : 'status-invalid';
                // ç²å–éš¨æ©Ÿé¡è‰²
                const randomColor = window.getRandomSoftColor();
                list.innerHTML += `
        <div class="recommend-item">
            <span class="recommend-index" style="background: ${randomColor}">${i + 1}</span>
            <span class="recommend-name">${r.bookName}</span>
            <span class="recommend-status ${statusClass}">${statusText}</span>
        </div>
    `;
            });
        }

        // æ¸²æŸ“æµ·å ±
        function renderPosterThumbs(issue) {
            const container = document.getElementById('posterThumbContainer');
            container.innerHTML = '';

            for (let i = 1; i <= 2; i++) {
                const url = window.libraryData.issues[issue]?.posters[i] || '';
                if (url) {
                    container.innerHTML += `<img src="${url}" class="poster-thumb" data-poster="${i}" onclick="renderBooks(${issue}, ${i})">`;
                } else {
                    container.innerHTML += `<div class="poster-thumb placeholder" data-poster="${i}" onclick="renderBooks(${issue}, ${i})">æµ·å ±${i}<br>[æš«æœªä¸Šå‚³]</div>`;
                }
            }
        }

        // åˆ›å»ºä¹¦ç±å¡ç‰‡ï¼ˆä¿®å¤é¢„çº¦æŒ‰é’®IDç»‘å®šï¼‰
        function createBookCard(book) {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.dataset.classCode = book.classCode;
            card.dataset.id = book.id; // ç»‘å®šæ ‡å‡†ID

            let statusText, statusClass, reserveBtn;
            if (book.status === 'in') {
                statusText = 'åœ¨æ¶ï¼ˆå¯é ç´„ï¼‰';
                statusClass = 'status-in';
                // ç¡®ä¿é¢„çº¦æŒ‰é’®ä½¿ç”¨æ­£ç¡®çš„ID
                reserveBtn = `<button class="reserve-btn" onclick="showReserveModal('${book.id}')">é ç´„</button>`;
            } else if (book.status === 'out') {
                statusText = 'ä¸åœ¨æ¶';
                statusClass = 'status-out';
                reserveBtn = '';
            } else {
                statusText = 'å·²è¢«é ç´„';
                statusClass = 'status-reserved';
                reserveBtn = '';
            }

            card.innerHTML = `
        <img src="${book.cover || 'https://via.placeholder.com/100x150?text=å°é¢'}" class="book-cover">
        <h3 class="book-title">${book.title}</h3>
        <p>ä½œè€…: ${book.author || 'å¾…ç·¨è¼¯'}</p>
        <p>ç°¡ä»‹: ${book.intro || 'å¾…ç·¨è¼¯'}</p>
        <p>é©åˆ: ${book.suitable || 'å¾…ç·¨è¼¯'}</p>
        <div class="book-status-bar">
            <span class="book-status ${statusClass}">${statusText}</span>
            ${reserveBtn}
        </div>
        <p class="book-callno">ç´¢æ›¸è™Ÿ: ${book.callNo || 'å¾…ç·¨è¼¯'}</p>
    `;

            return card;
        }
        
// æ¸²æŸ“æ›¸ç±åˆ—è¡¨ - ä¿®å¾©è³‡æ–™åˆå§‹åŒ–å•é¡Œ
window.renderBooks = function(issue, posterNum) {
    console.log('æ¸²æŸ“æ›¸ç± - æœŸæ•¸:', issue, 'æµ·å ±:', posterNum);
    console.log('ç•¶å‰è³‡æ–™çµæ§‹:', window.libraryData.issues[issue]?.books[posterNum]);
    
    const container = document.getElementById('booksContainer');
    container.innerHTML = '';
    
    if (!window.libraryData.issues[issue]) {
        window.libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
    }
    if (!window.libraryData.issues[issue].books[posterNum]) {
        window.libraryData.issues[issue].books[posterNum] = {};
    }
    const books = window.libraryData.issues[issue].books[posterNum];

    for (let i = 1; i <= 9; i++) {
        const bookId = `issue-${issue}-poster-${posterNum}-book-${i}`;
        
        // ä¿®å¾©ï¼šåªæœ‰å®Œå…¨ä¸å­˜åœ¨æ™‚æ‰ç”¨é è¨­å€¼
        let book = books[i] ? { ...books[i] } : {
            id: bookId,
            issue: issue.toString(),
            posterNum: posterNum.toString(),
            bookNum: i.toString(),
            callNo: 'å¾…ç·¨è¼¯',
            title: 'æ–°æ›¸' + i,
            classCode: '000',
            author: 'å¾…ç·¨è¼¯',
            intro: 'å¾…ç·¨è¼¯',
            suitable: 'å¾…ç·¨è¼¯',
            status: 'in',
            cover: `https://via.placeholder.com/100x150?text=æ–°æ›¸${i}`
        };
        
        // ç¢ºä¿IDæ­£ç¢º
        book.id = bookId;
        books[i] = book;
        window.libraryData.issues[issue].books[posterNum][i] = book;
        
        const card = createBookCard(book);
        card.dataset.group = Math.ceil(i / 3);
        container.appendChild(card);
    }
    collectAllBooks();
    saveData();
}


        // æ¸²æŸ“ç•¶å‰è¦–åœ–
        function renderCurrentView() {
            const activeSec = document.querySelector('.content-section:not(.hidden)');
            if (activeSec.id === 'posterSection') {
                const issue = document.getElementById('issueSelect').value;
                const poster = document.querySelector('.poster-thumb:hover')?.dataset.poster || '1';
                window.renderBooks(issue, poster);
            }
        }

        // æ¸²æŸ“é ç´„è¨˜éŒ„
        function renderReserveRecords() {
            const container = document.getElementById('reserveRecordsContainer');
            container.innerHTML = '';
            const sorted = [...window.libraryData.reserveRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                container.innerHTML = '<p>æš«ç„¡é ç´„è¨˜éŒ„</p>';
                return;
            }

            sorted.forEach((r, i) => {
                container.innerHTML += `
                    <div class="record-item">
                        <div>${r.time} | ${r.bookTitle} | ${r.className} ${r.studentName}</div>
                        <select onchange="updateReserveStatus(${i}, this.value)">
                            <option ${r.status === 'å·²é ç´„' ? 'selected' : ''}>å·²é ç´„</option>
                            <option ${r.status === 'è™•ç†ä¸­' ? 'selected' : ''}>è™•ç†ä¸­</option>
                            <option ${r.status === 'å€Ÿèµ°äº†' ? 'selected' : ''}>å€Ÿèµ°äº†</option>
                            <option ${r.status === 'æ‰¾ä¸åˆ°' ? 'selected' : ''}>æ‰¾ä¸åˆ°</option>
                            <option ${r.status === 'å·²é‚„æ›¸' ? 'selected' : ''}>å·²é‚„æ›¸</option>
                        </select>
                    </div>
                `;
            });
        }

        // æ¸²æŸ“æ¨è–¦è¨˜éŒ„
        function renderRecommendRecords() {
            const container = document.getElementById('recommendRecordsContainer');
            container.innerHTML = '';
            const sorted = [...window.libraryData.recommendRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                container.innerHTML = '<p>æš«ç„¡æ¨è–¦è¨˜éŒ„</p>';
                return;
            }

            sorted.forEach((r, i) => {
                container.innerHTML += `
                    <div class="record-item">
                        <div>${r.time} | æ›¸å: ${r.bookName} | ç†ç”±: ${r.reason}</div>
                        <select onchange="updateRecommendStatus(${i}, this.value)">
                            <option ${r.status === 'å·²æ¨è–¦' ? 'selected' : ''}>æ¨è–¦ä¸­</option>
                            <option ${r.status === 'å·²è¨˜éŒ„' ? 'selected' : ''}>å·²è¨˜éŒ„</option>
                            <option ${r.status === 'ä¸åˆè¦å®š' ? 'selected' : ''}>ä¸åˆè¦å®š</option>
                        </select>
                    </div>
                `;
            });
        }

        // é¡¯ç¤ºé ç´„å½ˆçª—ï¼ˆä¿®å¤æ‰¾ä¸åˆ°ä¹¦ç±çš„é—®é¢˜ï¼‰
        window.showReserveModal = function (bookId) {
            // åŒé‡æ£€æŸ¥ï¼šå…ˆä»allBooksæ‰¾ï¼Œæ‰¾ä¸åˆ°åˆ™ç›´æ¥ä»åŸæ•°æ®è§£æ
            let book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                // ç›´æ¥ä»bookIdè§£æå‡ºä¹¦çš„ä½ç½®å¹¶è¯»å–
                const [issue, poster, bookNum] = bookId.split('-');
                if (window.libraryData.issues[issue]?.books[poster]?.[bookNum]) {
                    book = window.libraryData.issues[issue].books[poster][bookNum];
                }
            }
            if (!book) {
                alert('æœªæ‰¾åˆ°é€™æœ¬æ›¸çš„è³‡è¨Šï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
                return;
            }
            document.getElementById('bookReserveInfo').innerText = `æ›¸å: ${book.title || 'æœªçŸ¥æ›¸å'}`;
            document.getElementById('reserveBookId').value = bookId;
            document.getElementById('reserveModal').classList.remove('hidden');
        }

        // æäº¤é ç´„
        window.submitReserve = function () {
            const bookId = document.getElementById('reserveBookId').value;
            const book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                alert('æ›¸ç±è³‡è¨Šä¸å­˜åœ¨');
                return;
            }

            const className = document.getElementById('className').value.trim();
            const studentName = document.getElementById('studentName').value.trim();

            if (!className) {
                alert('è«‹å¡«å¯«ç­ç´š');
                return;
            }
            if (!studentName) {
                alert('è«‹å¡«å¯«å§“å');
                return;
            }

            const newReserve = {
                bookId,
                bookTitle: book.title,
                className,
                studentName,
                time: new Date().toLocaleString(),
                status: 'å·²é ç´„'
            };

            window.saveReserveRecord(newReserve);
            window.closeAllModals();
            alert('é ç´„æˆåŠŸï¼æ›¸ç±ä¿ç•™2å¤©(ä¸å«ä»Šå¤©)ï¼Œè«‹ç›´æ¥å‰å¾€åœ–æ›¸é¤¨æ«ƒæª¯è¾¦ç†å€Ÿæ›¸');

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('className').value = '';
            document.getElementById('studentName').value = '';
        }

        // é¡¯ç¤ºæ¨è–¦è¡¨å–®
        window.showRecommendForm = function () {
            document.getElementById('recommendModal').classList.remove('hidden');
        }

        // æäº¤æ¨è–¦
        window.submitRecommend = function () {
            const bookName = document.getElementById('recommendBookName').value.trim();
            const reason = document.getElementById('recommendReason').value.trim();

            if (!bookName) {
                alert('è«‹å¡«å¯«æ›¸å');
                return;
            }
            if (!reason) {
                alert('è«‹å¡«å¯«æ¨è–¦ç†ç”±ï¼Œå¯å¡«[ç„¡]');
                return;
            }

            const newRecommend = {
                bookName,
                reason,
                time: new Date().toLocaleString(),
                status: 'å·²æ¨è–¦'
            };

            window.saveRecommendRecord(newRecommend);
            window.closeAllModals();
            alert('æ¨è–¦æˆåŠŸï¼Œæ„Ÿè¬ä½ çš„å»ºè­°ï¼');

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('recommendBookName').value = '';
            document.getElementById('recommendReason').value = '';
        }

        // æœç´¢æ›¸ç±ï¼ˆä¿®å¾©é ç´„ç„¡æ³•é€å‡ºçš„å•é¡Œï¼‰
        window.searchBooks = function () {
            const keyword = document.getElementById('keywordInput').value.toLowerCase();
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            // éš±è—æµ·å ±
            document.getElementById('posterThumbContainer').style.display = 'none';

            if (!keyword) {
                showLatestIssue();
                return;
            }

            // é‡æ–°æ”¶é›†æ‰€æœ‰æ›¸ç±ï¼Œç¢ºä¿åŒ¹é…æ•¸æ“šæœ€æ–°
            collectAllBooks();
            const matched = window.libraryData.allBooks.filter(book =>
                book.title.toLowerCase().includes(keyword) ||
                book.author.toLowerCase().includes(keyword) ||
                book.callNo.toLowerCase().includes(keyword) ||
                book.intro.toLowerCase().includes(keyword)
            );

            if (matched.length === 0) {
                container.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æ›¸ç±</p>';
            } else {
                matched.forEach((book, index) => {
                    const card = createBookCard(book);
                    card.dataset.group = Math.ceil((index + 1) / 3);
                    container.appendChild(card);
                });
            }

            showSection('posterSection');
            document.getElementById('currentIssueTitle').textContent = `æœç´¢çµæœ: "${keyword}"`;
        }

        // é¡¯ç¤ºæŒ‡å®šå€åŸŸ
        window.showSection = function (sectionId) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // é¡¯ç¤ºç®¡ç†å“¡ç™»éŒ„
        window.showAdminLogin = function () {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        // ç®¡ç†å“¡ç™»éŒ„
        window.adminLogin = function () {
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            if (user === '123' && pass === '123') {
                window.closeAllModals();
                document.getElementById('adminPanel').classList.remove('hidden');
                renderReserveRecords();
                renderRecommendRecords();
            } else {
                alert('è³¬è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
            }
        }

        // é€€å‡ºç®¡ç†å“¡
        window.logoutAdmin = function () {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // é—œé–‰æ‰€æœ‰å½ˆçª—
        window.closeAllModals = function () {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
            });
        }
        // è®¾ç½®å¯¼èˆªé¡¹æ´»è·ƒçŠ¶æ€
        window.setActiveNav = function (element) {
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // ç»™å½“å‰ç‚¹å‡»çš„å¯¼èˆªé¡¹æ·»åŠ æ´»è·ƒçŠ¶æ€
            element.classList.add('active');
        }
        // ç”Ÿæˆéš¨æ©ŸæŸ”å’Œé¡è‰²ï¼ˆç”¨æ–¼æ¨è–¦æ›¸ç±åºè™Ÿï¼‰
        window.getRandomSoftColor = function () {
            // é å®šæŸ”å’Œè‰²è­œï¼Œé¿å…åˆºçœ¼é¡è‰²
            const colors = [
                '#0071e3', '#34c759', '#ff9500', '#5856d6', '#af52de',
                '#ff3b30', '#00c6ff', '#ff2d55', '#32ade6', '#4cd964'
            ];
            // éš¨æ©Ÿè¿”å›ä¸€ç¨®é¡è‰²
            return colors[Math.floor(Math.random() * colors.length)];
        }


   // ä¸Šå‚³æµ·å ±åˆ° Firebase Storage
window.uploadPoster = async function() {
    const issue = document.getElementById('posterIssueSelect').value;
    const num = document.getElementById('posterNumSelect').value;
    const file = document.getElementById('posterUpload').files[0];
    
    if (!file) {
        alert('è«‹é¸æ“‡åœ–ç‰‡');
        return;
    }

    try {
        // ä¸Šå‚³åˆ° Firebase Storage
        const posterRef = storageRef(storage, `posters/issue-${issue}-poster-${num}`);
        await uploadBytes(posterRef, file);
        
        // ç²å–ä¸‹è¼‰ URL
        const downloadURL = await getDownloadURL(posterRef);
        
        // åªä¿å­˜ URL åˆ° Firestore
        if (!window.libraryData.issues[issue]) {
            window.libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
        }
        window.libraryData.issues[issue].posters[num] = downloadURL;
        
        await saveData();
        renderPosterThumbs(issue);
        alert('ä¸Šå‚³æˆåŠŸ');
        document.getElementById('posterUpload').value = '';
    } catch (err) {
        console.error("ä¸Šå‚³å¤±æ•—:", err);
        alert('ä¸Šå‚³å¤±æ•—');
    }
}
        // åˆªé™¤å–®å¼µæµ·å ±
        window.deleteSinglePoster = function () {
            const issue = document.getElementById('posterIssueSelect').value;
            const num = document.getElementById('posterNumSelect').value;

            if (!window.libraryData.issues[issue]?.posters[num]) {
                alert('è©²æµ·å ±ä¸å­˜åœ¨');
                return;
            }

            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬${issue}æœŸç¬¬${num}å¼µæµ·å ±å—ï¼Ÿ`)) {
                window.libraryData.issues[issue].posters[num] = '';
                saveData();
                renderPosterThumbs(issue);
            }
        }

 
// åˆªé™¤æ•´æœŸ - Firestore ç‰ˆæœ¬
window.deleteWholeIssue = async function() {
    const issue = document.getElementById('posterIssueSelect').value;
    if (!window.libraryData.issues[issue]) {
        alert('è©²æœŸä¸å­˜åœ¨');
        return;
    }

    if (confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬${issue}æœŸæ‰€æœ‰å…§å®¹å—ï¼Ÿ`)) {
        await deleteDoc(doc(db, "issues", issue));
        delete window.libraryData.issues[issue];
        const issues = Object.keys(window.libraryData.issues).map(Number).sort((a, b) => b - a);
        window.libraryData.latestIssue = issues.length > 0 ? issues[0] : 1;
        await saveData();
        renderIssueSelectors();
        showLatestIssue();
    }
}
        // æ–°å¢æœŸæ•¸
        window.addNewIssue = async function () {
            const newIssue = window.libraryData.latestIssue + 1;
            window.libraryData.issues[newIssue] = {
                posters: { 1: '', 2: '' },
                books: { 1: {}, 2: {} }
            };
            window.libraryData.latestIssue = newIssue;
            await saveData();
            renderIssueSelectors();
            alert(`å·²æ–°å¢ç¬¬${newIssue}æœŸ`);
        }

        // ä¿å­˜æ›¸ç±ä¿¡æ¯
        window.saveBookInfo = function () {
            const title = document.getElementById('bookTitle').value.trim();
            if (!title) {
                alert('è«‹è¼¸å…¥æ›¸å');
                return;
            }

            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;

            if (!window.libraryData.issues[issue]) {
                window.libraryData.issues[issue] = { posters: {}, books: { 1: {}, 2: {} } };
            }
            if (!window.libraryData.issues[issue].books[posterNum]) {
                window.libraryData.issues[issue].books[posterNum] = {};
            }

            let coverUrl = window.libraryData.issues[issue].books[posterNum][bookNum]?.cover || 'https://via.placeholder.com/100x150?text=å°é¢';
            const coverFile = document.getElementById('bookCoverUpload').files[0];

            if (coverFile) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    coverUrl = e.target.result;
                    saveBookData(coverUrl);
                };
                reader.readAsDataURL(coverFile);
            } else {
                saveBookData(coverUrl);
            }

            function saveBookData(cover) {
                window.libraryData.issues[issue].books[posterNum][bookNum] = {
                    callNo: document.getElementById('bookCallNo').value,
                    title: title,
                    classCode: document.getElementById('bookClassCode').value,
                    author: document.getElementById('bookAuthor').value,
                    intro: document.getElementById('bookIntro').value,
                    suitable: document.getElementById('bookSuitable').value,
                    status: document.getElementById('bookStatus').value,
                    cover: cover
                };
                saveData();
                renderBooks(issue, posterNum);
                alert('å„²å­˜æˆåŠŸ');
                document.getElementById('bookCoverUpload').value = '';
            }
        }

        // åˆªé™¤æ›¸ç±
        window.deleteBookInfo = function () {
            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;

            if (!window.libraryData.issues[issue]?.books[posterNum]?.[bookNum]) {
                alert('è©²æ›¸ç±ä¸å­˜åœ¨');
                return;
            }

            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ›¸ç±å—ï¼Ÿ')) {
                delete window.libraryData.issues[issue].books[posterNum][bookNum];
                saveData();
                renderBooks(issue, posterNum);
            }
        }

        // é é¢åŠ è¼‰å®Œæˆå¾Œè¼‰å…¥æ•¸æ“š
        window.onload = loadData;
    </script>
    <style>
        /* åŸºç¤æ¨£å¼ */
        :root {
            --primary: #0071e3;
            --secondary: #ff9500;
            --success: #34c759;
            --danger: #ff3b30;
            --gray-light: #f5f5f7;
            --gray: #e2e2e7;
            --gray-dark: #8e8e93;
            --text: #1d1d1f;
            --text-light: #6e6e73;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "SF Pro Text", "PingFang TC", "Helvetica Neue", sans-serif;
            max-width: 1440px;
            margin: 0 auto;
            color: var(--text);
            background-color: var(--gray-light);
            line-height: 1.6;
            padding-bottom: 50px;
        }

        .hidden {
            display: none !important;
        }

        button,
        input,
        select,
        textarea {
            padding: 8px 16px;
            margin: 5px;
            border: 1px solid var(--gray);
            border-radius: var(--radius);
            font-family: inherit;
            transition: var(--transition);
        }

        button {
            cursor: pointer;
            border: none;
            font-weight: 500;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-text {
            background: transparent;
            color: var(--primary);
        }

        /* é ‚éƒ¨å€åŸŸ */
        .header {
            text-align: center;
            padding: 60px 20px 40px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, rgba(245, 245, 247, 1) 100%);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: linear-gradient(90deg, #f0f0f0 1px, transparent 1px),
                linear-gradient(#f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.4;
            z-index: 1;
        }

        .header h1 {
            color: var(--text);
            margin: 10px 0 20px;
            font-weight: 600;
            font-size: clamp(2rem, 5vw, 3rem);
            /* éŸ¿æ‡‰å¼å­—é«” */
            letter-spacing: -0.02em;
            /* ç·Šæ¹Šå­—è· */
            line-height: 1.1;
            position: relative;
            z-index: 2;
            background: linear-gradient(90deg, #1d1d1f, #6e6e73);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            /* æ¼¸è®Šæ–‡å­— */
        }

        .issue-selector {
            margin: 15px 0;
        }

        /* å°èˆªæ¬„ */
        .nav-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 5;
            margin-bottom: 30px;
        }

        .nav-item {
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-item:hover {
            background: var(--gray-light);
            color: var(--primary);
        }

        /* å¯¼èˆªé¡¹æ´»è·ƒçŠ¶æ€ */
        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item.category-dropdown.active .category-trigger {
            color: white;
        }

        .keyword-search {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        .keyword-search input {
            min-width: 250px;
            background: var(--gray-light);
            border: none;
        }

        /* åˆ†é¡ä¸‹æ‹‰èœå–® */
        .category-dropdown {
            position: relative;
        }

        .category-trigger {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .category-trigger::after {
            content: "â–¼";
            font-size: 0.8em;
            opacity: 0.7;
        }

        .category-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: var(--radius);
            padding: 10px 0;
            width: 200px;
            z-index: 10;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 8px;
        }

        .category-menu.visible {
            display: block;
        }

        .category-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .category-item:hover {
            background: var(--gray-light);
            color: var(--primary);
        }

        /* æµ·å ±å€ */
        .poster-section {
            margin: 0 20px 40px;
            padding: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .poster-thumbnails {
            display: flex;
            gap: 30px;
            margin: 30px 0;
            justify-content: center;
            width: 100%;
        }

        .poster-thumb {
            flex: 1;
            max-width: 500px;
            height: auto;
            min-height: 300px;
            object-fit: contain;
            cursor: pointer;
            border-radius: var(--radius);
            background: var(--gray-light);
            padding: 20px;
            transition: var(--transition);
        }

        .poster-thumb:hover {
            transform: scale(1.02);
        }

        .poster-thumb.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-dark);
            font-size: 1.2em;
        }

        /* æ›¸ç±è³‡æ–™æ ¼ï¼ˆå›ºå®š3åˆ—ï¼‰ */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* å›ºå®š3åˆ— */
            gap: 30px;
            margin: 30px 0;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .book-card {
            padding: 20px;
            border-radius: var(--radius);
            transition: var(--transition);
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        }

        .book-card[data-group="1"],
        .book-card[data-group="3"],
        .book-card[data-group="5"] {
            border-top: 3px solid var(--primary);
        }

        .book-card[data-group="2"],
        .book-card[data-group="4"],
        .book-card[data-group="6"] {
            border-top: 3px solid var(--secondary);
        }

        .book-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
        }

        .book-cover {
            width: 100px;
            height: 150px;
            object-fit: cover;
            margin: 0 auto 20px;
            display: block;
            border-radius: 6px;
        }

        .book-title {
            text-align: center;
            margin: 10px 0 20px;
            font-size: 1.1em;
            min-height: 40px;
            font-weight: 600;
        }

        .book-card p {
            margin: 8px 0;
            font-size: 0.95em;
        }

        .book-status-bar {
            margin: 20px 0 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .book-status {
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .status-in {
            color: var(--success);
            background: rgba(52, 199, 89, 0.1);
        }

        .status-out {
            color: var(--danger);
            background: rgba(255, 59, 48, 0.1);
        }

        .status-reserved {
            color: var(--secondary);
            background: rgba(255, 149, 0, 0.1);
        }

        .reserve-btn {
            background: var(--primary);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
        }

        /* æ¨è–¦è³¼æ›¸å€ */
        .user-recommends {
            margin: 0 20px 40px;
            padding: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .recommend-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .recommend-header h3 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
        }

        .recommend-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .recommend-item {
            padding: 15px 20px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            background: white;
            display: flex;
            align-items: center;
        }

        .recommend-index {
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            margin-right: 15px;
            color: white;
            background: var(--primary);
            border-radius: 50%;
        }

        .recommend-name {
            flex: 1;
            font-weight: 500;
        }

        .recommend-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-left: 15px;
        }

        .status-recorded {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
        }

        .status-invalid {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
        }

        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--secondary);
        }

        /* å½ˆçª—æ¨£å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 25px;
            cursor: pointer;
            font-size: 1.5em;
            color: var(--gray-dark);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .modal-content h3 {
            color: var(--text);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
            font-size: 1.3em;
        }

        /* é ç´„æŒ‰éˆ•é å³ */
        .reserve-submit-btn {
            display: block;
            margin-left: auto;
            margin-top: 15px;
        }

        /* ç®¡ç†å“¡å¾Œå° */
        .admin-panel {
            margin: 20px;
            padding: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .admin-panel h2 {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .form-group {
            margin: 30px 0;
            padding: 25px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            background: var(--gray-light);
        }

        .form-group h3 {
            margin-bottom: 20px;
        }

        .book-editor {
            margin: 15px 0;
            padding: 20px;
            border: 1px dashed var(--gray);
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            background: white;
            border-radius: 8px;
        }

        .record-item {
            padding: 15px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* è¼‰å…¥æç¤º */
        #loadingIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.5em;
            color: var(--primary);
        }

        /* éš±è—çš„ç®¡ç†å“¡å…¥å£ */
        .hidden-admin-entry {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.5;
            z-index: 4;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            .books-grid {
                grid-template-columns: 1fr 1fr;
            }

            .poster-thumbnails {
                flex-direction: column;
            }

            .poster-thumb {
                max-width: 100%;
            }

            .nav-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .keyword-search {
                margin-left: 0;
                width: 100%;
            }

            .keyword-search input {
                width: 70%;
            }
        }

        @media (max-width: 480px) {
            .books-grid {
                grid-template-columns: 1fr;
            }

            .keyword-search input {
                width: 60%;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- è¼‰å…¥æç¤º -->
    <div id="loadingIndicator" style="display: none;">
        æ­£åœ¨è¼‰å…¥åœ–æ›¸é¤¨è³‡æ–™...
    </div>

    <!-- é ‚éƒ¨å€åŸŸ -->
    <div class="header-divider"
        style="width: 50px; height: 3px; background: var(--primary); margin: 0 auto 30px; border-radius: 3px; position: relative; z-index: 2;">
    </div>
    <div class="header">
        <h1>ä¸­å­¸åœ–æ›¸é¤¨ | æ¯é€±æ–°æ›¸é€Ÿé</h1>
        <div class="issue-selector">
            <label>é¸æ“‡æœŸæ•¸: </label>
            <select id="issueSelect" onchange="switchIssue(this.value)">
                <option value="1">ç¬¬1æœŸ</option>
            </select>
        </div>
    </div>

    <!-- å°èˆªæ¬„ -->
    <div class="nav-bar">
        <div class="nav-item" onclick="showLatestIssue(); setActiveNav(this)">æœ€æ–°ä¸€æœŸ</div>
        <div class="nav-item category-dropdown" onclick="setActiveNav(this)">
            <span class="category-trigger">åˆ†é¡</span>
            <div class="category-menu" id="categoryMenu">
                <div class="category-item" data-category="all">å…¨éƒ¨</div>
                <div class="category-item" data-category="000">000 ç¸½é¡</div>
                <div class="category-item" data-category="100">100 å“²å­¸</div>
                <div class="category-item" data-category="200">200 å®—æ•™</div>
                <div class="category-item" data-category="300">300 ç§‘å­¸</div>
                <div class="category-item" data-category="400">400 æ‡‰ç”¨ç§‘å­¸</div>
                <div class="category-item" data-category="500">500 ç¤¾ç§‘</div>
                <div class="category-item" data-category="600">600 æ­·å²</div>
                <div class="category-item" data-category="700">700 ä¸–ç•Œå²</div>
                <div class="category-item" data-category="800">800 èªæ–‡</div>
                <div class="category-item" data-category="900">900 è—è¡“</div>
            </div>
        </div>
        <div class="nav-item" onclick="showSection('userRecommendsSection'); setActiveNav(this)">æ¨è–¦è³¼æ›¸</div>
        <div class="keyword-search">
            <label>é—œéµè©: </label>
            <input type="text" id="keywordInput" placeholder="è¼¸å…¥æ›¸å/ä½œè€…/ç´¢æ›¸è™Ÿ...">
            <button onclick="searchBooks()">æœç´¢</button>
        </div>
    </div>

    <!-- æ¨è–¦è³¼æ›¸å±•ç¤ºå€ -->
    <div class="user-recommends content-section hidden" id="userRecommendsSection">
        <div class="recommend-header">
            <h3>å¤§å®¶æ¨è–¦çš„æ›¸ç±</h3>
            <button class="btn-primary" onclick="showRecommendForm()">æ¨è–¦æ–°æ›¸</button>
        </div>
        <div class="recommend-list" id="userRecommendList">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <!-- æµ·å ±å€ -->
    <div class="poster-section content-section" id="posterSection">
        <h2 id="currentIssueTitle">ç¬¬1æœŸæµ·å ±</h2>
        <div class="poster-thumbnails" id="posterThumbContainer">
            <div class="poster-thumb placeholder" data-poster="1">
                æµ·å ±1<br>[æš«æœªä¸Šå‚³]
            </div>
            <div class="poster-thumb placeholder" data-poster="2">
                æµ·å ±2<br>[æš«æœªä¸Šå‚³]
            </div>
        </div>
        <div id="booksContainer" class="books-grid">
            <!-- æ›¸ç±å¡ç‰‡å°‡å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <!-- é ç´„å½ˆçª— -->
    <div class="modal hidden" id="reserveModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>é ç´„æ›¸ç±</h3>
            <div id="bookReserveInfo"></div>
            <div class="form-group">
                <label>ç­ç´š: </label>
                <input type="text" id="className" required>
            </div>
            <div class="form-group">
                <label>å§“å: </label>
                <input type="text" id="studentName" required>
            </div>
            <button type="button" onclick="submitReserve()" class="reserve-submit-btn btn-primary">æäº¤é ç´„</button>
            <input type="hidden" id="reserveBookId">
        </div>
    </div>

    <!-- æ¨è–¦è³¼æ›¸å½ˆçª— -->
    <div class="modal hidden" id="recommendModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>æ¨è–¦è³¼è²·æ›¸ç±</h3>
            <div class="form-group">
                <label>æ›¸å: </label>
                <input type="text" id="recommendBookName" required>
            </div>
            <div class="form-group">
                <label>æ¨è–¦ç†ç”±,å¯å¡«[ç„¡]: </label>
                <textarea id="recommendReason" required></textarea>
            </div>
            <button type="button" onclick="submitRecommend()" class="btn-primary">æäº¤æ¨è–¦</button>
        </div>
    </div>

    <!-- ç®¡ç†å“¡ç™»éŒ„å½ˆçª— -->
    <div class="modal hidden" id="adminLoginModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>ç®¡ç†å“¡ç™»éŒ„</h3>
            <div class="form-group">
                <label>è³¬è™Ÿ: </label>
                <input type="text" id="adminUser" required>
            </div>
            <div class="form-group">
                <label>å¯†ç¢¼: </label>
                <input type="password" id="adminPass" required>
            </div>
            <button type="button" onclick="adminLogin()" class="btn-primary">ç™»éŒ„</button>
        </div>
    </div>

    <!-- ç®¡ç†å“¡å¾Œå° -->
    <div class="admin-panel hidden" id="adminPanel">
        <h2>ç®¡ç†å“¡å¾Œå°</h2>
        <button onclick="logoutAdmin()" class="btn-text">é€€å‡ºç™»éŒ„</button>

        <!-- 1. æœŸæ•¸ç®¡ç† -->
        <div class="form-group">
            <h3>1. æœŸæ•¸ç®¡ç†</h3>
            <button class="btn-primary" onclick="addNewIssue()">æ–°å¢æœŸæ•¸</button>
        </div>

        <!-- 2. æµ·å ±ç®¡ç† -->
        <div class="form-group">
            <h3>2. æµ·å ±ç®¡ç†</h3>
            <label>é¸æ“‡æœŸæ•¸: </label>
            <select id="posterIssueSelect" onchange="renderPosterThumbs(this.value)">
                <option value="1">ç¬¬1æœŸ</option>
            </select>
            <label>é¸æ“‡åºè™Ÿ: </label>
            <select id="posterNumSelect">
                <option value="1">æµ·å ±1</option>
                <option value="2">æµ·å ±2</option>
            </select>
            <input type="file" id="posterUpload" accept="image/*">
            <button class="btn-primary" onclick="uploadPoster()">ä¸Šå‚³æµ·å ±</button>
            <button class="btn-danger" onclick="deleteSinglePoster()">åˆªé™¤æ­¤æµ·å ±</button>
            <button class="btn-danger" onclick="deleteWholeIssue()">åˆªé™¤æ•´æœŸ</button>
        </div>

        <!-- 3. æ›¸ç±è³‡è¨Šç·¨è¼¯ -->
        <div class="form-group">
            <h3>3. æ›¸ç±è³‡è¨Šç®¡ç†</h3>
            <div>
                <label>é¸æ“‡æœŸæ•¸: </label>
                <select id="bookIssueSelect">
                    <option value="1">ç¬¬1æœŸ</option>
                </select>
                <label>é¸æ“‡æµ·å ±åºè™Ÿ: </label>
                <select id="bookPosterSelect">
                    <option value="1">æµ·å ±1</option>
                    <option value="2">æµ·å ±2</option>
                </select>
                <label>é¸æ“‡æ›¸ç±åºè™Ÿ: </label>
                <select id="bookNumSelect">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>

            <div class="book-editor">
                <input type="text" id="bookCallNo" placeholder="ç´¢æ›¸è™Ÿ">
                <input type="text" id="bookTitle" placeholder="æ›¸å">
                <label>åˆ†é¡ä»£ç¢¼: </label>
                <select id="bookClassCode">
                    <option value="000">000 ç¸½é¡</option>
                    <option value="100">100 å“²å­¸</option>
                    <option value="200">200 å®—æ•™</option>
                    <option value="300">300 ç§‘å­¸</option>
                    <option value="400">400 æ‡‰ç”¨ç§‘å­¸</option>
                    <option value="500">500 ç¤¾ç§‘</option>
                    <option value="600">600 æ­·å²</option>
                    <option value="700">700 ä¸–ç•Œå²</option>
                    <option value="800">800 èªæ–‡</option>
                    <option value="900">900 è—è¡“</option>
                </select>
                <input type="text" id="bookAuthor" placeholder="ä½œè€…">
                <textarea id="bookIntro" placeholder="ç°¡ä»‹"></textarea>
                <input type="text" id="bookSuitable" placeholder="é©åˆäººç¾¤">
                <select id="bookStatus">
                    <option value="in">åœ¨æ¶ï¼ˆå¯é ç´„ï¼‰</option>
                    <option value="out">ä¸åœ¨æ¶</option>
                </select>
                <input type="file" id="bookCoverUpload" accept="image/*">
                <button class="btn-primary" onclick="saveBookInfo()">å„²å­˜æ›¸ç±</button>
                <button class="btn-danger" onclick="deleteBookInfo()">åˆªé™¤æ›¸ç±</button>
            </div>
        </div>

        <!-- 4. é ç´„è¨˜éŒ„ç®¡ç† -->
        <div class="form-group">
            <h3>4. é ç´„è¨˜éŒ„ç®¡ç†</h3>
            <div id="reserveRecordsContainer">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 5. æ¨è–¦è³¼æ›¸è¨˜éŒ„ç®¡ç† -->
        <div class="form-group">
            <h3>5. æ¨è–¦è³¼æ›¸è¨˜éŒ„ç®¡ç†</h3>
            <div id="recommendRecordsContainer">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- éš±è—çš„ç®¡ç†å“¡å…¥å£ -->
    <div class="hidden-admin-entry" onclick="showAdminLogin()">Â®</div>
</body>

</html>