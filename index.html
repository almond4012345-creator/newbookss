<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å­¸åœ–æ›¸é¤¨ | æ¯é€±æ–°æ›¸é€Ÿé</title>
    <script type="module">
        // å¼•å…¥ Firebase æ¨¡çµ„
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";


        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAdNZnrW2xEh6AYFs5osZ0Zi-Tl5ZPbqfs",
            authDomain: "newbookf-a73de-5a312-47013.firebaseapp.com",
            projectId: "newbookf-a73de-5a312-47013",
            storageBucket: "newbookf-a73de-5a312-47013.firebasestorage.app",
            messagingSenderId: "1022548977720",
            appId: "1:1022548977720:web:b713d061247b81b98d1ecd"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);  // â† æ”¹æˆ Firestore

        // æ¸¬è©¦ Firebase é€£ç·š
        console.log("ğŸ”¥ Firebase é€£ç·šæ¸¬è©¦é–‹å§‹...");
        console.log("å°ˆæ¡ˆID:", firebaseConfig.projectId);
        console.log("Database:", db);



        // å…¨åŸŸè³‡æ–™ï¼ˆæ›è¼‰åˆ°windowç¢ºä¿æ‰€æœ‰åœ°æ–¹å¯è¨ªå•ï¼‰
        window.libraryData = {
            issues: {},
            reserveRecords: [],
            recommendRecords: [],
            latestIssue: 1,
            allBooks: []
        };
        // å…¨å±€è®Šé‡è¿½è¹¤ç•¶å‰æœŸæ•¸
        window.currentIssue = 1;

        // å¾ Firebase è¼‰å…¥è³‡æ–™

        async function loadData() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';

                // è¼‰å…¥æœŸæ•¸è³‡æ–™ - Firestore ç‰ˆæœ¬
                const issuesCollection = collection(db, "issues");
                const issuesSnapshot = await getDocs(issuesCollection);
                window.libraryData.issues = {};
                issuesSnapshot.forEach((doc) => {
                    window.libraryData.issues[doc.id] = doc.data();
                });

                // æ¸…ç†éæ™‚çš„æµ·å ±è³‡æ–™
                let needCleanup = false;
                for (const issueId in window.libraryData.issues) {
                    if (window.libraryData.issues[issueId].posters) {
                        // æª¢æŸ¥æ˜¯å¦æœ‰æµ·å ±åœ–ç‰‡è³‡æ–™ï¼ˆBase64æ ¼å¼ï¼‰
                        const poster1 = window.libraryData.issues[issueId].posters[1];
                        const poster2 = window.libraryData.issues[issueId].posters[2];

                        // å¦‚æœæœ‰ Base64 åœ–ç‰‡è³‡æ–™ï¼Œéœ€è¦æ¸…ç†
                        if (poster1 && poster1.startsWith('data:image') ||
                            poster2 && poster2.startsWith('data:image')) {
                            window.libraryData.issues[issueId].posters = { 1: '', 2: '' };
                            needCleanup = true;
                        }
                    }
                }

                // å¦‚æœæœ‰æ¸…ç†è³‡æ–™ï¼Œä¿å­˜åˆ° Firebase
                if (needCleanup) {
                    console.log('æ¸…ç†æµ·å ±åœ–ç‰‡è³‡æ–™...');
                    await saveData();
                }

                // è¼‰å…¥é ç´„è¨˜éŒ„ - Firestore ç‰ˆæœ¬
                const reservesCollection = collection(db, "reserves");
                const reservesSnapshot = await getDocs(reservesCollection);
                window.libraryData.reserveRecords = [];
                reservesSnapshot.forEach((doc) => {
                    window.libraryData.reserveRecords.push({ ...doc.data(), id: doc.id });
                });

                // è¼‰å…¥æ¨è–¦è¨˜éŒ„ - Firestore ç‰ˆæœ¬
                const recommendsCollection = collection(db, "recommends");
                const recommendsSnapshot = await getDocs(recommendsCollection);
                window.libraryData.recommendRecords = [];
                recommendsSnapshot.forEach((doc) => {
                    window.libraryData.recommendRecords.push({ ...doc.data(), id: doc.id });
                });

                // è¼‰å…¥ç³»çµ±è¨­å®š - Firestore ç‰ˆæœ¬
                const settingsDoc = await getDoc(doc(db, "settings", "system"));
                window.libraryData.latestIssue = settingsDoc.exists() ? settingsDoc.data().latestIssue : 1;
                // è¼‰å…¥æ›¸ç±é»è®šè¨˜éŒ„ - Firestore ç‰ˆæœ¬
                const likesCollection = collection(db, "bookLikes");
                const likesSnapshot = await getDocs(likesCollection);
                window.libraryData.bookLikes = {};
                likesSnapshot.forEach((doc) => {
                    window.libraryData.bookLikes[doc.id] = doc.data().count || 0;
                });

                // è¼‰å…¥æ›¸ç±ç•™è¨€è¨˜éŒ„ - Firestore ç‰ˆæœ¬
                const commentsCollection = collection(db, "bookComments");
                const commentsSnapshot = await getDocs(commentsCollection);
                window.libraryData.bookComments = {};
                commentsSnapshot.forEach((doc) => {
                    const commentData = doc.data();
                    if (!window.libraryData.bookComments[commentData.bookId]) {
                        window.libraryData.bookComments[commentData.bookId] = [];
                    }
                    window.libraryData.bookComments[commentData.bookId].push({
                        id: doc.id,
                        content: commentData.content,
                        likeCount: commentData.likeCount || 0,
                        isTop: commentData.isTop || false,
                        time: commentData.time || new Date().toLocaleString()
                    });
                });
                collectAllBooks();
                init();
                // åŠ è¼‰å…¬å‘Š
                loadAnnouncement();
                // åˆå§‹åŒ–è¼ªæ’­
                initCarousel();
                document.getElementById('loadingIndicator').style.display = 'none';

            } catch (err) {
                console.error("è¼‰å…¥å¤±æ•—:", err);

                // å¦‚æœæ˜¯è³‡æ–™å¤ªå¤§çš„éŒ¯èª¤ï¼Œæ¸…ç†ä¸¦é‡æ–°åˆå§‹åŒ–
                if (err.message.includes('exceeds the maximum allowed size')) {
                    console.log("æª¢æ¸¬åˆ°è³‡æ–™éå¤§ï¼Œé€²è¡Œæ¸…ç†...");
                    // å¼·åˆ¶åˆªé™¤æœ‰å•é¡Œçš„æ–‡ä»¶
                    try {
                        await deleteDoc(doc(db, "issues", "1"));
                    } catch (e) {
                        console.log("åˆªé™¤æ–‡ä»¶å¤±æ•—:", e);
                    }
                    window.libraryData.issues = {};
                    await saveData(); // ä¿å­˜ç©ºçš„è³‡æ–™
                    alert("è³‡æ–™åº«å·²é‡ç½®ï¼Œè«‹é‡æ–°ä¸Šå‚³è³‡æ–™");
                    location.reload(); // é‡æ–°æ•´ç†é é¢
                } else {
                    alert("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                }

                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        // æ”¶é›†æ‰€æœ‰æ›¸ç±ï¼ˆç¡®ä¿æµ·å ±ä¹¦ç±è¢«æ­£ç¡®æ”¶å½•ï¼‰
        function collectAllBooks() {
            window.libraryData.allBooks = [];
            // éå†æ‰€æœ‰æœŸæ•°
            for (const issue in window.libraryData.issues) {
                const issueData = window.libraryData.issues[issue];
                // éå†æ‰€æœ‰æµ·å ±
                for (const poster in issueData.books) {
                    const posterBooks = issueData.books[poster];
                    // éå†æ‰€æœ‰ä¹¦ç±
                    for (const bookNum in posterBooks) {
                        const book = { ...posterBooks[bookNum] };
                        // å¼ºåˆ¶è®¾ç½®æ ‡å‡†ID
                        book.id = `issue-${issue}-poster-${poster}-book-${bookNum}`;
                        book.issue = issue;
                        book.posterNum = poster;
                        book.bookNum = bookNum;
                        window.libraryData.allBooks.push(book);
                    }
                }
            }
        }


        // å„²å­˜è³‡æ–™åˆ° Firebase - Firestore ç‰ˆæœ¬
        async function saveData() {
            try {
                // æª¢æŸ¥æ¯å€‹æœŸæ•¸çš„å¤§å°
                for (const issueId in window.libraryData.issues) {
                    const issueData = window.libraryData.issues[issueId];
                    const dataSize = JSON.stringify(issueData).length;
                    console.log(`ç¬¬${issueId}æœŸè³‡æ–™å¤§å°:`, Math.round(dataSize / 1024), 'KB');

                    if (dataSize > 900 * 1024) {
                        console.warn(`è­¦å‘Šï¼šç¬¬${issueId}æœŸè³‡æ–™æ¥è¿‘å¤§å°é™åˆ¶`);
                    }

                    await setDoc(doc(db, "issues", issueId), issueData);
                }

                // ä¿å­˜ç³»çµ±è¨­å®š
                await setDoc(doc(db, "settings", "system"), {
                    latestIssue: window.libraryData.latestIssue
                });

                // ä¿å­˜æ›¸ç±é»è®šæ•¸æ“š
                for (const bookId in window.libraryData.bookLikes) {
                    await setDoc(doc(db, "bookLikes", bookId), {
                        count: window.libraryData.bookLikes[bookId] || 0
                    });
                }

                // ä¿å­˜æ›¸ç±ç•™è¨€æ•¸æ“š
                const allComments = [];
                for (const bookId in window.libraryData.bookComments) {
                    window.libraryData.bookComments[bookId].forEach(comment => {
                        allComments.push({
                            ...comment,
                            bookId: bookId
                        });
                    });
                }
                // å…ˆæ¸…ç©ºèˆŠç•™è¨€ï¼Œå†é‡æ–°ä¿å­˜ï¼ˆç°¡åŒ–ç‰ˆï¼‰
                const commentsCol = collection(db, "bookComments");
                const oldCommentsSnapshot = await getDocs(commentsCol);
                oldCommentsSnapshot.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });
                // ä¿å­˜æ–°ç•™è¨€
                for (const comment of allComments) {
                    if (comment.id) {
                        await setDoc(doc(db, "bookComments", comment.id), comment);
                    } else {
                        const newRef = doc(collection(db, "bookComments"));
                        await setDoc(newRef, { ...comment, id: newRef.id });
                    }
                }
                console.log('ä¿å­˜æˆåŠŸ');
                collectAllBooks();
            } catch (err) {
                console.error("å„²å­˜å¤±æ•—:", err);
                alert("å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
            }
        }


        // å„²å­˜é ç´„è¨˜éŒ„ - Firestore ç‰ˆæœ¬
        window.saveReserveRecord = async function (record) {
            try {
                const recordRef = doc(collection(db, "reserves"));
                await setDoc(recordRef, record);
                record.id = recordRef.id;
                window.libraryData.reserveRecords.push(record);

                // è§£ææ¨™æº–åŒ–ID
                const idParts = record.bookId.split('-');
                const issue = idParts[1];
                const poster = idParts[3];
                const bookNum = idParts[5];

                // æ›´æ–°æ›¸ç±ç‹€æ…‹ç‚º"å·²è¢«é ç´„"
                if (window.libraryData.issues[issue]?.books[poster]?.[bookNum]) {
                    window.libraryData.issues[issue].books[poster][bookNum].status = 'reserved';
                    await saveData();
                    collectAllBooks();
                    renderCurrentView();
                }
                renderReserveRecords();
            } catch (err) {
                console.error("é ç´„å¤±æ•—:", err);
                alert("é ç´„å¤±æ•—ï¼Œè«‹é‡è©¦");
            }
        }


        // æ›´æ–°é ç´„ç‹€æ…‹ - Firestore ç‰ˆæœ¬
        window.updateReserveStatus = async function (index, status) {
            try {
                const record = window.libraryData.reserveRecords[index];
                record.status = status;
                await updateDoc(doc(db, "reserves", record.id), { status });

                // è§£ææ¨™æº–åŒ–ID
                const idParts = record.bookId.split('-');
                const issue = idParts[1];
                const poster = idParts[3];
                const bookNum = idParts[5];

                // æ ¹æ“šä¸åŒç‹€æ…‹æ›´æ–°æ›¸ç±ç‹€æ…‹
                if (window.libraryData.issues[issue]?.books[poster]?.[bookNum]) {
                    let bookStatus;
                    if (status === 'å·²é‚„æ›¸' || status === 'æ‰¾ä¸åˆ°') {
                        bookStatus = 'in';
                    } else if (status === 'å€Ÿèµ°äº†') {
                        bookStatus = 'out';
                    } else {
                        bookStatus = 'reserved';
                    }

                    window.libraryData.issues[issue].books[poster][bookNum].status = bookStatus;
                    await saveData();
                    collectAllBooks();
                    renderCurrentView();
                }
                renderReserveRecords();
            } catch (err) {
                console.error("æ›´æ–°å¤±æ•—:", err);
                alert("æ›´æ–°å¤±æ•—");
            }
        }


        // å„²å­˜æ¨è–¦è¨˜éŒ„ - Firestore ç‰ˆæœ¬
        window.saveRecommendRecord = async function (record) {
            try {
                const recordRef = doc(collection(db, "recommends"));
                await setDoc(recordRef, record);
                record.id = recordRef.id;
                window.libraryData.recommendRecords.push(record);
                renderRecommendRecords();
                renderUserRecommendList();
            } catch (err) {
                alert("æ¨è–¦å¤±æ•—");
            }
        }

        // æ›´æ–°æ¨è–¦ç‹€æ…‹ - Firestore ç‰ˆæœ¬
        window.updateRecommendStatus = async function (index, status) {
            try {
                const record = window.libraryData.recommendRecords[index];
                record.status = status;
                await updateDoc(doc(db, "recommends", record.id), { status });
                renderUserRecommendList();
            } catch (err) {
                alert("æ›´æ–°å¤±æ•—");
            }
        }



        // æ–°å¢è‡ªå‹•åŠ è¼‰æ›¸ç±è³‡æ–™å‡½æ•¸
        window.loadBookData = function () {
            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;

            // æª¢æŸ¥è©²æ›¸ç±æ˜¯å¦å­˜åœ¨
            const book = window.libraryData.issues[issue]?.books[posterNum]?.[bookNum];

            if (book) {
                // è‡ªå‹•å¡«å……è¡¨å–®ï¼Œå¦‚æœæ˜¯"å¾…ç·¨è¼¯"å°±æ¸…ç©º
                document.getElementById('bookCallNo').value = book.callNo !== 'å¾…ç·¨è¼¯' ? book.callNo : '';
                document.getElementById('bookTitle').value = book.title !== 'æ–°æ›¸' + bookNum && book.title !== 'å¾…ç·¨è¼¯' ? book.title : '';
                document.getElementById('bookClassCode').value = book.classCode || '000';
                document.getElementById('bookAuthor').value = book.author !== 'å¾…ç·¨è¼¯' ? book.author : '';
                document.getElementById('bookIntro').value = book.intro !== 'å¾…ç·¨è¼¯' ? book.intro : '';
                document.getElementById('bookSuitable').value = book.suitable !== 'å¾…ç·¨è¼¯' ? book.suitable : '';
                document.getElementById('bookStatus').value = book.status || 'in';
            } else {
                // å¦‚æœæ›¸ç±ä¸å­˜åœ¨ï¼Œæ¸…ç©ºæ‰€æœ‰æ¬„ä½
                clearBookForm();
            }
        }

        // æ¸…ç©ºè¡¨å–®å‡½æ•¸
        function clearBookForm() {
            document.getElementById('bookCallNo').value = '';
            document.getElementById('bookTitle').value = '';
            document.getElementById('bookClassCode').value = '000';
            document.getElementById('bookAuthor').value = '';
            document.getElementById('bookIntro').value = '';
            document.getElementById('bookSuitable').value = '';
            document.getElementById('bookStatus').value = 'in';
        }

        // åˆå§‹åŒ–é é¢
        function init() {
            renderIssueSelectors();
            showLatestIssue();
            initCategoryDropdown();
            renderUserRecommendList();
            // é¡¯ç¤ºæµ·å ±æŒ‰éˆ•å®¹å™¨
            document.getElementById('posterButtonsContainer').style.display = 'flex';
            document.querySelector('.nav-item').classList.add('active');

            // æ–°å¢ï¼šç‚ºæ›¸ç±é¸æ“‡ä¸‹æ‹‰èœå–®æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.getElementById('bookIssueSelect').addEventListener('change', loadBookData);
            document.getElementById('bookPosterSelect').addEventListener('change', loadBookData);
            document.getElementById('bookNumSelect').addEventListener('change', loadBookData);
        }

        // æ¸²æŸ“æœŸæ•¸é¸æ“‡å™¨
        function renderIssueSelectors() {
            const issues = Object.keys(window.libraryData.issues).map(Number).sort((a, b) => a - b);
            const selectors = [
                document.getElementById('issueSelect'),
                document.getElementById('posterIssueSelect'),
                document.getElementById('bookIssueSelect'),  // â† é€™è£¡åŠ ä¸Šé€—è™Ÿ
                document.getElementById('deleteIssueSelect') // æ–°å¢é€™å€‹
            ];
            selectors.forEach(sel => {
                if (sel) { // æ·»åŠ  null æª¢æŸ¥
                    sel.innerHTML = '';
                    issues.forEach(issue => {
                        sel.innerHTML += `<option value="${issue}">ç¬¬${issue}æœŸ</option>`;
                    });
                    // åªæœ‰å‰ä¸‰å€‹é¸æ“‡å™¨è¨­ç½®æœ€æ–°æœŸæ•¸ï¼Œåˆªé™¤é¸æ“‡å™¨ä¸è¨­ç½®
                    if (sel.id !== 'deleteIssueSelect') {
                        sel.value = window.libraryData.latestIssue;
                    }
                }
            });
        }

        // åˆ‡æ›æœŸæ•¸
        window.switchIssue = function (issue) {
            const issueNum = Number(issue);
            window.currentIssue = issueNum; // æ›´æ–°å…¨å±€è®Šé‡
            document.getElementById('currentIssueTitle').textContent = `ç¬¬${issueNum}æœŸæµ·å ±`;
            // é‡ç½®æµ·å ±æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.poster-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // é»˜èªæ¿€æ´»ç¬¬ä¸€å€‹æŒ‰éˆ•
            document.querySelector('.poster-btn[data-poster="1"]').classList.add('active');
            renderBooks(issueNum, 1);
            // é¡¯ç¤ºæµ·å ±æŒ‰éˆ•å®¹å™¨
            document.getElementById('posterButtonsContainer').style.display = 'flex';
            showSection('posterSection');
        }

        // é¡¯ç¤ºæœ€æ–°ä¸€æœŸ
        window.showLatestIssue = function () {
            window.switchIssue(window.libraryData.latestIssue);
            document.getElementById('issueSelect').value = window.libraryData.latestIssue;
        }

        // åˆå§‹åŒ–åˆ†é¡ä¸‹æ‹‰
        function initCategoryDropdown() {
            const trigger = document.querySelector('.category-trigger');
            const menu = document.getElementById('categoryMenu');
            let isShow = false;

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                isShow = !isShow;
                menu.classList.toggle('visible', isShow);
            });

            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const category = item.dataset.category;
                    filterByCategory(category);
                    isShow = false;
                    menu.classList.remove('visible');
                });
            });

            document.addEventListener('click', () => {
                isShow = false;
                menu.classList.remove('visible');
            });
        }

        // åˆ†é¡ç¯©é¸ï¼ˆä¿®å¾©é ç´„ç„¡æ³•é€å‡ºçš„å•é¡Œï¼‰
        function filterByCategory(category) {
            const books = window.libraryData.allBooks;
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            // éš±è—æµ·å ±æŒ‰éˆ•
            document.getElementById('posterButtonsContainer').style.display = 'none';

            const filtered = category === 'all' ? books : books.filter(b => b.classCode === category);

            filtered.forEach((book, index) => {
                const card = createBookCard(book);
                card.dataset.group = Math.ceil((index + 1) / 3);
                container.appendChild(card);
            });

            showSection('posterSection');
            document.getElementById('currentIssueTitle').textContent = category === 'all' ? 'å…¨éƒ¨æ›¸ç±' : `${category} åˆ†é¡æ›¸ç±`;
            // ç¢ºä¿æ•¸æ“šåŒæ­¥
            collectAllBooks();
        }

        // æ¸²æŸ“ç”¨æˆ¶æ¨è–¦åˆ—è¡¨
        function renderUserRecommendList() {
            const list = document.getElementById('userRecommendList');
            list.innerHTML = '';
            const sorted = [...window.libraryData.recommendRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                list.innerHTML = '<p>æš«ç„¡æ¨è–¦è¨˜éŒ„</p>';
                return;
            }

            sorted.forEach((r, i) => {
                let statusText = r.status === 'å·²æ¨è–¦' ? 'æ¨è–¦ä¸­' : r.status === 'å·²è¨˜éŒ„' ? 'å·²è¨˜éŒ„' : 'ä¸åˆè¦å®š';
                let statusClass = r.status === 'å·²æ¨è–¦' ? 'status-pending' : r.status === 'å·²è¨˜éŒ„' ? 'status-recorded' : 'status-invalid';
                // ç²å–éš¨æ©Ÿé¡è‰²
                const randomColor = window.getRandomSoftColor();
                list.innerHTML += `
        <div class="recommend-item">
            <span class="recommend-index" style="background: ${randomColor}">${i + 1}</span>
            <span class="recommend-name">${r.bookName}</span>
            <span class="recommend-status ${statusClass}">${statusText}</span>
        </div>
    `;
            });
        }



        // åˆ›å»ºä¹¦ç±å¡ç‰‡ï¼ˆä¿®å¤é¢„çº¦æŒ‰é’®IDç»‘å®šï¼‰
        function createBookCard(book) {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.dataset.classCode = book.classCode;
            card.dataset.id = book.id; // ç»‘å®šæ ‡å‡†ID

            let statusText, statusClass, reserveBtn;
            if (book.status === 'in') {
                statusText = 'åœ¨æ¶ï¼ˆå¯é ç´„ï¼‰';
                statusClass = 'status-in';
                // ç¡®ä¿é¢„çº¦æŒ‰é’®ä½¿ç”¨æ­£ç¡®çš„ID
                reserveBtn = `<button class="reserve-btn" style="background: #0071e3; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 0.9em; cursor: pointer;" onclick="showReserveModal('${book.id}')">é ç´„</button>`;
            } else if (book.status === 'out') {
                statusText = 'ä¸åœ¨æ¶';
                statusClass = 'status-out';
                reserveBtn = '';
            } else {
                statusText = 'å·²è¢«é ç´„';
                statusClass = 'status-reserved';
                reserveBtn = '';
            }

            // è·å–è©²æ›¸é»è®šæ•¸
            const likeCount = window.libraryData.bookLikes[book.id] || 0;
            card.innerHTML = `
        <div style="position: relative;">
            <img src="${book.cover || ''}" class="book-cover" onerror="this.style.display='none'">
            <button class="like-btn ${likeCount > 0 ? 'liked' : ''}" data-book-id="${book.id}" onclick="bookLike('${book.id}'); event.stopPropagation();" style="position: absolute; top: 0; right: 0; background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 5px;">
                ğŸ¤<span style="font-size: 0.8em; margin-left: 2px;">${likeCount}</span>
            </button>
        </div>
        <h3 class="book-title">${book.title}</h3>
        <p>ä½œè€…: ${book.author || 'å¾…ç·¨è¼¯'}</p>
        <p>ç°¡ä»‹: ${book.intro || 'å¾…ç·¨è¼¯'}</p>
        <p>é©åˆ: ${book.suitable || 'å¾…ç·¨è¼¯'}</p>
        <div class="book-status-bar">
            <span class="book-status ${statusClass}">${statusText}</span>
            <div style="display:flex; align-items:center; gap: 8px;">
                <button class="comment-btn" onclick="showCommentModal('${book.id}'); event.stopPropagation();" style="background: #ff9500; color: white; border: none; padding: 4px 8px; border-radius: 15px; font-size: 0.8em; cursor: pointer;">ğŸ’¬</button>
                ${reserveBtn}
            </div>
        </div>
        <p class="book-callno">ç´¢æ›¸è™Ÿ: ${book.callNo || 'å¾…ç·¨è¼¯'}</p>
    `;

            // ç¡®ä¿ç‚¹èµæŒ‰é’®æ ·å¼æ­£ç¡®
            const likeBtn = card.querySelector('.like-btn');
            if (likeBtn && likeCount > 0) {
                likeBtn.innerHTML = `â¤ï¸<span style="font-size: 0.8em; margin-left: 2px;">${likeCount}</span>`;
                likeBtn.classList.add('liked');
            }

            return card;
        }

        // æ¸²æŸ“æ›¸ç±åˆ—è¡¨ - ä¿®å¾©è³‡æ–™åˆå§‹åŒ–å•é¡Œ
        window.renderBooks = function (issue, posterNum) {
            console.log('æ¸²æŸ“æ›¸ç± - æœŸæ•¸:', issue, 'æµ·å ±:', posterNum);

            const container = document.getElementById('booksContainer');
            container.innerHTML = '';

            // åŠ å¼·åˆå§‹åŒ–é‚è¼¯
            if (!window.libraryData.issues[issue]) {
                window.libraryData.issues[issue] = {
                    posters: { 1: '', 2: '' },
                    books: { 1: {}, 2: {} }
                };
            }
            if (!window.libraryData.issues[issue].books[posterNum]) {
                window.libraryData.issues[issue].books[posterNum] = {};
            }

            const books = window.libraryData.issues[issue].books[posterNum];
            console.log('ç•¶å‰è³‡æ–™çµæ§‹:', books);

            for (let i = 1; i <= 9; i++) {
                const bookId = `issue-${issue}-poster-${posterNum}-book-${i}`;

                // åœ¨ renderBooks å‡½æ•¸ä¸­ï¼Œç¢ºä¿æ–°æ›¸çš„é è¨­å€¼æ­£ç¢º
                let book;
                if (books[i]) {
                    // å¦‚æœæ›¸ç±å·²å­˜åœ¨ï¼Œä¿ç•™ç¾æœ‰è³‡æ–™ï¼Œåªç¢ºä¿IDæ­£ç¢º
                    book = { ...books[i] };
                    book.id = bookId;
                } else {
                    // å¦‚æœæ›¸ç±ä¸å­˜åœ¨ï¼Œå‰µå»ºæ–°æ›¸
                    book = {
                        id: bookId,
                        issue: issue.toString(),
                        posterNum: posterNum.toString(),
                        bookNum: i.toString(),
                        callNo: 'å¾…ç·¨è¼¯',
                        title: 'æ–°æ›¸' + i,
                        classCode: '000',
                        author: 'å¾…ç·¨è¼¯',
                        intro: 'å¾…ç·¨è¼¯',
                        suitable: 'å¾…ç·¨è¼¯',
                        status: 'in',
                        cover: ''
                    };
                }

                // æ›´æ–°è³‡æ–™
                books[i] = book;
                window.libraryData.issues[issue].books[posterNum][i] = book;

                const card = createBookCard(book);
                card.dataset.group = Math.ceil(i / 3);
                container.appendChild(card);
            }
            collectAllBooks();

        }


        // æ¸²æŸ“ç•¶å‰è¦–åœ–
        function renderCurrentView() {
            const activeSec = document.querySelector('.content-section:not(.hidden)');
            if (activeSec.id === 'posterSection') {
                const issue = document.getElementById('issueSelect').value;
                const poster = document.querySelector('.poster-thumb:hover')?.dataset.poster || '1';
                window.renderBooks(issue, poster);
            }
        }

        // æ¸²æŸ“é ç´„è¨˜éŒ„
        function renderReserveRecords() {
            const container = document.getElementById('reserveRecordsContainer');
            container.innerHTML = '';
            const sorted = [...window.libraryData.reserveRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                container.innerHTML = '<p>æš«ç„¡é ç´„è¨˜éŒ„</p>';
                return;
            }

            sorted.forEach((r, i) => {
                container.innerHTML += `
                    <div class="record-item">
                        <div>${r.time} | ${r.bookTitle} | ${r.className} ${r.studentName}</div>
                        <select onchange="updateReserveStatus(${i}, this.value)">
                            <option ${r.status === 'å·²é ç´„' ? 'selected' : ''}>å·²é ç´„</option>
                            <option ${r.status === 'è™•ç†ä¸­' ? 'selected' : ''}>è™•ç†ä¸­</option>
                            <option ${r.status === 'å€Ÿèµ°äº†' ? 'selected' : ''}>å€Ÿèµ°äº†</option>
                            <option ${r.status === 'æ‰¾ä¸åˆ°' ? 'selected' : ''}>æ‰¾ä¸åˆ°</option>
                            <option ${r.status === 'å·²é‚„æ›¸' ? 'selected' : ''}>å·²é‚„æ›¸</option>
                        </select>
                    </div>
                `;
            });
        }

        // æ¸²æŸ“æ¨è–¦è¨˜éŒ„
        function renderRecommendRecords() {
            const container = document.getElementById('recommendRecordsContainer');
            container.innerHTML = '';
            const sorted = [...window.libraryData.recommendRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                container.innerHTML = '<p>æš«ç„¡æ¨è–¦è¨˜éŒ„</p>';
                return;
            }

            sorted.forEach((r, i) => {
                container.innerHTML += `
                    <div class="record-item">
                        <div>${r.time} | æ›¸å: ${r.bookName} | ç†ç”±: ${r.reason}</div>
                        <select onchange="updateRecommendStatus(${i}, this.value)">
                            <option ${r.status === 'å·²æ¨è–¦' ? 'selected' : ''}>æ¨è–¦ä¸­</option>
                            <option ${r.status === 'å·²è¨˜éŒ„' ? 'selected' : ''}>å·²è¨˜éŒ„</option>
                            <option ${r.status === 'ä¸åˆè¦å®š' ? 'selected' : ''}>ä¸åˆè¦å®š</option>
                        </select>
                    </div>
                `;
            });
        }

        // é¡¯ç¤ºé ç´„å½ˆçª—ï¼ˆä¿®å¾©æ‰‹æ©Ÿç‰ˆå•é¡Œï¼‰
        window.showReserveModal = function (bookId) {
            // åŒé‡æ£€æŸ¥ï¼šå…ˆä»allBooksæ‰¾ï¼Œæ‰¾ä¸åˆ°åˆ™ç›´æ¥ä»åŸæ•°æ®è§£æ
            let book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                // ç›´æ¥ä»bookIdè§£æå‡ºä¹¦çš„ä½ç½®å¹¶è¯»å–
                const [issue, poster, bookNum] = bookId.split('-');
                if (window.libraryData.issues[issue]?.books[poster]?.[bookNum]) {
                    book = window.libraryData.issues[issue].books[poster][bookNum];
                }
            }
            if (!book) {
                alert('æœªæ‰¾åˆ°é€™æœ¬æ›¸çš„è³‡è¨Šï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
                return;
            }
            document.getElementById('bookReserveInfo').innerText = `æ›¸å: ${book.title || 'æœªçŸ¥æ›¸å'}`;
            document.getElementById('reserveBookId').value = bookId;

            // ç¢ºä¿å½ˆçª—é¡¯ç¤º
            const modal = document.getElementById('reserveModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex'; // å¼·åˆ¶é¡¯ç¤º
        }

        // æäº¤é ç´„
        window.submitReserve = function () {
            const bookId = document.getElementById('reserveBookId').value;
            const book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                alert('æ›¸ç±è³‡è¨Šä¸å­˜åœ¨');
                return;
            }

            const className = document.getElementById('className').value.trim();
            const studentName = document.getElementById('studentName').value.trim();

            if (!className) {
                alert('è«‹å¡«å¯«ç­ç´š');
                return;
            }
            if (!studentName) {
                alert('è«‹å¡«å¯«å§“å');
                return;
            }

            const newReserve = {
                bookId,
                bookTitle: book.title,
                className,
                studentName,
                time: new Date().toLocaleString(),
                status: 'å·²é ç´„'
            };

            window.saveReserveRecord(newReserve);
            window.closeAllModals();
            alert('é ç´„æˆåŠŸï¼æ›¸ç±ä¿ç•™2å¤©(ä¸å«ä»Šå¤©)ï¼Œè«‹ç›´æ¥å‰å¾€åœ–æ›¸é¤¨æ«ƒæª¯è¾¦ç†å€Ÿæ›¸');

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('className').value = '';
            document.getElementById('studentName').value = '';
        }

        // é¡¯ç¤ºæ¨è–¦è¡¨å–®ï¼ˆä¿®å¾©æ‰‹æ©Ÿç‰ˆå•é¡Œï¼‰
        window.showRecommendForm = function () {
            // åœ¨æ‰‹æ©Ÿç«¯ä½¿ç”¨é é¢è·³è½‰
            if (window.innerWidth <= 768) {
                showMobileRecommendFormPage();
            } else {
                // é›»è…¦ç«¯ä¿æŒå½ˆçª—
                const modal = document.getElementById('recommendModal');
                modal.classList.remove('hidden');
                modal.style.display = 'flex'; // å¼·åˆ¶é¡¯ç¤º
            }
        }

        // æäº¤æ¨è–¦ï¼ˆä¿®å¾©æ‰‹æ©Ÿç‰ˆå•é¡Œï¼‰
        window.submitRecommend = function () {
            const bookName = document.getElementById('recommendBookName').value.trim();
            const reason = document.getElementById('recommendReason').value.trim();

            if (!bookName) {
                alert('è«‹å¡«å¯«æ›¸å');
                return;
            }
            if (!reason) {
                alert('è«‹å¡«å¯«æ¨è–¦ç†ç”±ï¼Œå¯å¡«[ç„¡]');
                return;
            }

            const newRecommend = {
                bookName,
                reason,
                time: new Date().toLocaleString(),
                status: 'å·²æ¨è–¦'
            };

            window.saveRecommendRecord(newRecommend);
            window.closeAllModals();
            alert('æ¨è–¦æˆåŠŸï¼Œæ„Ÿè¬ä½ çš„å»ºè­°ï¼');

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('recommendBookName').value = '';
            document.getElementById('recommendReason').value = '';
        }


        // æœç´¢æ›¸ç±ï¼ˆä¿®å¾©é ç´„ç„¡æ³•é€å‡ºçš„å•é¡Œï¼‰
        window.searchBooks = function () {
            const keyword = document.getElementById('keywordInput').value.toLowerCase();
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            // éš±è—æµ·å ±æŒ‰éˆ•
            document.getElementById('posterButtonsContainer').style.display = 'none';

            if (!keyword) {
                showLatestIssue();
                return;
            }


            // é‡æ–°æ”¶é›†æ‰€æœ‰æ›¸ç±ï¼Œç¢ºä¿åŒ¹é…æ•¸æ“šæœ€æ–°
            collectAllBooks();
            const matched = window.libraryData.allBooks.filter(book =>
                book.title.toLowerCase().includes(keyword) ||
                book.author.toLowerCase().includes(keyword) ||
                book.callNo.toLowerCase().includes(keyword) ||
                book.intro.toLowerCase().includes(keyword)
            );

            if (matched.length === 0) {
                container.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æ›¸ç±</p>';
            } else {
                matched.forEach((book, index) => {
                    const card = createBookCard(book);
                    card.dataset.group = Math.ceil((index + 1) / 3);
                    container.appendChild(card);
                });
            }

            showSection('posterSection');
            document.getElementById('currentIssueTitle').textContent = `æœç´¢çµæœ: "${keyword}"`;
        }

        // é¡¯ç¤ºæŒ‡å®šå€åŸŸ
        window.showSection = function (sectionId) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // é¡¯ç¤ºç®¡ç†å“¡ç™»éŒ„
        window.showAdminLogin = function () {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        // ç®¡ç†å“¡ç™»éŒ„
        window.adminLogin = function () {
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            if (user === 'kakihara' && pass === 'naotoki') {
                window.closeAllModals();
                document.getElementById('adminPanel').classList.remove('hidden');
                renderReserveRecords();
                renderRecommendRecords();
            } else {
                alert('è³¬è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
            }
        }

        // é€€å‡ºç®¡ç†å“¡
        window.logoutAdmin = function () {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // é—œé–‰æ‰€æœ‰å½ˆçª—ï¼ˆä¿®å¾©æ‰‹æ©Ÿç‰ˆå•é¡Œï¼‰
        window.closeAllModals = function () {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
                modal.style.display = 'none'; // å¼·åˆ¶éš±è—
            });
            // ä¹Ÿé—œé–‰è¼ªæ’­æ›¸ç±è©³æƒ…å½ˆçª—
            closeCarouselBookDetail();
        }
        // è®¾ç½®å¯¼èˆªé¡¹æ´»è·ƒçŠ¶æ€
        window.setActiveNav = function (element) {
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // ç»™å½“å‰ç‚¹å‡»çš„å¯¼èˆªé¡¹æ·»åŠ æ´»è·ƒçŠ¶æ€
            element.classList.add('active');
        }
        // ç”Ÿæˆéš¨æ©ŸæŸ”å’Œé¡è‰²ï¼ˆç”¨æ–¼æ¨è–¦æ›¸ç±åºè™Ÿï¼‰
        window.getRandomSoftColor = function () {
            // é å®šæŸ”å’Œè‰²è­œï¼Œé¿å…åˆºçœ¼é¡è‰²
            const colors = [
                '#0071e3', '#34c759', '#ff9500', '#5856d6', '#af52de',
                '#ff3b30', '#00c6ff', '#ff2d55', '#32ade6', '#4cd964'
            ];
            // éš¨æ©Ÿè¿”å›ä¸€ç¨®é¡è‰²
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // è¨­ç½®ç•¶å‰æ´»èºæµ·å ±æŒ‰éˆ•
        window.setActivePoster = function (button) {
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„æ´»èºç‹€æ…‹
            document.querySelectorAll('.poster-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // æ·»åŠ ç•¶å‰æŒ‰éˆ•çš„æ´»èºç‹€æ…‹
            button.classList.add('active');
        }

        // å…¨å±€è®Šé‡è¿½è¹¤ç•¶å‰æœŸæ•¸
        // let currentIssue = 1;





        // åˆªé™¤æ•´æœŸ - Firestore ç‰ˆæœ¬
        window.deleteWholeIssue = async function () {
            const issue = document.getElementById('deleteIssueSelect').value;
            if (!window.libraryData.issues[issue]) {
                alert('è©²æœŸä¸å­˜åœ¨');
                return;
            }

            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬${issue}æœŸæ‰€æœ‰å…§å®¹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                try {
                    await deleteDoc(doc(db, "issues", issue));
                    delete window.libraryData.issues[issue];

                    // æ›´æ–°æœ€æ–°æœŸæ•¸
                    const issues = Object.keys(window.libraryData.issues).map(Number).sort((a, b) => b - a);
                    window.libraryData.latestIssue = issues.length > 0 ? issues[0] : 1;

                    await saveData();
                    renderIssueSelectors(); // é‡æ–°æ¸²æŸ“æ‰€æœ‰é¸æ“‡å™¨
                    showLatestIssue();
                    alert(`ç¬¬${issue}æœŸå·²æˆåŠŸåˆªé™¤`);
                } catch (err) {
                    console.error("åˆªé™¤å¤±æ•—:", err);
                    alert("åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦");
                }
            }
        }
        // æ–°å¢æœŸæ•¸
        window.addNewIssue = async function () {
            const newIssue = window.libraryData.latestIssue + 1;
            window.libraryData.issues[newIssue] = {
                posters: { 1: '', 2: '' },
                books: { 1: {}, 2: {} }
            };
            window.libraryData.latestIssue = newIssue;
            await saveData();
            renderIssueSelectors();
            alert(`å·²æ–°å¢ç¬¬${newIssue}æœŸ`);
        }

        // ä¿å­˜æ›¸ç±ä¿¡æ¯
        window.saveBookInfo = function () {
            const title = document.getElementById('bookTitle').value.trim();
            if (!title) {
                alert('è«‹è¼¸å…¥æ›¸å');
                return;
            }

            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;

            if (!window.libraryData.issues[issue]) {
                window.libraryData.issues[issue] = { posters: {}, books: { 1: {}, 2: {} } };
            }
            if (!window.libraryData.issues[issue].books[posterNum]) {
                window.libraryData.issues[issue].books[posterNum] = {};
            }

            let coverUrl = window.libraryData.issues[issue].books[posterNum][bookNum]?.cover || '';
            const coverFile = document.getElementById('bookCoverUpload').files[0];

            // åœ¨ saveBookInfo å‡½æ•¸ä¸­ä¿®æ”¹å°é¢è™•ç†éƒ¨åˆ†
            if (coverFile) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    coverUrl = e.target.result;
                    saveBookData(coverUrl);
                };
                reader.readAsDataURL(coverFile);
            } else {
                saveBookData(coverUrl);
            }

            function saveBookData(cover) {
                window.libraryData.issues[issue].books[posterNum][bookNum] = {
                    callNo: document.getElementById('bookCallNo').value,
                    title: title,
                    classCode: document.getElementById('bookClassCode').value,
                    author: document.getElementById('bookAuthor').value,
                    intro: document.getElementById('bookIntro').value,
                    suitable: document.getElementById('bookSuitable').value,
                    status: document.getElementById('bookStatus').value,
                    cover: cover
                };
                saveData();
                renderBooks(issue, posterNum);
                alert('å„²å­˜æˆåŠŸ');
                document.getElementById('bookCoverUpload').value = '';
            }
        }

        // åˆªé™¤æ›¸ç±
        window.deleteBookInfo = function () {
            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;

            if (!window.libraryData.issues[issue]?.books[posterNum]?.[bookNum]) {
                alert('è©²æ›¸ç±ä¸å­˜åœ¨');
                return;
            }

            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ›¸ç±å—ï¼Ÿ')) {
                delete window.libraryData.issues[issue].books[posterNum][bookNum];
                saveData();
                renderBooks(issue, posterNum);
            }
        }

        // æ‰‹æ©Ÿç‰ˆå…¨å±€è®Šé‡
        window.mobileCurrentIssue = 1;

        // è¨­å‚™é¸æ“‡
        window.selectDevice = function (deviceType) {
            document.getElementById('deviceSelector').style.display = 'none';
            if (deviceType === 'desktop') {
                document.querySelector('.desktop-content').style.display = 'block';
            } else {
                document.querySelector('.mobile-content').style.display = 'block';
                document.querySelector('.mobile-nav').style.display = 'block';
                initMobile();
            }
            // ç¢ºä¿å…¬å‘Šèƒ½é¡¯ç¤º
            setTimeout(() => {
                loadAnnouncement();
            }, 500);
        }

        // åˆå§‹åŒ–æ‰‹æ©Ÿç‰ˆ
        window.initMobile = function () {
            renderMobileIssueSelectors();
            mobileShowLatestIssue();

            // ç¶å®šåˆ†é¡é»æ“Šäº‹ä»¶
            document.querySelectorAll('.mobile-category-item').forEach(item => {
                item.addEventListener('click', function () {
                    const category = this.dataset.category;
                    mobileFilterByCategory(category);
                    hideMobileCategoryMenu();
                });
            });
        }

        // æ¸²æŸ“æ‰‹æ©Ÿç‰ˆæœŸæ•¸é¸æ“‡å™¨
        window.renderMobileIssueSelectors = function () {
            const issues = Object.keys(window.libraryData.issues).map(Number).sort((a, b) => a - b);
            const selector = document.getElementById('mobileIssueSelect');
            selector.innerHTML = '';
            issues.forEach(issue => {
                selector.innerHTML += `<option value="${issue}">ç¬¬${issue}æœŸ</option>`;
            });
            selector.value = window.libraryData.latestIssue;
        }

        // æ‰‹æ©Ÿç‰ˆåˆ‡æ›æœŸæ•¸
        window.mobileSwitchIssue = function (issue) {
            const issueNum = Number(issue);
            window.mobileCurrentIssue = issueNum;
            mobileRenderBooks(issueNum, 1);
        }

        // æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºæœ€æ–°ä¸€æœŸ
        window.mobileShowLatestIssue = function () {
            window.mobileSwitchIssue(window.libraryData.latestIssue);
            document.getElementById('mobileIssueSelect').value = window.libraryData.latestIssue;
        }

        // æ‰‹æ©Ÿç‰ˆæ¸²æŸ“æ›¸ç±
        window.mobileRenderBooks = function (issue, posterNum) {
            const container = document.getElementById('mobileBooksContainer');
            container.innerHTML = '';

            if (!window.libraryData.issues[issue]) {
                window.libraryData.issues[issue] = {
                    posters: { 1: '', 2: '' },
                    books: { 1: {}, 2: {} }
                };
            }
            if (!window.libraryData.issues[issue].books[posterNum]) {
                window.libraryData.issues[issue].books[posterNum] = {};
            }

            const books = window.libraryData.issues[issue].books[posterNum];

            for (let i = 1; i <= 9; i++) {
                const bookId = `issue-${issue}-poster-${posterNum}-book-${i}`;

                let book;
                if (books[i]) {
                    book = { ...books[i] };
                    book.id = bookId;
                } else {
                    book = {
                        id: bookId,
                        issue: issue.toString(),
                        posterNum: posterNum.toString(),
                        bookNum: i.toString(),
                        callNo: 'å¾…ç·¨è¼¯',
                        title: 'æ–°æ›¸' + i,
                        classCode: '000',
                        author: 'å¾…ç·¨è¼¯',
                        intro: 'å¾…ç·¨è¼¯',
                        suitable: 'å¾…ç·¨è¼¯',
                        status: 'in',
                        cover: ''
                    };
                }

                books[i] = book;
                window.libraryData.issues[issue].books[posterNum][i] = book;

                const card = createMobileBookCard(book);
                container.appendChild(card);
            }
            collectAllBooks();
        }

        // å‰µå»ºæ‰‹æ©Ÿç‰ˆæ›¸ç±å¡ç‰‡
        window.createMobileBookCard = function (book) {
            const card = document.createElement('div');
            card.className = 'mobile-book-card';
            card.dataset.id = book.id;

            let statusText, statusClass, reserveBtn;
            if (book.status === 'in') {
                statusText = 'å¯é ç´„';
                statusClass = 'status-in';
                reserveBtn = `<button class="mobile-reserve-btn" style="background: #0071e3; color: white; border: none; padding: 5px 10px; border-radius: 12px; font-size: 0.75em;" onclick="showMobileReservePage('${book.id}'); event.stopPropagation();">é ç´„</button>`;
            } else if (book.status === 'out') {
                statusText = 'ä¸åœ¨æ¶';
                statusClass = 'status-out';
                reserveBtn = '';
            } else {
                statusText = 'å·²é ç´„';
                statusClass = 'status-reserved';
                reserveBtn = '';
            }

            // è·å–è©²æ›¸é»è®šæ•¸
            const likeCount = window.libraryData.bookLikes[book.id] || 0;
            card.innerHTML = `
<div style="position: relative;">
    <img src="${book.cover || ''}" class="mobile-book-cover" onerror="this.style.display='none'">
</div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
    <div class="mobile-book-title">${book.title}</div>
</div>
<!-- ä½œè€…å’ŒæŒ‰éˆ•å¹³è¡Œæ’åˆ—ï¼šä½œè€…åœ¨å·¦ï¼Œæ„›å¿ƒ+ç•™è¨€åœ¨å³ -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <div class="mobile-book-author">${book.author || 'å¾…ç·¨è¼¯'}</div>
    <div style="display: flex; align-items: center; gap: 6px;">
        <!-- é»è®šæ•¸å­—åœ¨æ„›å¿ƒå·¦å´ -->
        <button class="mobile-like-btn ${likeCount > 0 ? 'liked' : ''}" data-book-id="${book.id}" onclick="bookLike('${book.id}'); event.stopPropagation();" style="background: none; border: none; font-size: 0.8em; cursor: pointer; padding: 0; display: flex; align-items: center; gap: 2px;">
            <span style="font-size: 0.8em; color: #6e6e73;">${likeCount}</span>
            ${likeCount > 0 ? 'â¤ï¸' : 'ğŸ¤'}
        </button>
        <!-- ç•™è¨€æŒ‰éˆ•åœ¨æ„›å¿ƒå³å´ -->
        <button class="mobile-comment-btn" style="background: #ff9500; color: white; border: none; padding: 2px 6px; border-radius: 6px; font-size: 0.7em;" onclick="showMobileCommentModal('${book.id}'); event.stopPropagation();">ğŸ’¬</button>
    </div>
</div>
<div class="mobile-book-status-bar" style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
    <span class="mobile-book-status ${statusClass}">${statusText}</span>
    ${reserveBtn}
</div>
`;

            // ç¡®ä¿ç‚¹èµæŒ‰é’®åˆå§‹æ ·å¼æ­£ç¡®ï¼ˆæ— éœ€é¢å¤–æ·»åŠ æ•°å­—ï¼ŒæŒ‰é’®å†…å·²åŒ…å«ï¼‰
            const likeBtn = card.querySelector('.mobile-like-btn');
            if (likeBtn && likeCount > 0) {
                likeBtn.innerHTML = `<span style="font-size: 0.8em; color: #6e6e73;">${likeCount}</span> â¤ï¸`;
                likeBtn.classList.add('liked');
            }

            // é»æ“Šå¡ç‰‡é¡¯ç¤ºè©³æƒ…ï¼ˆé™¤äº†æŒ‰éˆ•ï¼‰
            card.addEventListener('click', function (e) {
                // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•ï¼Œä¸é¡¯ç¤ºè©³æƒ…
                if (e.target.classList.contains('mobile-reserve-btn') ||
                    e.target.classList.contains('mobile-comment-btn') ||
                    e.target.classList.contains('mobile-like-btn')) {
                    return;
                }
                showMobileBookDetail(book.id);
            });

            return card;
        }
        // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆæ›¸ç±è©³æƒ…
        window.showMobileBookDetail = function (bookId) {
            const book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) return;

            let statusText, statusClass, reserveBtn;
            if (book.status === 'in') {
                statusText = 'åœ¨æ¶ï¼ˆå¯é ç´„ï¼‰';
                statusClass = 'status-in';
                reserveBtn = `<button class="btn-primary" onclick="showMobileReservePage('${book.id}')" style="margin-top: 15px;">é ç´„æ›¸ç±</button>`;
            } else if (book.status === 'out') {
                statusText = 'ä¸åœ¨æ¶';
                statusClass = 'status-out';
                reserveBtn = '';
            } else {
                statusText = 'å·²è¢«é ç´„';
                statusClass = 'status-reserved';
                reserveBtn = '';
            }

            const detailContent = document.getElementById('mobileBookDetailContent');
            detailContent.innerHTML = `
        <div class="mobile-book-detail-header">
            <h3>æ›¸ç±è©³æƒ…</h3>
            <button class="mobile-close-detail" onclick="hideMobileBookDetail()">âœ•</button>
        </div>
        <img src="${book.cover || ''}" class="mobile-book-detail-cover" onerror="this.style.display='none'">
        <div class="mobile-book-detail-title">${book.title}</div>
        <div class="mobile-book-detail-info">
            <p><strong>ä½œè€…:</strong> ${book.author || 'å¾…ç·¨è¼¯'}</p>
            <p><strong>ç°¡ä»‹:</strong> ${book.intro || 'å¾…ç·¨è¼¯'}</p>
            <p><strong>é©åˆ:</strong> ${book.suitable || 'å¾…ç·¨è¼¯'}</p>
            <p><strong>ç´¢æ›¸è™Ÿ:</strong> ${book.callNo || 'å¾…ç·¨è¼¯'}</p>
            <p><strong>ç‹€æ…‹:</strong> <span class="book-status ${statusClass}">${statusText}</span></p>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            ${reserveBtn}
            <button class="btn-text" onclick="hideMobileBookDetail()" style="margin-left: 10px;">é—œé–‰</button>
        </div>
    `;

            document.getElementById('mobileBookDetail').style.display = 'block';
        }

        // éš±è—æ‰‹æ©Ÿç‰ˆæ›¸ç±è©³æƒ…
        window.hideMobileBookDetail = function () {
            document.getElementById('mobileBookDetail').style.display = 'none';
        }

        // è¨­ç½®æ´»èºæµ·å ±æŒ‰éˆ•
        window.setActiveMobilePoster = function (button) {
            document.querySelectorAll('.mobile-poster-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
        }

        // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆåˆ†é¡èœå–®
        window.showMobileCategoryMenu = function () {
            document.getElementById('mobileCategoryMenu').style.display = 'block';
        }

        // éš±è—æ‰‹æ©Ÿç‰ˆåˆ†é¡èœå–®
        window.hideMobileCategoryMenu = function () {
            document.getElementById('mobileCategoryMenu').style.display = 'none';
        }

        // æ‰‹æ©Ÿç‰ˆåˆ†é¡ç¯©é¸
        window.mobileFilterByCategory = function (category) {
            const books = window.libraryData.allBooks;
            const container = document.getElementById('mobileBooksContainer');
            container.innerHTML = '';

            const filtered = category === 'all' ? books : books.filter(b => b.classCode === category);

            filtered.forEach(book => {
                const card = createMobileBookCard(book);
                container.appendChild(card);
            });
        }

        // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆæœç´¢
        window.showMobileSearch = function () {
            document.getElementById('mobileSearchBar').style.display = 'block';
        }

        // éš±è—æ‰‹æ©Ÿç‰ˆæœç´¢
        window.hideMobileSearch = function () {
            document.getElementById('mobileSearchBar').style.display = 'none';
        }

        // æ‰‹æ©Ÿç‰ˆæœç´¢æ›¸ç±
        window.mobileSearchBooks = function () {
            const keyword = document.getElementById('mobileKeywordInput').value.toLowerCase();
            const container = document.getElementById('mobileBooksContainer');
            container.innerHTML = '';

            if (!keyword) {
                mobileShowLatestIssue();
                hideMobileSearch();
                return;
            }

            collectAllBooks();
            const matched = window.libraryData.allBooks.filter(book =>
                book.title.toLowerCase().includes(keyword) ||
                book.author.toLowerCase().includes(keyword) ||
                book.callNo.toLowerCase().includes(keyword) ||
                book.intro.toLowerCase().includes(keyword)
            );

            if (matched.length === 0) {
                container.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æ›¸ç±</p>';
            } else {
                matched.forEach(book => {
                    const card = createMobileBookCard(book);
                    container.appendChild(card);
                });
            }

            hideMobileSearch();
        }

        // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆæ¨è–¦é é¢
        window.showMobileRecommendPage = function () {
            document.querySelector('.mobile-main-content').style.display = 'none';
            document.getElementById('mobileRecommendPage').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'none'; // éš±è—åº•éƒ¨æŒ‰éˆ•
            renderMobileUserRecommendList();
        }

        // éš±è—æ‰‹æ©Ÿç‰ˆæ¨è–¦é é¢
        window.hideMobileRecommendPage = function () {
            document.getElementById('mobileRecommendPage').style.display = 'none';
            document.querySelector('.mobile-main-content').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'block'; // é¡¯ç¤ºåº•éƒ¨æŒ‰éˆ•
        }

        // æ¸²æŸ“æ‰‹æ©Ÿç‰ˆç”¨æˆ¶æ¨è–¦åˆ—è¡¨
        window.renderMobileUserRecommendList = function () {
            const list = document.getElementById('mobileUserRecommendList');
            list.innerHTML = '';
            const sorted = [...window.libraryData.recommendRecords].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sorted.length === 0) {
                list.innerHTML = '<p>æš«ç„¡æ¨è–¦è¨˜éŒ„</p>';
                return;
            }

            sorted.forEach((r, i) => {
                let statusText = r.status === 'å·²æ¨è–¦' ? 'æ¨è–¦ä¸­' : r.status === 'å·²è¨˜éŒ„' ? 'å·²è¨˜éŒ„' : 'ä¸åˆè¦å®š';
                let statusClass = r.status === 'å·²æ¨è–¦' ? 'status-pending' : r.status === 'å·²è¨˜éŒ„' ? 'status-recorded' : 'status-invalid';
                const randomColor = window.getRandomSoftColor();

                list.innerHTML += `
            <div class="recommend-item">
                <span class="recommend-index" style="background: ${randomColor}">${i + 1}</span>
                <span class="recommend-name">${r.bookName}</span>
                <span class="recommend-status ${statusClass}">${statusText}</span>
            </div>
        `;
            });
        }


        // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆé ç´„é é¢
        window.showMobileReservePage = function (bookId) {
            const book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                alert('æœªæ‰¾åˆ°æ›¸ç±è³‡è¨Š');
                return;
            }

            // å¡«å……æ›¸ç±è³‡è¨Š
            document.getElementById('mobileReserveBookInfo').innerHTML = `
        <h4 style="margin-bottom: 10px; color: #1d1d1f;">${book.title}</h4>
        <p style="margin: 5px 0; color: #6e6e73;">ä½œè€…: ${book.author || 'å¾…ç·¨è¼¯'}</p>
        <p style="margin: 5px 0; color: #6e6e73;">ç´¢æ›¸è™Ÿ: ${book.callNo || 'å¾…ç·¨è¼¯'}</p>
    `;

            // è¨­ç½®æ›¸ç±ID
            document.getElementById('mobileReserveBookId').value = bookId;

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('mobileClassName').value = '';
            document.getElementById('mobileStudentName').value = '';

            // é¡¯ç¤ºé ç´„é é¢ï¼Œéš±è—ä¸»å…§å®¹
            document.querySelector('.mobile-main-content').style.display = 'none';
            document.getElementById('mobileReservePage').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'none';
        }

        // éš±è—æ‰‹æ©Ÿç‰ˆé ç´„é é¢
        window.hideMobileReservePage = function () {
            document.getElementById('mobileReservePage').style.display = 'none';
            document.querySelector('.mobile-main-content').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'block';
        }

        // æäº¤æ‰‹æ©Ÿç‰ˆé ç´„
        window.submitMobileReserve = function () {
            const bookId = document.getElementById('mobileReserveBookId').value;
            const book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                alert('æ›¸ç±è³‡è¨Šä¸å­˜åœ¨');
                return;
            }

            const className = document.getElementById('mobileClassName').value.trim();
            const studentName = document.getElementById('mobileStudentName').value.trim();

            if (!className) {
                alert('è«‹å¡«å¯«ç­ç´š');
                return;
            }
            if (!studentName) {
                alert('è«‹å¡«å¯«å§“å');
                return;
            }

            const newReserve = {
                bookId,
                bookTitle: book.title,
                className,
                studentName,
                time: new Date().toLocaleString(),
                status: 'å·²é ç´„'
            };

            window.saveReserveRecord(newReserve);
            hideMobileReservePage();
            alert('é ç´„æˆåŠŸï¼æ›¸ç±ä¿ç•™2å¤©(ä¸å«ä»Šå¤©)ï¼Œè«‹ç›´æ¥å‰å¾€åœ–æ›¸é¤¨æ«ƒæª¯è¾¦ç†å€Ÿæ›¸');
        }

        // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆæ¨è–¦è¡¨å–®é é¢
        window.showMobileRecommendFormPage = function () {
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('mobileRecommendBookName').value = '';
            document.getElementById('mobileRecommendReason').value = '';

            // é¡¯ç¤ºæ¨è–¦è¡¨å–®é é¢ï¼Œéš±è—å…¶ä»–å…§å®¹
            document.querySelector('.mobile-main-content').style.display = 'none';
            document.getElementById('mobileRecommendPage').style.display = 'none';
            document.getElementById('mobileRecommendFormPage').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'none';
        }

        // éš±è—æ‰‹æ©Ÿç‰ˆæ¨è–¦è¡¨å–®é é¢
        window.hideMobileRecommendFormPage = function () {
            document.getElementById('mobileRecommendFormPage').style.display = 'none';
            document.getElementById('mobileRecommendPage').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'none';
        }

        // æäº¤æ‰‹æ©Ÿç‰ˆæ¨è–¦
        window.submitMobileRecommend = function () {
            const bookName = document.getElementById('mobileRecommendBookName').value.trim();
            const reason = document.getElementById('mobileRecommendReason').value.trim();

            if (!bookName) {
                alert('è«‹å¡«å¯«æ›¸å');
                return;
            }
            if (!reason) {
                alert('è«‹å¡«å¯«æ¨è–¦ç†ç”±ï¼Œå¯å¡«[ç„¡]');
                return;
            }

            const newRecommend = {
                bookName,
                reason,
                time: new Date().toLocaleString(),
                status: 'å·²æ¨è–¦'
            };

            window.saveRecommendRecord(newRecommend);
            hideMobileRecommendFormPage();
            alert('æ¨è–¦æˆåŠŸï¼Œæ„Ÿè¬ä½ çš„å»ºè­°ï¼');
        }

        // æ»¾å‹•åˆ°é ‚éƒ¨
        window.scrollToTop = function () {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            mobileShowLatestIssue();
        }
        // ====== æ–°å¢ï¼šæ›¸ç±é»è®šåŠŸèƒ½ ======
        window.bookLike = async function (bookId) {
            // åˆå§‹åŒ–é»è®šæ•¸
            if (!window.libraryData.bookLikes[bookId]) {
                window.libraryData.bookLikes[bookId] = 0;
            }
            // é»è®š+1
            window.libraryData.bookLikes[bookId] += 1;
            // æ›´æ–°UI
            const likeBtn = document.querySelector(`[data-book-id="${bookId}"].like-btn`);
            const mobileLikeBtn = document.querySelector(`[data-book-id="${bookId}"].mobile-like-btn`);
            if (likeBtn) {
                likeBtn.innerHTML = `â¤ï¸<span style="font-size: 0.8em; margin-left: 2px;">${window.libraryData.bookLikes[bookId]}</span>`;
                likeBtn.classList.add('liked');
            }
            if (mobileLikeBtn) {
                mobileLikeBtn.innerHTML = `<span style="font-size: 0.8em; color: #6e6e73;">${window.libraryData.bookLikes[bookId]}</span> â¤ï¸`;
                mobileLikeBtn.classList.add('liked');
            }
            // ä¿å­˜åˆ°Firebase
            try {
                await setDoc(doc(db, "bookLikes", bookId), {
                    count: window.libraryData.bookLikes[bookId]
                });
            } catch (err) {
                console.error("ä¿å­˜é»è®šå¤±æ•—:", err);
            }
        }

        // ====== æ–°å¢ï¼šæ‰“é–‹ç•™è¨€å½ˆçª— ======
        window.showCommentModal = function (bookId) {
            const book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                alert('æœªæ‰¾åˆ°æ›¸ç±è³‡è¨Š');
                return;
            }
            // å¡«å……æ›¸ç±ä¿¡æ¯
            document.getElementById('commentBookTitle').innerText = book.title || 'æœªçŸ¥æ›¸å';
            document.getElementById('commentBookId').value = bookId;
            // åŠ è¼‰ç•™è¨€åˆ—è¡¨
            loadBookComments(bookId);
            // é¡¯ç¤ºå½ˆçª—
            const modal = document.getElementById('commentModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        // ====== æ–°å¢ï¼šåŠ è¼‰æ›¸ç±ç•™è¨€ ======
        function loadBookComments(bookId) {
            const commentList = document.getElementById('commentList');
            commentList.innerHTML = '';
            // è·å–è©²æ›¸ç•™è¨€ï¼ŒæŒ‰é ‚ç½®+é»è®šæ’åº
            let comments = window.libraryData.bookComments[bookId] || [];
            // æ’åºï¼šé ‚ç½®åœ¨å‰ï¼Œç„¶å¾ŒæŒ‰é»è®šæ•¸é™åº
            comments = comments.sort((a, b) => {
                if (a.isTop && !b.isTop) return -1;
                if (!a.isTop && b.isTop) return 1;
                return b.likeCount - a.likeCount;
            });

            if (comments.length === 0) {
                commentList.innerHTML = '<p style="text-align:center; color:#6e6e73; padding:20px;">æš«ç„¡ç•™è¨€ï¼Œä¾†æ¶é¦–è©•å§ï½</p>';
                return;
            }

            // æ¸²æŸ“ç•™è¨€
            comments.forEach((comment, index) => {
                const topTag = comment.isTop ? '<span class="top-tag">é ‚ç½®</span>' : '';
                commentList.innerHTML += `
            <div class="comment-item" data-comment-id="${comment.id}">
                ${topTag}
                <div class="comment-content">${comment.content}</div>
                <div class="comment-footer">
                    <span class="comment-time">${comment.time}</span>
                    <button class="comment-like-btn" onclick="commentLike('${bookId}', '${comment.id}')">
                        â¤ï¸ ${comment.likeCount || 0}
                    </button>
                </div>
            </div>
        `;
            });
        }

        // ====== æ–°å¢ï¼šç•™è¨€é»è®š ======
        window.commentLike = async function (bookId, commentId) {
            const comments = window.libraryData.bookComments[bookId] || [];
            const comment = comments.find(c => c.id === commentId);
            if (!comment) return;

            // ç•™è¨€é»è®š+1
            comment.likeCount = (comment.likeCount || 0) + 1;
            // æ›´æ–°UI
            const likeBtn = document.querySelector(`.comment-item[data-comment-id="${commentId}"] .comment-like-btn`);
            if (likeBtn) {
                likeBtn.innerHTML = `â¤ï¸ ${comment.likeCount}`;
                likeBtn.classList.add('liked');
            }
            // ä¿å­˜åˆ°Firebase
            await saveData();
            // é‡æ–°åŠ è¼‰ç•™è¨€
            loadBookComments(bookId);
        }

        // ====== æ–°å¢ï¼šæäº¤ç•™è¨€ ======
        window.submitComment = async function () {
            const bookId = document.getElementById('commentBookId').value;
            const content = document.getElementById('commentContent').value.trim();
            if (!content) {
                alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹ï½');
                return;
            }
            // å‰µå»ºæ–°ç•™è¨€
            const newComment = {
                id: 'comment_' + Date.now(), // éš¨æ©ŸID
                content: content,
                likeCount: 0,
                isTop: false,
                time: new Date().toLocaleString()
            };
            // æ·»åŠ åˆ°æ•¸æ“š
            if (!window.libraryData.bookComments[bookId]) {
                window.libraryData.bookComments[bookId] = [];
            }
            window.libraryData.bookComments[bookId].push(newComment);
            // ä¿å­˜åˆ°Firebase
            await saveData();
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('commentContent').value = '';
            // é‡æ–°åŠ è¼‰ç•™è¨€
            loadBookComments(bookId);
            alert('ç•™è¨€æˆåŠŸï½');
        }

        // ====== æ–°å¢ï¼šåŠ è¼‰æ’è¡Œæ¦œ ======
        window.loadRanking = function () {
            // æ”¶é›†æ‰€æœ‰æ›¸ç±çš„é»è®šæ•¸
            const rankedBooks = window.libraryData.allBooks.map(book => {
                return {
                    ...book,
                    likeCount: window.libraryData.bookLikes[book.id] || 0
                };
            }).filter(book => book.likeCount > 0) // åªé¡¯ç¤ºæœ‰é»è®šçš„æ›¸
                .sort((a, b) => b.likeCount - a.likeCount) // æŒ‰è®šæ•¸é™åº
                .slice(0, 10); // åªå–å‰10å

            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';

            if (rankedBooks.length === 0) {
                rankingList.innerHTML = '<p style="text-align:center; color:#6e6e73; padding:20px;">æš«ç„¡é»è®šæ•¸æ“šï½</p>';
                return;
            }

            // æ¸²æŸ“æ’è¡Œæ¦œï¼ˆAppleé¢¨æ ¼ï¼‰
            rankedBooks.forEach((book, index) => {
                const randomColor = window.getRandomSoftColor();
                rankingList.innerHTML += `
<div class="ranking-item" onclick="jumpToBookIssue('${book.issue}', '${book.posterNum}')">
    <span class="ranking-index" style="background: ${randomColor}">${index + 1}</span>
    <span class="ranking-bookname">${book.title}</span>
    <div style="display: flex; align-items: center; gap: 8px;">
        <!-- ç•™è¨€åœ–æ¨™ï¼šé»æ“Šæ‰“é–‹ç•™è¨€å½ˆçª— -->
        <span style="color: #ff9500; font-size: 1em; cursor: pointer;" onclick="showCommentModal('${book.id}'); event.stopPropagation();">ğŸ’¬</span>
        <span class="ranking-likes">â¤ï¸ ${book.likeCount}</span>
    </div>
</div>
`;
            });

            showSection('rankingSection');
        }

        // ====== æ–°å¢ï¼šè·³è½‰åˆ°æ›¸ç±å°æ‡‰æœŸæ•¸ ======
        window.jumpToBookIssue = function (issue, posterNum) {
            // é›»è…¦ç‰ˆè™•ç†
            window.switchIssue(issue);
            window.renderBooks(issue, posterNum);

            // æ‰‹æ©Ÿç‰ˆè™•ç†ï¼ˆæ–°å¢å¯è¦‹æ€§åˆ‡æ›ï¼‰
            window.mobileSwitchIssue(issue);
            window.mobileRenderBooks(issue, posterNum);

            // æª¢æŸ¥æ˜¯å¦åœ¨æ‰‹æ©Ÿç‰ˆæ’è¡Œæ¦œé é¢ï¼Œè‹¥æ˜¯å‰‡è¿”å›ä¸»é 
            const mobileRankingPage = document.getElementById('mobileRankingPage');
            if (mobileRankingPage && mobileRankingPage.style.display !== 'none') {
                hideMobileRankingPage();
                // ç¢ºä¿æ‰‹æ©Ÿç‰ˆä¸»å…§å®¹é¡¯ç¤º
                document.querySelector('.mobile-main-content').style.display = 'block';
            }
        }

        // ====== æ–°å¢ï¼šç®¡ç†å¾Œå°åŠ è¼‰æ‰€æœ‰ç•™è¨€ ======
        window.loadAllComments = function () {
            const adminCommentList = document.getElementById('adminCommentList');
            adminCommentList.innerHTML = '';
            // æ”¶é›†æ‰€æœ‰ç•™è¨€
            const allComments = [];
            for (const bookId in window.libraryData.bookComments) {
                const book = window.libraryData.allBooks.find(b => b.id === bookId);
                const bookTitle = book ? book.title : 'æœªçŸ¥æ›¸ç±';
                window.libraryData.bookComments[bookId].forEach(comment => {
                    allComments.push({
                        ...comment,
                        bookId: bookId,
                        bookTitle: bookTitle
                    });
                });
            }
            if (allComments.length === 0) {
                adminCommentList.innerHTML = '<p>æš«ç„¡ç•™è¨€è¨˜éŒ„</p>';
                return;
            }
            // æ¸²æŸ“ç®¡ç†å¾Œå°ç•™è¨€åˆ—è¡¨
            allComments.forEach(comment => {
                const topChecked = comment.isTop ? 'checked' : '';
                adminCommentList.innerHTML += `
            <div class="record-item">
                <div>
                    <strong>${comment.bookTitle}</strong> | ${comment.content} 
                    <br>é»è®š: ${comment.likeCount} | æ™‚é–“: ${comment.time}
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <label>é ‚ç½®: <input type="checkbox" ${topChecked} onchange="toggleCommentTop('${comment.bookId}', '${comment.id}', this.checked)"></label>
                    <button class="btn-danger" onclick="deleteComment('${comment.bookId}', '${comment.id}')">åˆªé™¤</button>
                </div>
            </div>
        `;
            });
        }

        // ====== æ–°å¢ï¼šåˆ‡æ›ç•™è¨€é ‚ç½®ç‹€æ…‹ ======
        window.toggleCommentTop = async function (bookId, commentId, isTop) {
            const comments = window.libraryData.bookComments[bookId] || [];
            const comment = comments.find(c => c.id === commentId);
            if (comment) {
                comment.isTop = isTop;
                await saveData();
                loadAllComments(); // åˆ·æ–°ç®¡ç†å¾Œå°
                loadBookComments(bookId); // åˆ·æ–°å‰ç«¯ç•™è¨€
            }
        }

        // ====== æ–°å¢ï¼šåˆªé™¤ç•™è¨€ ======
        window.deleteComment = async function (bookId, commentId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç•™è¨€å—ï¼Ÿ')) return;
            // å¾æ•¸æ“šä¸­åˆªé™¤
            window.libraryData.bookComments[bookId] = window.libraryData.bookComments[bookId].filter(c => c.id !== commentId);
            // åˆªé™¤Firebaseä¸­çš„ç•™è¨€
            try {
                await deleteDoc(doc(db, "bookComments", commentId));
            } catch (err) {
                console.error("åˆªé™¤ç•™è¨€å¤±æ•—:", err);
            }
            await saveData();
            loadAllComments(); // åˆ·æ–°ç®¡ç†å¾Œå°
            loadBookComments(bookId); // åˆ·æ–°å‰ç«¯ç•™è¨€
            alert('ç•™è¨€å·²åˆªé™¤');
        }

        // ====== æ‰‹æ©Ÿç‰ˆï¼šæ‰“é–‹ç•™è¨€å½ˆçª— ======
        window.showMobileCommentModal = function (bookId) {
            const book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                alert('æœªæ‰¾åˆ°æ›¸ç±è³‡è¨Š');
                return;
            }
            document.getElementById('mobileCommentBookTitle').innerText = book.title || 'æœªçŸ¥æ›¸å';
            document.getElementById('mobileCommentBookId').value = bookId;
            loadMobileBookComments(bookId);
            // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆç•™è¨€é 
            document.querySelector('.mobile-main-content').style.display = 'none';
            document.getElementById('mobileCommentPage').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'none';
        }

        // ====== æ‰‹æ©Ÿç‰ˆï¼šåŠ è¼‰æ›¸ç±ç•™è¨€ ======
        window.loadMobileBookComments = function (bookId) {
            const commentList = document.getElementById('mobileCommentList');
            commentList.innerHTML = '';
            let comments = window.libraryData.bookComments[bookId] || [];
            comments = comments.sort((a, b) => {
                if (a.isTop && !b.isTop) return -1;
                if (!a.isTop && b.isTop) return 1;
                return b.likeCount - a.likeCount;
            });

            if (comments.length === 0) {
                commentList.innerHTML = '<p style="text-align:center; color:#6e6e73; padding:20px;">æš«ç„¡ç•™è¨€ï¼Œä¾†æ¶é¦–è©•å§ï½</p>';
                return;
            }

            comments.forEach((comment, index) => {
                const topTag = comment.isTop ? '<span class="top-tag">é ‚ç½®</span>' : '';
                commentList.innerHTML += `
            <div class="comment-item" data-comment-id="${comment.id}">
                ${topTag}
                <div class="comment-content">${comment.content}</div>
                <div class="comment-footer">
                    <span class="comment-time">${comment.time}</span>
                    <button class="comment-like-btn" onclick="commentLike('${bookId}', '${comment.id}')">
                        â¤ï¸ ${comment.likeCount || 0}
                    </button>
                </div>
            </div>
        `;
            });
        }

        // ====== æ‰‹æ©Ÿç‰ˆï¼šæäº¤ç•™è¨€ ======
        window.submitMobileComment = async function () {
            const bookId = document.getElementById('mobileCommentBookId').value;
            const content = document.getElementById('mobileCommentContent').value.trim();
            if (!content) {
                alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹ï½');
                return;
            }
            const newComment = {
                id: 'comment_' + Date.now(),
                content: content,
                likeCount: 0,
                isTop: false,
                time: new Date().toLocaleString()
            };
            if (!window.libraryData.bookComments[bookId]) {
                window.libraryData.bookComments[bookId] = [];
            }
            window.libraryData.bookComments[bookId].push(newComment);
            await saveData();
            document.getElementById('mobileCommentContent').value = '';
            loadMobileBookComments(bookId);
            alert('ç•™è¨€æˆåŠŸï¼');
        }

        // ====== æ‰‹æ©Ÿç‰ˆï¼šéš±è—æ’è¡Œæ¦œé  ======
        window.hideMobileRankingPage = function () {
            document.getElementById('mobileRankingPage').style.display = 'none';
            document.querySelector('.mobile-main-content').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'block';
        }

        // ====== æ‰‹æ©Ÿç‰ˆï¼šéš±è—ç•™è¨€é  ======
        window.hideMobileCommentPage = function () {
            document.getElementById('mobileCommentPage').style.display = 'none';
            document.querySelector('.mobile-main-content').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'block';
        }

        // ====== æ‰‹æ©Ÿç‰ˆï¼šåŠ è¼‰æ’è¡Œæ¦œ ======
        window.loadMobileRanking = function () {
            const rankedBooks = window.libraryData.allBooks.map(book => {
                return {
                    ...book,
                    likeCount: window.libraryData.bookLikes[book.id] || 0
                };
            }).filter(book => book.likeCount > 0)
                .sort((a, b) => b.likeCount - a.likeCount)
                .slice(0, 10);

            const mobileRankingList = document.getElementById('mobileRankingList');
            mobileRankingList.innerHTML = '';

            if (rankedBooks.length === 0) {
                mobileRankingList.innerHTML = '<p style="text-align:center; color:#6e6e73; padding:20px;">æš«ç„¡é»è®šæ•¸æ“šï½</p>';
                return;
            }

            rankedBooks.forEach((book, index) => {
                const randomColor = window.getRandomSoftColor();
                mobileRankingList.innerHTML += `
<div class="ranking-item" onclick="jumpToBookIssue('${book.issue}', '${book.posterNum}')">
    <span class="ranking-index" style="background: ${randomColor}">${index + 1}</span>
    <span class="ranking-bookname">${book.title}</span>
    <div style="display: flex; align-items: center; gap: 8px;">
        <!-- ç•™è¨€åœ–æ¨™ï¼šé»æ“Šæ‰“é–‹æ‰‹æ©Ÿç‰ˆç•™è¨€é  -->
        <span style="color: #ff9500; font-size: 1em; cursor: pointer;" onclick="showMobileCommentModal('${book.id}'); event.stopPropagation();">ğŸ’¬</span>
        <span class="ranking-likes">â¤ï¸ ${book.likeCount}</span>
    </div>
</div>
`;
            });
            // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆæ’è¡Œæ¦œ
            document.querySelector('.mobile-main-content').style.display = 'none';
            document.getElementById('mobileRankingPage').style.display = 'block';
            document.querySelector('.mobile-recommend-btn').style.display = 'none';
        }
        // ====== è¼ªæ’­åŠŸèƒ½ ======
        // è¼ªæ’­ç›¸é—œè®Šé‡
        let carouselBooks = [];
        let currentCarouselIndex = 0;
        let carouselInterval;
        const CAROUSEL_VISIBLE_COUNT = 5;
        const CAROUSEL_TOTAL_COUNT = 15;
        const CAROUSEL_AUTO_PLAY_INTERVAL = 5000; // 5ç§’

        // åˆå§‹åŒ–è¼ªæ’­
        function initCarousel() {
            // å…ˆæ¸…ç©ºç¾æœ‰è¼ªæ’­
            const carouselTrack = document.getElementById('carouselTrack');
            if (!carouselTrack) {
                console.log("æ‰¾ä¸åˆ°è¼ªæ’­è»Œé“å…ƒç´ ");
                return;
            }

            carouselTrack.innerHTML = '';

            // æ¸…é™¤ç¾æœ‰å®šæ™‚å™¨
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = null;
            }

            // é‡ç½®ç´¢å¼•
            currentCarouselIndex = 0;

            // å¾æ‰€æœ‰æ›¸ç±ä¸­éš¨æ©Ÿé¸å–CAROUSEL_TOTAL_COUNTæœ¬æ›¸
            const allBooks = window.libraryData.allBooks;
            if (allBooks.length === 0) {
                console.log("æ²’æœ‰æ›¸ç±æ•¸æ“šï¼Œç„¡æ³•åˆå§‹åŒ–è¼ªæ’­");
                return;
            }

            // éæ¿¾æœ‰å°é¢çš„æ›¸ç±
            const booksWithCover = allBooks.filter(book => book.cover && book.cover.trim() !== '');
            if (booksWithCover.length === 0) {
                console.log("æ²’æœ‰æ›¸ç±å°é¢ï¼Œç„¡æ³•åˆå§‹åŒ–è¼ªæ’­");
                return;
            }

            // éš¨æ©Ÿæ‰“äº‚ä¸¦é¸å–æŒ‡å®šæ•¸é‡çš„æ›¸ç±
            const shuffled = [...booksWithCover].sort(() => Math.random() - 0.5);
            carouselBooks = shuffled.slice(0, Math.min(CAROUSEL_TOTAL_COUNT, shuffled.length));
            // ç‚ºäº†å¯¦ç¾ç„¡é™è¼ªæ’­æ•ˆæœï¼Œæˆ‘å€‘å°‡å‰å¹¾æœ¬æ›¸è¤‡è£½ä¸€ä»½åŠ åˆ°é™£åˆ—æœ«å°¾
            // ç¢ºä¿è‡³å°‘æœ‰ CAROUSEL_VISIBLE_COUNT æœ¬æ›¸ç±å¯ä»¥è¼ªæ’­
            const neededBooks = Math.max(CAROUSEL_VISIBLE_COUNT, carouselBooks.length);
            const cloneCount = neededBooks;
            for (let i = 0; i < cloneCount && i < carouselBooks.length; i++) {
                carouselBooks.push(carouselBooks[i]);
            }
            // ç”Ÿæˆè¼ªæ’­é …ç›®çš„HTML
            carouselTrack.innerHTML = '';

            carouselBooks.forEach(book => {
                const item = document.createElement('div');
                item.className = 'carousel-item';
                item.dataset.bookId = book.id;
                item.innerHTML = `
            <img src="${book.cover}" alt="${book.title}">
        `;
                item.addEventListener('click', () => showCarouselBookDetail(book.id));
                carouselTrack.appendChild(item);
            });

            // é¼ æ¨™æ‡¸åœæ™‚æš«åœè‡ªå‹•è¼ªæ’­
            const carouselContainer = document.querySelector('.carousel-container');
            if (carouselContainer) {
                carouselContainer.addEventListener('mouseenter', () => {
                    if (carouselInterval) {
                        clearInterval(carouselInterval);
                        carouselInterval = null;
                    }
                });

                carouselContainer.addEventListener('mouseleave', () => {
                    startAutoCarousel();
                });
            }

            // é–‹å§‹è‡ªå‹•è¼ªæ’­
            startAutoCarousel();
        }

        // é–‹å§‹è‡ªå‹•è¼ªæ’­
        function startAutoCarousel() {
            if (carouselInterval) {
                clearInterval(carouselInterval);
            }

            carouselInterval = setInterval(() => {
                carouselNext();
            }, CAROUSEL_AUTO_PLAY_INTERVAL);
        }

        // è¼ªæ’­å‘å³åˆ‡æ›ï¼ˆå¯¦ç¾å¾ªç’°æ»¾å‹•ï¼‰
        function carouselNext() {
            if (carouselBooks.length === 0) return;

            const track = document.getElementById('carouselTrack');
            const itemWidth = 140 + 20; // å¯¬åº¦140px + é–“è·20px

            // è¨ˆç®—æ–°çš„ç´¢å¼•
            currentCarouselIndex++;

            // å¦‚æœå·²ç¶“è¶…éå¯¦éš›æ›¸ç±æ•¸é‡ï¼Œå°±è·³å›ç¬¬ä¸€æœ¬
            if (currentCarouselIndex >= carouselBooks.length) {
                currentCarouselIndex = 1; // æ³¨æ„é€™è£¡è¨­ç‚º1ï¼Œè€Œä¸æ˜¯0

                // å…ˆç¬é–“è·³åˆ°ç¬¬ä¸€æœ¬æ›¸çš„ä½ç½®ï¼ˆç„¡å‹•ç•«ï¼‰
                track.style.transition = 'none';
                track.style.transform = `translateX(0px)`;

                // å¼·åˆ¶ç€è¦½å™¨é‡æ–°è¨ˆç®—æ¨£å¼
                setTimeout(() => {
                    track.style.transition = 'transform 0.5s ease';
                    const offset = currentCarouselIndex * itemWidth;
                    track.style.transform = `translateX(-${offset}px)`;
                }, 10);
            } else {
                // æ­£å¸¸æ»¾å‹•
                const offset = currentCarouselIndex * itemWidth;
                track.style.transform = `translateX(-${offset}px)`;
            }

            // é‡ç½®è‡ªå‹•è¼ªæ’­è¨ˆæ™‚å™¨
            startAutoCarousel();
        }



        // è¼ªæ’­å‘å·¦åˆ‡æ›ï¼ˆå¯¦ç¾å¾ªç’°æ»¾å‹•ï¼‰
        function carouselPrev() {
            if (carouselBooks.length === 0) return;

            const track = document.getElementById('carouselTrack');
            const itemWidth = 140 + 20; // å¯¬åº¦140px + é–“è·20px

            // è¨ˆç®—æ–°çš„ç´¢å¼•
            currentCarouselIndex--;

            // å¦‚æœå·²ç¶“å°æ–¼0ï¼Œå°±è·³åˆ°å€’æ•¸ç¬¬äºŒæœ¬
            if (currentCarouselIndex < 0) {
                currentCarouselIndex = carouselBooks.length - 2;

                // å…ˆç¬é–“è·³è½‰åˆ°æœ€å¾Œ
                track.style.transition = 'none';
                const lastOffset = (carouselBooks.length - 1) * itemWidth;
                track.style.transform = `translateX(-${lastOffset}px)`;

                // å†å¹³æ»‘æ»¾å‹•åˆ°ç›®æ¨™ä½ç½®
                setTimeout(() => {
                    track.style.transition = 'transform 0.5s ease';
                    const offset = currentCarouselIndex * itemWidth;
                    track.style.transform = `translateX(-${offset}px)`;
                }, 10);
            } else {
                // æ­£å¸¸æ»¾å‹•
                const offset = currentCarouselIndex * itemWidth;
                track.style.transform = `translateX(-${offset}px)`;
            }

            // é‡ç½®è‡ªå‹•è¼ªæ’­è¨ˆæ™‚å™¨
            startAutoCarousel();
        }

        // é¡¯ç¤ºè¼ªæ’­æ›¸ç±è©³æƒ…
        function showCarouselBookDetail(bookId) {
            const book = window.libraryData.allBooks.find(b => b.id === bookId);
            if (!book) {
                alert('æœªæ‰¾åˆ°æ›¸ç±è³‡è¨Š');
                return;
            }

            // æ§‹å»ºæ›¸ç±è©³æƒ…å…§å®¹
            let statusText, statusClass, reserveBtn;
            if (book.status === 'in') {
                statusText = 'åœ¨æ¶ï¼ˆå¯é ç´„ï¼‰';
                statusClass = 'status-in';
                reserveBtn = `<button class="btn-primary" onclick="showReserveModal('${book.id}'); closeCarouselBookDetail()">é ç´„</button>`;
            } else if (book.status === 'out') {
                statusText = 'ä¸åœ¨æ¶';
                statusClass = 'status-out';
                reserveBtn = '';
            } else {
                statusText = 'å·²è¢«é ç´„';
                statusClass = 'status-reserved';
                reserveBtn = '';
            }

            const likeCount = window.libraryData.bookLikes[book.id] || 0;

            const detailContent = `
        <div class="carousel-book-detail">
            <div class="carousel-book-detail-header">
                <h3>${book.title}</h3>
                <button class="close-modal" onclick="closeCarouselBookDetail()">&times;</button>
            </div>
            <div class="carousel-book-detail-content">
                <div class="carousel-book-detail-cover">
                    <img src="${book.cover || ''}" alt="${book.title}" onerror="this.style.display='none'">
                </div>
                <div class="carousel-book-detail-info">
                    <p><strong>ä½œè€…:</strong> ${book.author || 'å¾…ç·¨è¼¯'}</p>
                    <p><strong>ç°¡ä»‹:</strong> ${book.intro || 'å¾…ç·¨è¼¯'}</p>
                    <p><strong>é©åˆ:</strong> ${book.suitable || 'å¾…ç·¨è¼¯'}</p>
                    <p><strong>ç´¢æ›¸è™Ÿ:</strong> ${book.callNo || 'å¾…ç·¨è¼¯'}</p>
                    <p><strong>ç‹€æ…‹:</strong> <span class="book-status ${statusClass}">${statusText}</span></p>
                    <p><strong>æœŸæ•¸:</strong> ç¬¬${book.issue}æœŸ</p>
                    <div class="carousel-book-detail-actions">
                        <button class="like-btn ${likeCount > 0 ? 'liked' : ''}" data-book-id="${book.id}" onclick="bookLike('${book.id}');">
                            ${likeCount > 0 ? 'â¤ï¸' : 'ğŸ¤'} ${likeCount}
                        </button>
                        <button class="comment-btn" onclick="closeCarouselBookDetail(); setTimeout(() => showCommentModal('${book.id}'), 300)">ğŸ’¬ ç•™è¨€</button>
                        ${reserveBtn}
                    </div>
                </div>
            </div>
        </div>
    `;

            // å‰µå»ºæˆ–æ›´æ–°å½ˆçª—
            let modal = document.getElementById('carouselBookModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'carouselBookModal';
                modal.className = 'modal carousel-book-modal hidden';
                modal.innerHTML = `
            <div class="modal-content">
                ${detailContent}
            </div>
        `;
                document.body.appendChild(modal);
            } else {
                modal.querySelector('.modal-content').innerHTML = detailContent;
            }

            // é¡¯ç¤ºå½ˆçª—
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        // é—œé–‰è¼ªæ’­æ›¸ç±è©³æƒ…å½ˆçª—
        function closeCarouselBookDetail() {
            const modal = document.getElementById('carouselBookModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }
        // ====== å…¬å‘ŠåŠŸèƒ½ ======
        // åŠ è¼‰å…¬å‘Š
        async function loadAnnouncement() {
            try {
                const announcementDoc = await getDoc(doc(db, "settings", "announcement"));
                if (announcementDoc.exists()) {
                    const announcement = announcementDoc.data();
                    if (announcement.title && announcement.content) {
                        // é¡¯ç¤ºå…¬å‘Šå½ˆçª—
                        document.getElementById('announcementTitle').textContent = announcement.title;
                        document.getElementById('announcementContent').textContent = announcement.content;
                        document.getElementById('announcementModal').style.display = 'flex';

                        // å¡«å……åˆ°ç®¡ç†å¾Œå°è¡¨å–®
                        document.getElementById('announcementTitleInput').value = announcement.title;
                        document.getElementById('announcementContentInput').value = announcement.content;
                    }
                }
            } catch (err) {
                console.error("åŠ è¼‰å…¬å‘Šå¤±æ•—:", err);
            }
        }

        // ä¿å­˜å…¬å‘Š
        window.saveAnnouncement = async function () {
            const title = document.getElementById('announcementTitleInput').value.trim();
            const content = document.getElementById('announcementContentInput').value.trim();

            if (!title || !content) {
                alert('è«‹è¼¸å…¥å…¬å‘Šæ¨™é¡Œå’Œå…§å®¹ï¼');
                return;
            }

            try {
                await setDoc(doc(db, "settings", "announcement"), {
                    title: title,
                    content: content,
                    createTime: new Date().toLocaleString()
                });
                alert('å…¬å‘Šä¿å­˜æˆåŠŸï¼');
                // é‡æ–°åŠ è¼‰å…¬å‘Šï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
                loadAnnouncement();
            } catch (err) {
                console.error("ä¿å­˜å…¬å‘Šå¤±æ•—:", err);
                alert('ä¿å­˜å…¬å‘Šå¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // åˆªé™¤å…¬å‘Š
        window.deleteAnnouncement = async function () {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤å…¬å‘Šå—ï¼Ÿåˆªé™¤å¾Œç”¨æˆ¶å°‡ä¸æœƒå†çœ‹åˆ°é€™å€‹å…¬å‘Šã€‚')) {
                return;
            }

            try {
                await deleteDoc(doc(db, "settings", "announcement"));
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('announcementTitleInput').value = '';
                document.getElementById('announcementContentInput').value = '';
                // éš±è—å…¬å‘Šå½ˆçª—
                document.getElementById('announcementModal').style.display = 'none';
                alert('å…¬å‘Šå·²åˆªé™¤ï¼');
            } catch (err) {
                console.error("åˆªé™¤å…¬å‘Šå¤±æ•—:", err);
                alert('åˆªé™¤å…¬å‘Šå¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // é—œé–‰å…¬å‘Šå½ˆçª—
        window.closeAnnouncement = function () {
            document.getElementById('announcementModal').style.display = 'none';
        }

    </script>
    <style>
        /* åŸºç¤æ¨£å¼ */
        :root {
            --primary: #0071e3;
            --secondary: #ff9500;
            --success: #34c759;
            --danger: #ff3b30;
            --gray-light: #f5f5f7;
            --gray: #e2e2e7;
            --gray-dark: #8e8e93;
            --text: #1d1d1f;
            --text-light: #6e6e73;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "SF Pro Text", "PingFang TC", "Helvetica Neue", sans-serif;
            max-width: 1440px;
            margin: 0 auto;
            color: var(--text);
            background-color: var(--gray-light);
            line-height: 1.6;
            padding-bottom: 50px;
        }

        .hidden {
            display: none !important;
        }

        button,
        input,
        select,
        textarea {
            padding: 8px 16px;
            margin: 5px;
            border: 1px solid var(--gray);
            border-radius: var(--radius);
            font-family: inherit;
            transition: var(--transition);
        }

        button {
            cursor: pointer;
            border: none;
            font-weight: 500;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-text {
            background: transparent;
            color: var(--primary);
        }

        /* é ‚éƒ¨å€åŸŸ */
        .header {
            text-align: center;
            padding: 60px 20px 40px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, rgba(245, 245, 247, 1) 100%);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: linear-gradient(90deg, #f0f0f0 1px, transparent 1px),
                linear-gradient(#f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.4;
            z-index: 1;
        }

        .header h1 {
            color: var(--text);
            margin: 10px 0 20px;
            font-weight: 600;
            font-size: clamp(2rem, 5vw, 3rem);
            /* éŸ¿æ‡‰å¼å­—é«” */
            letter-spacing: -0.02em;
            /* ç·Šæ¹Šå­—è· */
            line-height: 1.1;
            position: relative;
            z-index: 2;
            background: linear-gradient(90deg, #1d1d1f, #6e6e73);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            /* æ¼¸è®Šæ–‡å­— */
        }

        .issue-selector {
            margin: 15px 0;
        }

        /* å°èˆªæ¬„ */
        .nav-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 5;
            margin-bottom: 30px;
        }

        .nav-item {
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-item:hover {
            background: var(--gray-light);
            color: var(--primary);
        }

        /* å¯¼èˆªé¡¹æ´»è·ƒçŠ¶æ€ */
        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item.category-dropdown.active .category-trigger {
            color: white;
        }

        .keyword-search {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        .keyword-search input {
            min-width: 250px;
            background: var(--gray-light);
            border: none;
        }

        /* åˆ†é¡ä¸‹æ‹‰èœå–® */
        .category-dropdown {
            position: relative;
        }

        .category-trigger {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .category-trigger::after {
            content: "â–¼";
            font-size: 0.8em;
            opacity: 0.7;
        }

        .category-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: var(--radius);
            padding: 10px 0;
            width: 200px;
            z-index: 10;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 8px;
        }

        .category-menu.visible {
            display: block;
        }

        .category-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .category-item:hover {
            background: var(--gray-light);
            color: var(--primary);
        }

        /* æµ·å ±å€ */
        .poster-section {
            margin: 0 20px 40px;
            padding: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .poster-thumbnails {
            display: flex;
            gap: 30px;
            margin: 30px 0;
            justify-content: center;
            width: 100%;
        }

        .poster-thumb {
            flex: 1;
            max-width: 500px;
            height: auto;
            min-height: 300px;
            object-fit: contain;
            cursor: pointer;
            border-radius: var(--radius);
            background: var(--gray-light);
            padding: 20px;
            transition: var(--transition);
        }

        .poster-thumb:hover {
            transform: scale(1.02);
        }

        .poster-thumb.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-dark);
            font-size: 1.2em;
        }

        /* æµ·å ±æŒ‰éˆ•å®¹å™¨ */
        .poster-buttons-container {
            display: flex;
            gap: 20px;
            margin: 40px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* æµ·å ±æŒ‰éˆ• */
        .poster-btn {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            padding: 25px 20px;
            border: 2px solid var(--gray);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .poster-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 18px;
        }

        .poster-btn:hover::before,
        .poster-btn.active::before {
            opacity: 0.05;
        }

        .poster-btn:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(0, 113, 227, 0.15);
        }

        .poster-btn.active {
            transform: translateY(-5px) scale(1.01);
            border-color: var(--primary);
            background: linear-gradient(135deg, #f8faff 0%, #ffffff 100%);
            box-shadow: 0 15px 30px rgba(0, 113, 227, 0.1);
        }

        .poster-btn-text {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--text);
            position: relative;
            z-index: 2;
            transition: color 0.3s ease;
        }

        .poster-btn:hover .poster-btn-text,
        .poster-btn.active .poster-btn-text {
            color: var(--primary);
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            .poster-buttons-container {
                flex-direction: column;
                align-items: center;
            }

            .poster-btn {
                min-width: 100%;
                max-width: 100%;
                padding: 20px 15px;
            }

            .poster-btn:hover {
                transform: translateY(-4px) scale(1.01);
            }

            .poster-btn.active {
                transform: translateY(-2px) scale(1.005);
            }

            .poster-btn-text {
                font-size: 1.2em;
            }
        }

        /* æ›¸ç±è³‡æ–™æ ¼ï¼ˆå›ºå®š3åˆ—ï¼‰ */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* å›ºå®š3åˆ— */
            gap: 30px;
            margin: 30px 0;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .book-card {
            padding: 20px;
            border-radius: var(--radius);
            transition: var(--transition);
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        }

        .book-card[data-group="1"],
        .book-card[data-group="2"],
        .book-card[data-group="3"] {
            border-top: 3px solid var(--primary);
            /* è—è‰² */
        }

        .book-card[data-group="4"],
        .book-card[data-group="5"],
        .book-card[data-group="6"] {
            border-top: 3px solid var(--secondary);
            /* æ©˜è‰² */
        }

        .book-card[data-group="7"],
        .book-card[data-group="8"],
        .book-card[data-group="9"] {
            border-top: 3px solid var(--success);
            /* ç¶ è‰² */
        }

        .book-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
        }

        .book-cover {
            width: 100px;
            height: 150px;
            object-fit: cover;
            margin: 0 auto 20px;
            display: block;
            border-radius: 6px;
        }

        .book-title {
            text-align: center;
            margin: 10px 0 20px;
            font-size: 1.1em;
            min-height: 40px;
            font-weight: 600;
        }

        .book-card p {
            margin: 8px 0;
            font-size: 0.95em;
        }

        .book-status-bar {
            margin: 20px 0 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .book-status {
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .status-in {
            color: var(--success);
            background: rgba(52, 199, 89, 0.1);
        }

        .status-out {
            color: var(--danger);
            background: rgba(255, 59, 48, 0.1);
        }

        .status-reserved {
            color: var(--secondary);
            background: rgba(255, 149, 0, 0.1);
        }

        .reserve-btn {
            background: var(--primary);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
        }

        /* æ¨è–¦è³¼æ›¸å€ */
        .user-recommends {
            margin: 0 20px 40px;
            padding: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .recommend-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .recommend-header h3 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
        }

        .recommend-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .recommend-item {
            padding: 15px 20px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            background: white;
            display: flex;
            align-items: center;
        }

        .recommend-index {
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            margin-right: 15px;
            color: white;
            background: var(--primary);
            border-radius: 50%;
        }

        .recommend-name {
            flex: 1;
            font-weight: 500;
        }

        .recommend-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-left: 15px;
        }

        .status-recorded {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
        }

        .status-invalid {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
        }

        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: var(--secondary);
        }

        /* å½ˆçª—æ¨£å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }

        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 25px;
            cursor: pointer;
            font-size: 1.5em;
            color: var(--gray-dark);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .modal-content h3 {
            color: var(--text);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
            font-size: 1.3em;
        }

        /* é ç´„æŒ‰éˆ•é å³ */
        .reserve-submit-btn {
            display: block;
            margin-left: auto;
            margin-top: 15px;
        }

        /* ç®¡ç†å“¡å¾Œå° */
        .admin-panel {
            margin: 20px;
            padding: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .admin-panel h2 {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .form-group {
            margin: 30px 0;
            padding: 25px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            background: var(--gray-light);
        }

        .form-group h3 {
            margin-bottom: 20px;
        }

        .book-editor {
            margin: 15px 0;
            padding: 20px;
            border: 1px dashed var(--gray);
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            background: white;
            border-radius: 8px;
        }

        .record-item {
            padding: 15px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* è¼‰å…¥æç¤º */
        #loadingIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.5em;
            color: var(--primary);
        }

        /* éš±è—çš„ç®¡ç†å“¡å…¥å£ */
        .hidden-admin-entry {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            cursor: pointer;
            /* æ·»åŠ é€™è¡Œ */
            opacity: 0.5;
            z-index: 4;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            .books-grid {
                grid-template-columns: 1fr 1fr;
            }

            .poster-thumbnails {
                flex-direction: column;
            }

            .poster-thumb {
                max-width: 100%;
            }

            .nav-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .keyword-search {
                margin-left: 0;
                width: 100%;
            }

            .keyword-search input {
                width: 70%;
            }
        }

        @media (max-width: 480px) {
            .books-grid {
                grid-template-columns: 1fr;
            }

            .keyword-search input {
                width: 60%;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }

        /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
        .device-selector {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            gap: 30px;
        }

        .device-option {
            padding: 20px 40px;
            font-size: 1.2em;
            border: 2px solid var(--primary);
            border-radius: var(--radius);
            background: white;
            color: var(--primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .device-option:hover {
            background: var(--primary);
            color: white;
        }

        /* æ‰‹æ©Ÿç‰ˆå°èˆªæ¬„ */
        .mobile-nav {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: white;
            box-shadow: var(--shadow);
            z-index: 1000;
            padding: 10px 15px;
        }

        .mobile-nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-nav-left,
        .mobile-nav-center,
        .mobile-nav-right {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .mobile-nav-center {
            justify-content: center;
        }

        .mobile-nav-right {
            justify-content: flex-end;
        }

        .mobile-nav-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            padding: 8px;
            cursor: pointer;
        }

        /* æ‰‹æ©Ÿç‰ˆåˆ†é¡å…¨å±èœå–® */
        .mobile-category-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1001;
            padding: 60px 20px 20px;
            overflow-y: auto;
            display: none;
        }

        .mobile-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray);
        }

        .mobile-category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .mobile-category-item {
            padding: 15px 10px;
            text-align: center;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .mobile-category-item:hover {
            background: var(--primary);
            color: white;
        }

        /* æ‰‹æ©Ÿç‰ˆæœç´¢æ¬„ */
        .mobile-search-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 60px 15px 15px;
            z-index: 1001;
            display: none;
            box-shadow: var(--shadow);
        }

        .mobile-search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray);
            border-radius: var(--radius);
        }

        /* æ‰‹æ©Ÿç‰ˆå…§å®¹å€åŸŸ */
        .mobile-content {
            display: none;
            margin-top: 60px;
            padding: 15px;
        }

        .mobile-issue-selector {
            text-align: center;
            margin: 20px 0;
        }

        .mobile-poster-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .mobile-poster-btn {
            padding: 15px;
            border: 2px solid var(--gray);
            border-radius: var(--radius);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .mobile-poster-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        /* æ‰‹æ©Ÿç‰ˆæ›¸ç±ç¶²æ ¼ */
        .mobile-books-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .mobile-book-card {
            background: white;
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
        }

        .mobile-book-card:active {
            transform: scale(0.98);
        }

        .mobile-book-cover {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .mobile-book-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
            min-height: 40px;
        }

        .mobile-book-author {
            color: var(--text-light);
            font-size: 0.8em;
            margin-bottom: 8px;
        }

        .mobile-book-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .mobile-book-status {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 12px;
        }

        .mobile-reserve-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }

        /* æ‰‹æ©Ÿç‰ˆæ›¸ç±è©³æƒ…å½ˆçª— */
        .mobile-book-detail {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1002;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .mobile-book-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .mobile-book-detail-header h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .mobile-close-detail {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--gray-dark);
            padding: 5px;
        }

        .mobile-book-detail-content {
            background: white;
            border-radius: var(--radius);
            padding: 0;
        }

        .mobile-book-detail-cover {
            width: 120px;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin: 0 auto 20px;
            display: block;
        }

        .mobile-book-detail-title {
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
        }

        .mobile-book-detail-info {
            margin: 20px 0;
            padding: 20px;
            background: var(--gray-light);
            border-radius: var(--radius);
        }

        .mobile-book-detail-info p {
            margin: 12px 0;
            font-size: 1em;
            line-height: 1.5;
        }

        .mobile-book-detail-info strong {
            color: var(--text);
        }

        /* æ›¸ç±ç‹€æ…‹æ¨£å¼ */
        .book-status {
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .status-in {
            color: var(--success);
            background: rgba(52, 199, 89, 0.1);
        }

        .status-out {
            color: var(--danger);
            background: rgba(255, 59, 48, 0.1);
        }

        .status-reserved {
            color: var(--secondary);
            background: rgba(255, 149, 0, 0.1);
        }

        /* æ‰‹æ©Ÿç‰ˆæ¨è–¦æŒ‰éˆ• */
        .mobile-recommend-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0, 113, 227, 0.3);
            z-index: 999;
        }

        /* æ‰‹æ©Ÿç‰ˆæ¨è–¦é é¢ */
        .mobile-recommend-page {
            display: none;
            margin-top: 60px;
            padding: 15px;
        }

        .mobile-recommend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .mobile-recommend-header h3 {
            margin: 0;
        }

        .mobile-recommend-header .btn-primary {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        /* éŸ¿æ‡‰å¼é¡¯ç¤ºæ§åˆ¶ */
        @media (max-width: 768px) {
            .desktop-content {
                display: none !important;
            }

            .mobile-content {
                display: block;
            }

            .mobile-nav {
                display: block;
            }
        }

        /* æ‰‹æ©Ÿç‰ˆéš±è—ç®¡ç†å“¡å…¥å£ */
        @media (max-width: 768px) {
            .hidden-admin-entry {
                display: none !important;
            }
        }

        @media (min-width: 769px) {
            .mobile-content {
                display: none !important;
            }

            .desktop-content {
                display: block;
            }
        }

        /* æ‰‹æ©Ÿç‰ˆé ç´„é é¢ */
        .mobile-reserve-page {
            display: none;
            margin-top: 60px;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1003;
        }

        .mobile-reserve-content {
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        /* æ‰‹æ©Ÿç‰ˆé ç´„é é¢ */
        .mobile-reserve-page {
            display: none;
            margin-top: 60px;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1003;
        }

        .mobile-reserve-content {
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        /* æ‰‹æ©Ÿç‰ˆæ¨è–¦è¡¨å–®é é¢ */
        .mobile-recommend-form-page {
            display: none;
            margin-top: 60px;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1004;
        }

        .mobile-recommend-form-content {
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        /* ====== æ–°å¢ï¼šé»è®š+ç•™è¨€æ¨£å¼ï¼ˆAppleé¢¨æ ¼ï¼‰====== */
        /* æ›¸ç±é»è®šæŒ‰éˆ• */
        .like-btn {
            background: none;
            color: #ff3b30;
            border: none;
            border-radius: 50%;
            padding: 5px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .like-btn.liked {
            color: #ff3b30;
        }

        .like-btn:hover {
            transform: scale(1.1);
        }

        /* æ‰‹æ©Ÿç‰ˆé»è®šæŒ‰éˆ• */
        .mobile-like-btn {
            background: none;
            color: #ff3b30;
            border: none;
            border-radius: 50%;
            padding: 3px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mobile-like-btn.liked {
            color: #ff3b30;
        }

        .mobile-like-btn:hover {
            transform: scale(1.1);
        }

        /* ç•™è¨€æŒ‰éˆ• */
        .comment-btn {
            background: #ff9500;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 4px 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .comment-btn:hover {
            background: #ff7800;
            transform: translateY(-1px);
        }

        /* æ‰‹æ©Ÿç‰ˆç•™è¨€æŒ‰éˆ• */
        .mobile-comment-btn {
            background: #ff9500;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 3px 6px;
            font-size: 0.7em;
            cursor: pointer;
        }

        .mobile-comment-btn:hover {
            background: #ff7800;
            transform: scale(1.05);
        }

        /* ç•™è¨€å½ˆçª—æ¨£å¼ */
        .comment-modal-content {
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .comment-book-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .comment-input-area {
            margin: 20px 0;
        }

        .comment-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e2e7;
            border-radius: 8px;
            font-size: 1em;
            resize: none;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .comment-list {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment-item {
            padding: 15px;
            border: 1px solid #e2e2e7;
            border-radius: 12px;
            background: #f5f5f7;
            position: relative;
        }

        .top-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff9500;
            color: white;
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .comment-content {
            margin-bottom: 10px;
            line-height: 1.5;
            color: #1d1d1f;
        }

        .comment-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #6e6e73;
        }

        .comment-like-btn {
            background: transparent;
            border: none;
            color: #ff3b30;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .comment-like-btn:hover {
            background: #fef2f2;
        }

        /* æ’è¡Œæ¦œæ¨£å¼ */
        .ranking-section {
            margin: 0 20px 40px;
            padding: 30px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .ranking-header {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 30px;
            color: #1d1d1f;
            padding-bottom: 15px;
            border-bottom: 1px solid #f5f5f7;
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ranking-item {
            padding: 15px 20px;
            border: 1px solid #e2e2e7;
            border-radius: 12px;
            background: #f5f5f7;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ranking-item:hover {
            background: #eff0f2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .ranking-index {
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            margin-right: 15px;
            color: white;
            border-radius: 50%;
            font-weight: 600;
        }

        .ranking-bookname {
            flex: 1;
            font-weight: 500;
            color: #1d1d1f;
        }

        .ranking-likes {
            color: #ff3b30;
            font-size: 0.9em;
        }

        /* æ‰‹æ©Ÿç‰ˆæ’è¡Œæ¦œæ¨£å¼ */
        .mobile-ranking-page {
            display: none;
            margin-top: 60px;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1005;
        }

        .mobile-ranking-header {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1d1d1f;
            padding-bottom: 10px;
            border-bottom: 1px solid #f5f5f7;
        }

        /* æ‰‹æ©Ÿç‰ˆç•™è¨€é é¢ */
        .mobile-comment-page {
            display: none;
            margin-top: 60px;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1005;
        }

        .mobile-comment-content {
            height: calc(100% - 60px);
            overflow-y: auto;
            padding: 15px;
        }

        .mobile-comment-book-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .mobile-comment-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e2e7;
            border-radius: 8px;
            font-size: 1em;
            resize: none;
            min-height: 80px;
            margin-bottom: 10px;
        }

        /* å·¦ä¸Šè§’å°æ¨™é¡Œ */
        .small-header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
        }

        .small-header h1 {
            font-size: 1.8rem;
            color: var(--text);
            margin: 0;
            letter-spacing: -0.02em;
            background: linear-gradient(90deg, #1d1d1f, #6e6e73);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            white-space: nowrap;
        }

        /* è¼ªæ’­å®¹å™¨ */
        .carousel-container {
            position: relative;
            width: 100%;
            height: 280px;
            margin: 80px auto 30px;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(245, 245, 247, 0.8) 0%, rgba(255, 255, 255, 1) 100%);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-track {
            display: flex;
            transition: transform 0.5s ease;
            height: 100%;
            align-items: center;
            gap: 20px;
            padding: 0 20px;
        }

        .carousel-item {
            flex: 0 0 auto;
            width: 140px;
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .carousel-item:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            color: var(--primary);
            cursor: pointer;
            z-index: 2;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-arrow:hover {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 6px 20px rgba(0, 113, 227, 0.2);
            transform: translateY(-50%) scale(1.15);
        }

        .left-arrow {
            left: 20px;
        }

        .right-arrow {
            right: 20px;
        }

        /* æµ·å ±å€æ¨™é¡Œå’ŒæœŸæ•¸é¸æ“‡å™¨ */
        .poster-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* æ”¹ç‚ºå‘å·¦å°é½Š */
            margin: 0 20px 20px;
            padding: 0 10px;
            gap: 30px;
            /* å¢åŠ é–“è· */
        }

        .poster-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text);
        }

        .issue-selector-inline {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .issue-selector-inline label {
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
        }

        .issue-selector-inline select {
            padding: 8px 16px;
            border: 1px solid var(--gray);
            border-radius: var(--radius);
            background: white;
            color: var(--text);
            font-size: 1rem;
            min-width: 120px;
        }

        /* è¼ªæ’­æ›¸ç±è©³æƒ…å½ˆçª— */
        .carousel-book-modal .modal-content {
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            padding: 0;
        }

        .carousel-book-detail {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .carousel-book-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .carousel-book-detail-header h3 {
            margin: 0;
            font-size: 1.5em;
            color: var(--text);
        }

        .carousel-book-detail-content {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .carousel-book-detail-cover {
            flex: 0 0 200px;
            max-width: 200px;
        }

        .carousel-book-detail-cover img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .carousel-book-detail-info {
            flex: 1;
            min-width: 300px;
        }

        .carousel-book-detail-info p {
            margin: 12px 0;
            font-size: 1em;
            line-height: 1.5;
        }

        .carousel-book-detail-info strong {
            color: var(--text);
            display: inline-block;
            min-width: 60px;
        }

        .carousel-book-detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* é¼ æ¨™æ‡¸åœæ™‚æš«åœè¼ªæ’­ */
        .carousel-container:hover .carousel-arrow {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        /* ä¿®å¾©è¼ªæ’­æ›¸ç±å½ˆçª—å±¤ç´šå•é¡Œ */
        .carousel-book-modal {
            z-index: 101 !important;
            /* è¦æ¯”æ™®é€šå½ˆçª—(100)é«˜ä¸€å±¤ */
        }
    </style>
</head>

<body>
    <!-- è¨­å‚™é¸æ“‡ç•Œé¢ -->
    <div class="device-selector" id="deviceSelector">
        <h2>è«‹é¸æ“‡è¨­å‚™é¡å‹</h2>
        <button class="device-option" onclick="selectDevice('desktop')">é›»è…¦ç«¯</button>
        <button class="device-option" onclick="selectDevice('mobile')">æ‰‹æ©Ÿ/å¹³æ¿ç«¯</button>
    </div>

    <!-- è¼‰å…¥æç¤º -->
    <div id="loadingIndicator" style="display: none;">
        æ­£åœ¨è¼‰å…¥åœ–æ›¸é¤¨è³‡æ–™...
    </div>

    <!-- å…¬å‘Šå½ˆçª— -->
    <div class="modal" id="announcementModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="announcementTitle" style="margin-bottom: 20px; color: #1d1d1f; font-size: 1.3em;"></h3>
            <div id="announcementContent" style="margin-bottom: 30px; line-height: 1.6; color: #1d1d1f;"></div>
            <button class="btn-primary" onclick="closeAnnouncement()"
                style="width: 100%; padding: 10px; font-size: 1em;">çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- æ‰‹æ©Ÿç‰ˆå…§å®¹ -->
    <div class="mobile-content">
        <!-- æ‰‹æ©Ÿç‰ˆå°èˆªæ¬„ -->
        <div class="mobile-nav">
            <div class="mobile-nav-content">
                <div class="mobile-nav-left">
                    <button class="mobile-nav-btn" onclick="showMobileCategoryMenu()">â˜°</button>
                </div>
                <div class="mobile-nav-center">
                    <button class="mobile-nav-btn" onclick="scrollToTop()">æ–°æ›¸é€Ÿé</button>
                </div>
                <div class="mobile-nav-right">
                    <button class="mobile-nav-btn" onclick="loadMobileRanking()">ğŸ†</button>
                    <button class="mobile-nav-btn" onclick="showMobileSearch()">ğŸ”</button>
                </div>
            </div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆåˆ†é¡èœå–® -->
        <div class="mobile-category-menu" id="mobileCategoryMenu">
            <div class="mobile-category-header">
                <h3>æ›¸ç±åˆ†é¡</h3>
                <button class="mobile-nav-btn" onclick="hideMobileCategoryMenu()">âœ•</button>
            </div>
            <div class="mobile-category-grid">
                <div class="mobile-category-item" data-category="all">å…¨éƒ¨</div>
                <div class="mobile-category-item" data-category="000">000 ç¸½é¡</div>
                <div class="mobile-category-item" data-category="100">100 å“²å­¸</div>
                <div class="mobile-category-item" data-category="200">200 å®—æ•™</div>
                <div class="mobile-category-item" data-category="300">300 ç§‘å­¸</div>
                <div class="mobile-category-item" data-category="400">400 æ‡‰ç”¨ç§‘å­¸</div>
                <div class="mobile-category-item" data-category="500">500 ç¤¾ç§‘</div>
                <div class="mobile-category-item" data-category="600">600 æ­·å²</div>
                <div class="mobile-category-item" data-category="700">700 ä¸–ç•Œå²</div>
                <div class="mobile-category-item" data-category="800">800 èªæ–‡</div>
                <div class="mobile-category-item" data-category="900">900 è—è¡“</div>
            </div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆæœç´¢æ¬„ -->
        <div class="mobile-search-bar" id="mobileSearchBar">
            <input type="text" class="mobile-search-input" id="mobileKeywordInput" placeholder="æ›¸å/ä½œè€…/é—œéµå­—">
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button class="btn-primary" onclick="mobileSearchBooks()">æœç´¢</button>
                <button class="btn-text" onclick="hideMobileSearch()">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆä¸»å…§å®¹ -->
        <div class="mobile-main-content">
            <!-- æœŸæ•¸é¸æ“‡ -->
            <div class="mobile-issue-selector">
                <label>é¸æ“‡æœŸæ•¸: </label>
                <select id="mobileIssueSelect" onchange="mobileSwitchIssue(this.value)">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </select>
                <button class="btn-text" onclick="mobileShowLatestIssue()">æœ€æ–°ä¸€æœŸ</button>
            </div>

            <!-- æµ·å ±æŒ‰éˆ• -->
            <div class="mobile-poster-buttons">
                <button class="mobile-poster-btn active" data-poster="1"
                    onclick="mobileRenderBooks(window.mobileCurrentIssue, 1); setActiveMobilePoster(this)">
                    æµ·å ± 1
                </button>
                <button class="mobile-poster-btn" data-poster="2"
                    onclick="mobileRenderBooks(window.mobileCurrentIssue, 2); setActiveMobilePoster(this)">
                    æµ·å ± 2
                </button>
            </div>

            <!-- æ›¸ç±ç¶²æ ¼ -->
            <div class="mobile-books-grid" id="mobileBooksContainer">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ¨è–¦æŒ‰éˆ• -->
        <button class="mobile-recommend-btn" onclick="showMobileRecommendPage()">æ¨è–¦æ–°æ›¸</button>

        <!-- æ›¸ç±è©³æƒ…å½ˆçª— -->
        <div class="mobile-book-detail" id="mobileBookDetail">
            <div class="mobile-book-detail-content" id="mobileBookDetailContent">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆé ç´„é é¢ -->
        <div class="mobile-reserve-page" id="mobileReservePage">
            <div class="mobile-nav">
                <div class="mobile-nav-content">
                    <div class="mobile-nav-left">
                        <button class="mobile-nav-btn" onclick="hideMobileReservePage()">â† å›ä¸Šé </button>
                    </div>
                    <div class="mobile-nav-center">
                        <span>é ç´„æ›¸ç±</span>
                    </div>
                    <div class="mobile-nav-right">
                        <!-- ç©ºç™½ -->
                    </div>
                </div>
            </div>

            <div class="mobile-reserve-content" style="padding: 20px;">
                <div id="mobileReserveBookInfo"
                    style="background: #f5f5f7; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <!-- æ›¸ç±è³‡è¨Šå°‡å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">ç­ç´š:</label>
                    <input type="text" id="mobileClassName" placeholder="è«‹è¼¸å…¥ç­ç´š"
                        style="width: 100%; padding: 12px; border: 1px solid #e2e2e7; border-radius: 8px;">
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">å§“å:</label>
                    <input type="text" id="mobileStudentName" placeholder="è«‹è¼¸å…¥å§“å"
                        style="width: 100%; padding: 12px; border: 1px solid #e2e2e7; border-radius: 8px;">
                </div>

                <button class="btn-primary" onclick="submitMobileReserve()"
                    style="width: 100%; padding: 15px; font-size: 1.1em;">æäº¤é ç´„</button>

                <input type="hidden" id="mobileReserveBookId">
            </div>
        </div>


        <!-- æ‰‹æ©Ÿç‰ˆæ¨è–¦è¡¨å–®é é¢ -->
        <div class="mobile-recommend-form-page" id="mobileRecommendFormPage">
            <div class="mobile-nav">
                <div class="mobile-nav-content">
                    <div class="mobile-nav-left">
                        <button class="mobile-nav-btn" onclick="hideMobileRecommendFormPage()">â† å›ä¸Šé </button>
                    </div>
                    <div class="mobile-nav-center">
                        <span>æ¨è–¦æ–°æ›¸</span>
                    </div>
                    <div class="mobile-nav-right">
                        <!-- ç©ºç™½ -->
                    </div>
                </div>
            </div>

            <div class="mobile-recommend-form-content" style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ›¸å:</label>
                    <input type="text" id="mobileRecommendBookName" placeholder="è«‹è¼¸å…¥æ›¸å"
                        style="width: 100%; padding: 12px; border: 1px solid #e2e2e7; border-radius: 8px;">
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ¨è–¦ç†ç”±,å¯å¡«[ç„¡]:</label>
                    <textarea id="mobileRecommendReason" placeholder="è«‹è¼¸å…¥æ¨è–¦ç†ç”±"
                        style="width: 100%; padding: 12px; border: 1px solid #e2e2e7; border-radius: 8px; height: 120px;"></textarea>
                </div>

                <button class="btn-primary" onclick="submitMobileRecommend()"
                    style="width: 100%; padding: 15px; font-size: 1.1em;">æäº¤æ¨è–¦</button>
            </div>
        </div>



        <!-- æ‰‹æ©Ÿç‰ˆæ¨è–¦é é¢ -->
        <div class="mobile-recommend-page" id="mobileRecommendPage">
            <div class="mobile-nav">
                <div class="mobile-nav-content">
                    <div class="mobile-nav-left">
                        <button class="mobile-nav-btn" onclick="hideMobileRecommendPage()">â† å›ä¸Šé </button>
                    </div>
                    <div class="mobile-nav-center">
                        <span>æ–°æ›¸æ¨è–¦</span>
                    </div>
                    <div class="mobile-nav-right">
                        <!-- åˆªé™¤åŠ è™ŸæŒ‰éˆ• -->
                    </div>
                </div>
            </div>

            <div class="mobile-recommend-header">
                <h3>å¤§å®¶æ¨è–¦çš„æ–°æ›¸</h3>
                <button class="btn-primary" onclick="showMobileRecommendFormPage()">æˆ‘è¦æ¨è–¦</button>
            </div>

            <div class="recommend-list" id="mobileUserRecommendList">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ–°å¢ï¼šæ‰‹æ©Ÿç‰ˆæ’è¡Œæ¦œé é¢ -->
        <div class="mobile-ranking-page" id="mobileRankingPage">
            <div class="mobile-nav">
                <div class="mobile-nav-content">
                    <div class="mobile-nav-left">
                        <button class="mobile-nav-btn" onclick="hideMobileRankingPage()">â† å›ä¸Šé </button>
                    </div>
                    <div class="mobile-nav-center">
                        <span>ç†±é–€æ’è¡Œæ¦œ</span>
                    </div>
                    <div class="mobile-nav-right">
                        <!-- ç©ºç™½ -->
                    </div>
                </div>
            </div>

            <div class="mobile-ranking-header">æŒ‰è®šç‡æœ€é«˜ç†±é–€æ–°æ›¸<span
                    style="font-size:0.8em; color:#8e8e93; margin-left:8px;">ï¼ˆé»æ“Šæ›¸åæŸ¥çœ‹è©³æƒ…ï¼‰</span></div>
            <div class="ranking-list" id="mobileRankingList">
                <!-- æ’è¡Œæ¦œå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ–°å¢ï¼šæ‰‹æ©Ÿç‰ˆç•™è¨€é é¢ -->
        <div class="mobile-comment-page" id="mobileCommentPage">
            <div class="mobile-nav">
                <div class="mobile-nav-content">
                    <div class="mobile-nav-left">
                        <button class="mobile-nav-btn" onclick="hideMobileCommentPage()">â† å›ä¸Šé </button>
                    </div>
                    <div class="mobile-nav-center">
                        <span>æ›¸ç±ç•™è¨€</span>
                    </div>
                    <div class="mobile-nav-right">
                        <!-- ç©ºç™½ -->
                    </div>
                </div>
            </div>

            <div class="mobile-comment-content">
                <div class="mobile-comment-book-title" id="mobileCommentBookTitle">æ›¸ç±ç•™è¨€</div>
                <div class="comment-input-area">
                    <textarea id="mobileCommentContent" class="mobile-comment-input" placeholder="è¼¸å…¥ä½ çš„ç•™è¨€..."></textarea>
                    <button class="btn-primary" onclick="submitMobileComment()">æäº¤ç•™è¨€</button>
                </div>
                <div id="mobileCommentList" class="comment-list">
                    <!-- ç•™è¨€åˆ—è¡¨å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <input type="hidden" id="mobileCommentBookId">
            </div>
        </div>


    </div> <!-- çµæŸæ•´å€‹ mobile-content -->


    <!-- é›»è…¦ç‰ˆå…§å®¹é–‹å§‹ -->
    <div class="desktop-content">
        <!-- å·¦ä¸Šè§’å°æ¨™é¡Œ -->
        <div class="small-header">
            <h1>ä¸­å­¸åœ–æ›¸é¤¨ | æ¯é€±æ–°æ›¸é€Ÿé</h1>
        </div>

        <!-- è¼ªæ’­å€åŸŸ -->
        <div class="carousel-container">
            <button class="carousel-arrow left-arrow" onclick="carouselPrev()">â€¹</button>
            <div class="carousel-track" id="carouselTrack">
                <!-- å‹•æ…‹ç”Ÿæˆè¼ªæ’­é …ç›® -->
            </div>
            <button class="carousel-arrow right-arrow" onclick="carouselNext()">â€º</button>
        </div>

        <!-- æµ·å ±å€æ¨™é¡Œå’ŒæœŸæ•¸é¸æ“‡å™¨ -->
        <div class="poster-header">
            <h2 id="currentIssueTitle">ç¬¬1æœŸæµ·å ±</h2>
            <div class="issue-selector-inline">
                <label>é¸æ“‡æœŸæ•¸: </label>
                <select id="issueSelect" onchange="switchIssue(this.value)">
                    <option value="1">ç¬¬1æœŸ</option>
                </select>
            </div>
        </div>


        <!-- å°èˆªæ¬„ -->
        <div class="nav-bar">
            <div class="nav-item" onclick="showLatestIssue(); setActiveNav(this)">æœ€æ–°ä¸€æœŸ</div>
            <div class="nav-item category-dropdown" onclick="setActiveNav(this)">
                <span class="category-trigger">åˆ†é¡</span>
                <div class="category-menu" id="categoryMenu">
                    <div class="category-item" data-category="all">å…¨éƒ¨</div>
                    <div class="category-item" data-category="000">000 ç¸½é¡</div>
                    <div class="category-item" data-category="100">100 å“²å­¸</div>
                    <div class="category-item" data-category="200">200 å®—æ•™</div>
                    <div class="category-item" data-category="300">300 ç§‘å­¸</div>
                    <div class="category-item" data-category="400">400 æ‡‰ç”¨ç§‘å­¸</div>
                    <div class="category-item" data-category="500">500 ç¤¾ç§‘</div>
                    <div class="category-item" data-category="600">600 æ­·å²</div>
                    <div class="category-item" data-category="700">700 ä¸–ç•Œå²</div>
                    <div class="category-item" data-category="800">800 èªæ–‡</div>
                    <div class="category-item" data-category="900">900 è—è¡“</div>
                </div>
            </div>
            <div class="nav-item" onclick="showSection('userRecommendsSection'); setActiveNav(this)">æ¨è–¦è³¼æ›¸</div>
            <div class="nav-item" onclick="loadRanking(); setActiveNav(this)">æ’è¡Œæ¦œ</div>
            <div class="keyword-search">
                <label>é—œéµè©: </label>
                <input type="text" id="keywordInput" placeholder="è¼¸å…¥æ›¸å/ä½œè€…/ç´¢æ›¸è™Ÿ...">
                <button onclick="searchBooks()">æœç´¢</button>
            </div>
        </div>

        <!-- æ¨è–¦è³¼æ›¸å±•ç¤ºå€ -->
        <div class="user-recommends content-section hidden" id="userRecommendsSection">
            <div class="recommend-header">
                <h3>å¤§å®¶æ¨è–¦çš„æ›¸ç±</h3>
                <button class="btn-primary" onclick="showRecommendForm()">æˆ‘è¦æ–°æ›¸</button>
            </div>
            <div class="recommend-list" id="userRecommendList">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ–°å¢ï¼šæ’è¡Œæ¦œå±•ç¤ºå€ -->
        <div class="ranking-section content-section hidden" id="rankingSection">
            <div class="ranking-header">æŒ‰è®šç‡æœ€é«˜ç†±é–€æ–°æ›¸<span
                    style="font-size:0.8em; color:#8e8e93; margin-left:8px;">ï¼ˆé»æ“Šæ›¸åæŸ¥çœ‹è©³æƒ…ï¼‰</span></div>
            <div class="ranking-list" id="rankingList">
                <!-- æ’è¡Œæ¦œå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        <!-- æµ·å ±å€ -->
        <div class="poster-section content-section" id="posterSection">
            <p style="color: var(--gray-dark); font-size: 0.9em; margin-bottom: 20px;">
                é»æ“ŠæŒ‰éˆ•åˆ‡æ›æ›¸ç±è³‡è¨Šï¼Œä¸Šé¢ä¸‹æ‹‰é¸å–®åˆ‡æ›æœŸæ•¸
            </p>
            <div class="poster-buttons-container" id="posterButtonsContainer">
                <button class="poster-btn active" data-poster="1"
                    onclick="renderBooks(window.currentIssue, 1); setActivePoster(this)">
                    <span class="poster-btn-text">æµ·å ± 1</span>
                </button>
                <button class="poster-btn" data-poster="2"
                    onclick="renderBooks(window.currentIssue, 2); setActivePoster(this)">
                    <span class="poster-btn-text">æµ·å ± 2</span>
                </button>
            </div>
            <div id="booksContainer" class="books-grid">
                <!-- æ›¸ç±å¡ç‰‡å°‡å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é ç´„å½ˆçª— -->
        <div class="modal hidden" id="reserveModal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeAllModals()">&times;</span>
                <h3>é ç´„æ›¸ç±</h3>
                <div id="bookReserveInfo"></div>
                <div class="form-group">
                    <label>ç­ç´š: </label>
                    <input type="text" id="className" required>
                </div>
                <div class="form-group">
                    <label>å§“å: </label>
                    <input type="text" id="studentName" required>
                </div>
                <button type="button" onclick="submitReserve()" class="reserve-submit-btn btn-primary">æäº¤é ç´„</button>
                <input type="hidden" id="reserveBookId">
            </div>
        </div>

        <!-- æ¨è–¦è³¼æ›¸å½ˆçª— -->
        <div class="modal hidden" id="recommendModal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeAllModals()">&times;</span>
                <h3>æ¨è–¦è³¼è²·æ›¸ç±</h3>
                <div class="form-group">
                    <label>æ›¸å: </label>
                    <input type="text" id="recommendBookName" required>
                </div>
                <div class="form-group">
                    <label>æ¨è–¦ç†ç”±,å¯å¡«[ç„¡]: </label>
                    <textarea id="recommendReason" required></textarea>
                </div>
                <button type="button" onclick="submitRecommend()" class="btn-primary">æäº¤æ¨è–¦</button>
            </div>
        </div>

        <!-- ç®¡ç†å“¡ç™»éŒ„å½ˆçª— -->
        <div class="modal hidden" id="adminLoginModal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeAllModals()">&times;</span>
                <h3>ç®¡ç†å“¡ç™»éŒ„</h3>
                <div class="form-group">
                    <label>è³¬è™Ÿ: </label>
                    <input type="text" id="adminUser" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç¢¼: </label>
                    <input type="password" id="adminPass" required>
                </div>
                <button type="button" onclick="adminLogin()" class="btn-primary">ç™»éŒ„</button>
            </div>
        </div>

        <!-- æ–°å¢ï¼šç•™è¨€å½ˆçª— -->
        <div class="modal hidden" id="commentModal">
            <div class="modal-content comment-modal-content">
                <span class="close-modal" onclick="closeAllModals()">&times;</span>
                <h3 class="comment-book-title" id="commentBookTitle">æ›¸ç±ç•™è¨€</h3>
                <div class="comment-input-area">
                    <textarea id="commentContent" class="comment-input" placeholder="è¼¸å…¥ä½ çš„ç•™è¨€..."></textarea>
                    <button class="btn-primary" onclick="submitComment()">æäº¤ç•™è¨€</button>
                </div>
                <div id="commentList" class="comment-list">
                    <!-- ç•™è¨€åˆ—è¡¨å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <input type="hidden" id="commentBookId">
            </div>
        </div>

        <!-- ç®¡ç†å“¡å¾Œå° -->
        <div class="admin-panel hidden" id="adminPanel">
            <h2>ç®¡ç†å“¡å¾Œå°</h2>
            <button onclick="logoutAdmin()" class="btn-text">é€€å‡ºç™»éŒ„</button>

            <!-- 1. æœŸæ•¸ç®¡ç† -->
            <div class="form-group">
                <h3>1. æœŸæ•¸ç®¡ç†</h3>
                <button class="btn-primary" onclick="addNewIssue()">æ–°å¢æœŸæ•¸</button>
            </div>

            <!-- 2. æµ·å ±ç®¡ç† -->
            <div class="form-group">
                <h3>2. æµ·å ±ç®¡ç†</h3>
                <p>æµ·å ±åŠŸèƒ½å·²æ”¹ç‚ºæŒ‰éˆ•åˆ‡æ›ï¼Œç„¡éœ€ä¸Šå‚³åœ–ç‰‡</p>
                <div>
                    <label>é¸æ“‡è¦åˆªé™¤çš„æœŸæ•¸: </label>
                    <select id="deleteIssueSelect">
                        <option value="1">ç¬¬1æœŸ</option>
                    </select>
                    <button class="btn-danger" onclick="deleteWholeIssue()">åˆªé™¤æ•´æœŸ</button>
                </div>
            </div>
            <!-- 3. æ›¸ç±è³‡è¨Šç·¨è¼¯ -->
            <div class="form-group">
                <h3>3. æ›¸ç±è³‡è¨Šç®¡ç†</h3>
                <div>
                    <label>é¸æ“‡æœŸæ•¸: </label>
                    <select id="bookIssueSelect">
                        <option value="1">ç¬¬1æœŸ</option>
                    </select>
                    <label>é¸æ“‡æµ·å ±åºè™Ÿ: </label>
                    <select id="bookPosterSelect">
                        <option value="1">æµ·å ±1</option>
                        <option value="2">æµ·å ±2</option>
                    </select>
                    <label>é¸æ“‡æ›¸ç±åºè™Ÿ: </label>
                    <select id="bookNumSelect">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                    </select>
                </div>

                <div class="book-editor">
                    <input type="text" id="bookCallNo" placeholder="ç´¢æ›¸è™Ÿ">
                    <input type="text" id="bookTitle" placeholder="æ›¸å">
                    <label>åˆ†é¡ä»£ç¢¼: </label>
                    <select id="bookClassCode">
                        <option value="000">000 ç¸½é¡</option>
                        <option value="100">100 å“²å­¸</option>
                        <option value="200">200 å®—æ•™</option>
                        <option value="300">300 ç§‘å­¸</option>
                        <option value="400">400 æ‡‰ç”¨ç§‘å­¸</option>
                        <option value="500">500 ç¤¾ç§‘</option>
                        <option value="600">600 æ­·å²</option>
                        <option value="700">700 ä¸–ç•Œå²</option>
                        <option value="800">800 èªæ–‡</option>
                        <option value="900">900 è—è¡“</option>
                    </select>
                    <input type="text" id="bookAuthor" placeholder="ä½œè€…">
                    <textarea id="bookIntro" placeholder="ç°¡ä»‹"></textarea>
                    <input type="text" id="bookSuitable" placeholder="é©åˆäººç¾¤">
                    <select id="bookStatus">
                        <option value="in">åœ¨æ¶ï¼ˆå¯é ç´„ï¼‰</option>
                        <option value="out">ä¸åœ¨æ¶</option>
                        <option value="lost">éºå¤±</option> <!-- æ–°å¢é€™è¡Œ -->
                    </select>
                    <input type="file" id="bookCoverUpload" accept="image/*">
                    <button class="btn-primary" onclick="saveBookInfo()">å„²å­˜æ›¸ç±</button>
                    <button class="btn-danger" onclick="deleteBookInfo()">åˆªé™¤æ›¸ç±</button>
                </div>
            </div>

            <!-- 4. é ç´„è¨˜éŒ„ç®¡ç† -->
            <div class="form-group">
                <h3>4. é ç´„è¨˜éŒ„ç®¡ç†</h3>
                <div id="reserveRecordsContainer">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- 5. æ¨è–¦è³¼æ›¸è¨˜éŒ„ç®¡ç† -->
            <div class="form-group">
                <h3>5. æ¨è–¦è³¼æ›¸è¨˜éŒ„ç®¡ç†</h3>
                <div id="recommendRecordsContainer">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- 6. ç•™è¨€ç®¡ç† -->
            <div class="form-group">
                <h3>6. ç•™è¨€ç®¡ç†</h3>
                <button class="btn-primary" onclick="loadAllComments()">åŠ è¼‰æ‰€æœ‰ç•™è¨€</button>
                <div id="adminCommentList" style="margin-top:20px;">
                    <!-- ç•™è¨€åˆ—è¡¨å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- 7. å…¬å‘Šç®¡ç† -->
            <div class="form-group">
                <h3>7. å…¬å‘Šç®¡ç†</h3>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">å…¬å‘Šæ¨™é¡Œ:</label>
                    <input type="text" id="announcementTitleInput" placeholder="è¼¸å…¥å…¬å‘Šæ¨™é¡Œ"
                        style="width: 100%; padding: 10px; margin: 5px 0;">

                    <label style="display: block; margin-bottom: 8px; font-weight: 500; margin-top: 15px;">å…¬å‘Šå…§å®¹:</label>
                    <textarea id="announcementContentInput" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹"
                        style="width: 100%; padding: 10px; margin: 5px 0; min-height: 100px;"></textarea>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn-primary" onclick="saveAnnouncement()">ä¿å­˜å…¬å‘Š</button>
                        <button class="btn-danger" onclick="deleteAnnouncement()">åˆªé™¤å…¬å‘Š</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- éš±è—çš„ç®¡ç†å“¡å…¥å£ï¼ˆåƒ…é›»è…¦ç‰ˆé¡¯ç¤ºï¼‰ -->
        <div class="hidden-admin-entry desktop-only" onclick="showAdminLogin();"
            style="width: 40px; height: 40px; background: #f5f5f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0.3; z-index: 9999; position: fixed; bottom: 10px; right: 10px; cursor: pointer;">
            Â®
        </div>
    </div>
</body>

</html>