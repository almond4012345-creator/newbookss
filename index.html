<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XX中学图书馆 | 每周新书速递</title>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCP9snpj1ot0dwfUaNxQV26LDjFTpLwMcc",
            authDomain: "newbookf-a73de.firebaseapp.com",
            projectId: "newbookf-a73de",
            storageBucket: "newbookf-a73de.firebasestorage.app",
            messagingSenderId: "170910643508",
            appId: "1:170910643508:web:0f69a51175386e2e9fa161"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 全局数据存储
        let libraryData = {
            issues: {},
            categories: [], // 移除原有分类
            reserveRecords: [],
            recommendRecords: [],
            latestIssue: 1,
            allBooks: [] // 存储所有书籍用于全局检索
        };

        // 从Firebase加载数据
        async function loadData() {
            // 加载期数数据
            const issuesCol = collection(db, "issues");
            const issuesSnapshot = await getDocs(issuesCol);
            libraryData.issues = {};
            issuesSnapshot.forEach(doc => {
                libraryData.issues[doc.id] = doc.data();
            });

            // 加载预约记录
            const reservesCol = collection(db, "reserves");
            const reservesSnapshot = await getDocs(reservesCol);
            libraryData.reserveRecords = [];
            reservesSnapshot.forEach(doc => {
                let data = doc.data();
                data.id = doc.id;
                libraryData.reserveRecords.push(data);
            });

            // 加载推荐记录
            const recommendsCol = collection(db, "recommends");
            const recommendsSnapshot = await getDocs(recommendsCol);
            libraryData.recommendRecords = [];
            recommendsSnapshot.forEach(doc => {
                let data = doc.data();
                data.id = doc.id;
                libraryData.recommendRecords.push(data);
            });

            // 加载系统设置
            const settingsCol = collection(db, "settings");
            const settingsSnapshot = await getDocs(settingsCol);
            if (!settingsSnapshot.empty) {
                libraryData.latestIssue = settingsSnapshot.docs[0].data().latestIssue || 1;
            } else {
                await setDoc(doc(db, "settings", "system"), {
                    latestIssue: 1
                });
            }

            // 收集所有书籍用于全局检索
            collectAllBooks();
            
            // 初始化页面
            init();
        }

        // 收集所有书籍
        function collectAllBooks() {
            libraryData.allBooks = [];
            for (const issue in libraryData.issues) {
                const issueData = libraryData.issues[issue];
                for (const posterNum in issueData.books) {
                    const books = issueData.books[posterNum];
                    for (const bookNum in books) {
                        const book = { ...books[bookNum] };
                        book.issue = issue;
                        book.posterNum = posterNum;
                        book.bookNum = bookNum;
                        book.id = `${issue}-${posterNum}-${bookNum}`;
                        libraryData.allBooks.push(book);
                    }
                }
            }
        }

        // 保存数据到Firebase
        async function saveData() {
            for (const issueId in libraryData.issues) {
                await setDoc(doc(db, "issues", issueId), libraryData.issues[issueId]);
            }

            await setDoc(doc(db, "settings", "system"), {
                latestIssue: libraryData.latestIssue
            });
            
            // 更新所有书籍列表
            collectAllBooks();
        }

        // 保存单条预约记录
        async function saveReserveRecord(record) {
            const newDoc = doc(collection(db, "reserves"));
            record.id = newDoc.id;
            await setDoc(newDoc, record);
            libraryData.reserveRecords.push(record);
            renderReserveRecords();
            
            // 更新书籍状态为"已被预约"
            const [issue, posterNum, bookNum] = record.bookId.split('-');
            if (libraryData.issues[issue]?.books[posterNum]?.[bookNum]) {
                libraryData.issues[issue].books[posterNum][bookNum].status = 'reserved';
                await saveData();
                renderCurrentView(); // 刷新当前视图
            }
        }

        // 更新预约记录状态
        async function updateReserveStatus(index, status) {
            const record = libraryData.reserveRecords[index];
            record.status = status;
            await updateDoc(doc(db, "reserves", record.id), {
                status: status
            });
            
            // 如果状态变为"已还书"，恢复书籍可预约状态
            if (status === '已还书') {
                const [issue, posterNum, bookNum] = record.bookId.split('-');
                if (libraryData.issues[issue]?.books[posterNum]?.[bookNum]) {
                    libraryData.issues[issue].books[posterNum][bookNum].status = 'in';
                    await saveData();
                    renderCurrentView();
                }
            }
        }

        // 保存单条推荐记录
        async function saveRecommendRecord(record) {
            const newDoc = doc(collection(db, "recommends"));
            record.id = newDoc.id;
            await setDoc(newDoc, record);
            libraryData.recommendRecords.push(record);
            renderRecommendRecords();
        }

        // 更新推荐记录状态
        async function updateRecommendStatus(index, status) {
            const record = libraryData.recommendRecords[index];
            record.status = status;
            await updateDoc(doc(db, "recommends", record.id), {
                status: status
            });
            renderUserRecommendList(); // 刷新用户端推荐列表
        }

        // 删除整期数据
        async function deleteWholeIssue(issue) {
            await deleteDoc(doc(db, "issues", issue.toString()));
            delete libraryData.issues[issue];
            collectAllBooks();
        }

        // 初始化页面
        function init() {
            renderIssueSelectors();
            showLatestIssue();
            initCategoryDropdown();
            renderUserRecommendList();
        }

        // 初始化期数选择器
        function renderIssueSelectors() {
            const issueNumbers = Object.keys(libraryData.issues).map(Number).sort((a, b) => a - b);
            const userSelector = document.getElementById('issueSelect');
            const posterSelector = document.getElementById('posterIssueSelect');
            const bookSelector = document.getElementById('bookIssueSelect');
            
            userSelector.innerHTML = '';
            posterSelector.innerHTML = '';
            bookSelector.innerHTML = '';
            
            issueNumbers.forEach(issue => {
                const option = `<option value="${issue}">第${issue}期</option>`;
                userSelector.innerHTML += option;
                posterSelector.innerHTML += option;
                bookSelector.innerHTML += option;
            });
            
            userSelector.value = libraryData.latestIssue;
            posterSelector.value = libraryData.latestIssue;
            bookSelector.value = libraryData.latestIssue;
        }

        // 切换期数
        function switchIssue(issue) {
            const issueNum = Number(issue);
            document.getElementById('currentIssueTitle').textContent = `第${issueNum}期海报`;
            renderPosterThumbs(issueNum);
            renderBooks(issueNum, 1);
            showSection('posterSection');
        }

        // 显示最新一期
        function showLatestIssue() {
            switchIssue(libraryData.latestIssue);
            document.getElementById('issueSelect').value = libraryData.latestIssue;
        }

        // 初始化分类下拉菜单
        function initCategoryDropdown() {
            const trigger = document.querySelector('.category-trigger');
            const menu = document.getElementById('categoryMenu');
            let isFixed = false;

            trigger.addEventListener('mouseenter', () => {
                if (!isFixed) menu.classList.add('visible');
            });

            menu.addEventListener('mouseleave', () => {
                if (!isFixed) menu.classList.remove('visible');
            });

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                isFixed = !isFixed;
                menu.classList.toggle('visible', isFixed);
            });

            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', () => {
                    const category = item.dataset.category;
                    filterByCategory(category);
                });
            });

            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target) && e.target !== trigger) {
                    isFixed = false;
                    menu.classList.remove('visible');
                }
            });
        }

        // 分类筛选（全局所有书籍）
        function filterByCategory(category) {
            const allBooks = libraryData.allBooks;
            const booksContainer = document.getElementById('booksContainer');
            booksContainer.innerHTML = '';
            
            // 按类别筛选
            const filteredBooks = category === 'all' 
                ? allBooks 
                : allBooks.filter(book => book.classCode === category);
            
            // 按3个一组显示
            let groupIndex = 0;
            filteredBooks.forEach((book, index) => {
                if (index % 3 === 0) {
                    groupIndex++;
                }
                
                const card = createBookCard(book);
                card.dataset.group = groupIndex;
                booksContainer.appendChild(card);
            });
            
            showSection('posterSection');
            document.getElementById('currentIssueTitle').textContent = 
                category === 'all' ? '全部书籍' : `${category} 分类书籍`;
        }

        // 显示用户推荐区
        function showUserRecommends() {
            renderUserRecommendList();
            showSection('userRecommendsSection');
        }

        // 渲染用户推荐列表
        function renderUserRecommendList() {
            const list = document.getElementById('userRecommendList');
            list.innerHTML = '';

            // 按时间倒序排列
            const sortedRecommends = [...libraryData.recommendRecords]
                .sort((a, b) => new Date(b.time) - new Date(a.time));

            if (sortedRecommends.length === 0) {
                list.innerHTML = '<p>暂无推荐记录</p>';
            } else {
                sortedRecommends.forEach((r, index) => {
                    let statusText = '';
                    let statusClass = '';
                    
                    switch(r.status) {
                        case '已推荐':
                            statusText = '推荐中';
                            statusClass = 'status-pending';
                            break;
                        case '已记录':
                            statusText = '已记录';
                            statusClass = 'status-recorded';
                            break;
                        case '不合規定':
                            statusText = '不合规定';
                            statusClass = 'status-invalid';
                            break;
                    }
                    
                    list.innerHTML += `
                        <div class="recommend-item">
                            <span class="recommend-index">${index + 1}</span>
                            <span class="recommend-name">${r.bookName}</span>
                            <span class="recommend-status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                });
            }
        }

        // 海报管理相关
        function updatePosterNumSelect() {
            const issue = document.getElementById('posterIssueSelect').value;
            renderPosterThumbs(issue);
        }

        // 渲染海报缩略图（自动适应窗口）
        function renderPosterThumbs(issue) {
            const container = document.getElementById('posterThumbContainer');
            container.innerHTML = '';
            
            for (let i = 1; i <= 2; i++) {
                const posterUrl = libraryData.issues[issue]?.posters[i] || '';
                if (posterUrl) {
                    container.innerHTML += `
                        <img src="${posterUrl}" class="poster-thumb" data-poster="${i}">
                    `;
                } else {
                    container.innerHTML += `
                        <div class="poster-thumb placeholder" data-poster="${i}">
                            海报${i}<br>[暂未上传]
                        </div>
                    `;
                }
            }

            // 点击海报显示对应书籍
            document.querySelectorAll('.poster-thumb').forEach(thumb => {
                thumb.addEventListener('click', function() {
                    const posterNum = this.dataset.poster;
                    renderBooks(issue, posterNum);
                });
            });
        }

        // 上传/更新海报
        function uploadPoster() {
            const issue = document.getElementById('posterIssueSelect').value;
            const num = document.getElementById('posterNumSelect').value;
            const fileInput = document.getElementById('posterUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showWarning('posterWarning', '请选择要上传的海报图片');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showWarning('posterWarning', '请上传图片格式（PNG/JPG等）');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!libraryData.issues[issue]) {
                    libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
                }
                libraryData.issues[issue].posters[num] = e.target.result;
                saveData();
                showWarning('posterWarning', '海报上传成功', 'green');
                renderPosterThumbs(issue);
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        // 删除单张海报
        function deleteSinglePoster() {
            const issue = document.getElementById('posterIssueSelect').value;
            const num = document.getElementById('posterNumSelect').value;
            
            if (!libraryData.issues[issue] || !libraryData.issues[issue].posters[num]) {
                showWarning('posterWarning', '该海报不存在');
                return;
            }
            
            if (confirm(`确定要删除第${issue}期第${num}张海报吗？`)) {
                libraryData.issues[issue].posters[num] = '';
                saveData();
                renderPosterThumbs(issue);
                showWarning('posterWarning', '海报已删除', 'green');
            }
        }

        // 删除整期海报
        async function deleteWholeIssueHandler() {
            const issue = document.getElementById('posterIssueSelect').value;
            if (!libraryData.issues[issue]) {
                showWarning('posterWarning', '该期不存在');
                return;
            }
            
            if (confirm(`确定要删除第${issue}期所有海报和书籍吗？此操作不可恢复！`)) {
                await deleteWholeIssue(issue);
                const issues = Object.keys(libraryData.issues).map(Number).sort((a, b) => b - a);
                libraryData.latestIssue = issues.length > 0 ? issues[0] : 0;
                await saveData();
                renderIssueSelectors();
                showLatestIssue();
                showWarning('posterWarning', `第${issue}期已全部删除`, 'green');
            }
        }

        // 新增期数
        async function addNewIssue() {
            const newIssue = libraryData.latestIssue + 1;
            libraryData.issues[newIssue] = {
                posters: {1: '', 2: ''},
                books: {1: {}, 2: {}}
            };
            libraryData.latestIssue = newIssue;
            await saveData();
            renderIssueSelectors();
            showWarning('issueWarning', `已新增第${newIssue}期`, 'green');
            document.getElementById('posterIssueSelect').value = newIssue;
            renderPosterThumbs(newIssue);
        }

        // 书籍管理相关
        function updateBookPosterSelect() {
            const issue = document.getElementById('bookIssueSelect').value;
            const posterSelect = document.getElementById('bookPosterSelect');
            posterSelect.innerHTML = '';
            posterSelect.innerHTML = `
                <option value="1">海报1</option>
                <option value="2">海报2</option>
            `;
            updateBookNumSelect();
        }

        function updateBookNumSelect() {
            // 书籍序号固定1-9
        }

        // 检测书名重复
        function checkDuplicateTitle() {
            const newTitle = document.getElementById('bookTitle').value.trim();
            const titleWarning = document.getElementById('titleWarning');
            
            if (!newTitle) {
                titleWarning.textContent = '';
                return false;
            }
            
            const currentIssue = document.getElementById('bookIssueSelect').value;
            const currentPoster = document.getElementById('bookPosterSelect').value;
            const currentBookNum = document.getElementById('bookNumSelect').value;
            
            for (const issue in libraryData.issues) {
                const books = libraryData.issues[issue].books;
                for (const poster in books) {
                    for (const bookNum in books[poster]) {
                        if (issue === currentIssue && poster === currentPoster && bookNum === currentBookNum) {
                            continue;
                        }
                        if (books[poster][bookNum]?.title === newTitle) {
                            titleWarning.textContent = `警告：往期已有同名书籍“${newTitle}”`;
                            return true;
                        }
                    }
                }
            }
            
            titleWarning.textContent = '';
            return false;
        }

        // 保存/修改书籍
        async function saveBookInfo() {
            const title = document.getElementById('bookTitle').value.trim();
            if (!title) {
                alert('请输入书名');
                return;
            }
            
            const isDuplicate = checkDuplicateTitle();
            if (isDuplicate && !confirm(`往期已有同名书籍“${title}”，确定要继续吗？`)) {
                return;
            }
            
            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;
            
            if (!libraryData.issues[issue]) {
                libraryData.issues[issue] = { posters: {}, books: {1: {}, 2: {}} };
            }
            if (!libraryData.issues[issue].books[posterNum]) {
                libraryData.issues[issue].books[posterNum] = {};
            }
            
            let coverUrl = 'https://via.placeholder.com/100x150?text=封面';
            const coverFile = document.getElementById('bookCoverUpload').files[0];
            const coverInput = document.getElementById('bookCoverUpload');
            
            if (coverFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    coverUrl = e.target.result;
                    await saveBookData();
                    coverInput.value = '';
                };
                reader.readAsDataURL(coverFile);
            } else {
                const existingBook = libraryData.issues[issue].books[posterNum][bookNum];
                if (existingBook && existingBook.cover) {
                    coverUrl = existingBook.cover;
                }
                await saveBookData();
            }

            async function saveBookData() {
                libraryData.issues[issue].books[posterNum][bookNum] = {
                    callNo: document.getElementById('bookCallNo').value,
                    title: title,
                    classCode: document.getElementById('bookClassCode').value,
                    author: document.getElementById('bookAuthor').value,
                    intro: document.getElementById('bookIntro').value,
                    suitable: document.getElementById('bookSuitable').value,
                    status: document.getElementById('bookStatus').value,
                    cover: coverUrl
                };
                await saveData();
                alert('书籍信息已保存');
                renderBooks(issue, posterNum);
                updateRecordsBookTitle(issue, posterNum, bookNum, title);
            }
        }

        // 删除书籍
        async function deleteBookInfo() {
            const issue = document.getElementById('bookIssueSelect').value;
            const posterNum = document.getElementById('bookPosterSelect').value;
            const bookNum = document.getElementById('bookNumSelect').value;
            const books = libraryData.issues[issue]?.books[posterNum];
            
            if (!books || !books[bookNum]) {
                alert('该书籍不存在');
                return;
            }
            
            if (confirm(`确定要删除第${issue}期第${posterNum}张海报的第${bookNum}本书吗？`)) {
                delete books[bookNum];
                await saveData();
                renderBooks(issue, posterNum);
                alert('书籍已删除');
            }
        }

        // 创建书籍卡片
        function createBookCard(book) {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.dataset.classCode = book.classCode;
            card.dataset.id = book.id || `${book.issue}-${book.posterNum}-${book.bookNum}`;
            
            let statusText = '';
            let statusClass = '';
            let reserveButton = '';
            
            switch(book.status) {
                case 'in':
                    statusText = '在架';
                    statusClass = 'status-in';
                    reserveButton = `<button class="reserve-btn" onclick="showReserveModal('${card.dataset.id}')">预约</button>`;
                    break;
                case 'out':
                    statusText = '不在架';
                    statusClass = 'status-out';
                    break;
                case 'reserved':
                    statusText = '已被预约';
                    statusClass = 'status-reserved';
                    break;
            }
            
            card.innerHTML = `
                <img src="${book.cover}" class="book-cover">
                <h3 class="book-title">${book.title}</h3>
                <p>作者: ${book.author}</p>
                <p>简介: ${book.intro}</p>
                <p>适合: ${book.suitable}</p>
                <div class="book-status-bar">
                    <span class="book-status ${statusClass}">${statusText}${statusText === '在架' ? '（可预约）' : ''}</span>
                    ${reserveButton}
                </div>
                <p class="book-callno">索书号: ${book.callNo}</p>
            `;
            
            return card;
        }

        // 渲染书籍列表
        function renderBooks(issue, posterNum) {
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            const books = libraryData.issues[issue]?.books[posterNum] || {};
            
            // 按3个一组显示，每组相同背景色
            let groupIndex = 0;
            for (let i = 1; i <= 9; i++) {
                if (i % 3 === 1) {
                    groupIndex++;
                }
                
                const book = books[i] || {
                    callNo: '待编辑',
                    title: '新书' + i,
                    classCode: '000',
                    author: '待编辑',
                    intro: '待编辑',
                    suitable: '待编辑',
                    status: 'out',
                    cover: 'https://via.placeholder.com/100x150?text=新书' + i,
                    issue,
                    posterNum,
                    bookNum: i
                };
                
                const card = createBookCard(book);
                card.dataset.group = groupIndex;
                container.appendChild(card);
            }
        }

        // 渲染当前视图（用于状态更新后刷新）
        function renderCurrentView() {
            const activeSection = document.querySelector('.content-section:not(.hidden)');
            if (activeSection.id === 'posterSection') {
                const currentIssue = document.getElementById('issueSelect').value;
                const activePoster = document.querySelector('.poster-thumb:hover')?.dataset.poster || '1';
                renderBooks(currentIssue, activePoster);
            } else if (activeSection.id === 'userRecommendsSection') {
                renderUserRecommendList();
            }
        }

        // 预约记录管理
        function renderReserveRecords() {
            const container = document.getElementById('reserveRecordsContainer');
            container.innerHTML = '';
            
            if (libraryData.reserveRecords.length === 0) {
                container.innerHTML = '<p>暂无预约记录</p>';
                return;
            }
            
            // 按时间倒序排列
            const sortedReserves = [...libraryData.reserveRecords]
                .sort((a, b) => new Date(b.time) - new Date(a.time));
                
            sortedReserves.forEach((r, i) => {
                const recordId = `reserve-${i}`;
                container.innerHTML += `
                    <div class="record-item">
                        <div>
                            ${r.time} | ${r.bookTitle} | ${r.className} ${r.studentName}
                        </div>
                        <select class="record-status" id="${recordId}" onchange="updateReserveStatus(${i}, this.value)">
                            <option value="已预约" ${r.status === '已预约' ? 'selected' : ''}>已预约</option>
                            <option value="处理中" ${r.status === '处理中' ? 'selected' : ''}>处理中</option>
                            <option value="借走了" ${r.status === '借走了' ? 'selected' : ''}>借走了</option>
                            <option value="找不到" ${r.status === '找不到' ? 'selected' : ''}>找不到</option>
                            <option value="已还书" ${r.status === '已还书' ? 'selected' : ''}>已还书</option>
                        </select>
                    </div>
                `;
            });
        }

        // 推荐购书记录管理
        function renderRecommendRecords() {
            const container = document.getElementById('recommendRecordsContainer');
            container.innerHTML = '';
            
            if (libraryData.recommendRecords.length === 0) {
                container.innerHTML = '<p>暂无推荐记录</p>';
                return;
            }
            
            const sortedRecommends = [...libraryData.recommendRecords]
                .sort((a, b) => new Date(b.time) - new Date(a.time));
                
            sortedRecommends.forEach((r, i) => {
                const recordId = `recommend-${i}`;
                container.innerHTML += `
                    <div class="record-item">
                        <div>
                            ${r.time} | 书名: ${r.bookName} | 理由: ${r.reason}
                        </div>
                        <select class="record-status" id="${recordId}" onchange="updateRecommendStatus(${i}, this.value)">
                            <option value="已推荐" ${r.status === '已推荐' ? 'selected' : ''}>推荐中</option>
                            <option value="已记录" ${r.status === '已记录' ? 'selected' : ''}>已记录</option>
                            <option value="不合規定" ${r.status === '不合規定' ? 'selected' : ''}>不合规定</option>
                        </select>
                    </div>
                `;
            });
        }

        // 更新记录中的书籍名称
        function updateRecordsBookTitle(issue, posterNum, bookNum, newTitle) {
            const bookId = `${issue}-${posterNum}-${bookNum}`;
            libraryData.reserveRecords.forEach(r => {
                if (r.bookId === bookId) {
                    r.bookTitle = newTitle;
                    updateDoc(doc(db, "reserves", r.id), {
                        bookTitle: newTitle
                    });
                }
            });
        }

        // 预约和推荐功能
        function showReserveModal(bookId) {
            const [issue, posterNum, bookNum] = bookId.split('-');
            const book = libraryData.issues[issue].books[posterNum][bookNum];
            document.getElementById('bookReserveInfo').innerText = `书名: ${book.title}`;
            document.getElementById('reserveBookId').value = bookId;
            document.getElementById('reserveModal').classList.remove('hidden');
        }

        document.getElementById('reserveForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const bookId = document.getElementById('reserveBookId').value;
            const [issue, posterNum, bookNum] = bookId.split('-');
            const book = libraryData.issues[issue].books[posterNum][bookNum];
            
            const newReserve = {
                bookId,
                bookTitle: book.title,
                className: document.getElementById('className').value,
                studentName: document.getElementById('studentName').value,
                time: new Date().toLocaleString(),
                status: '已预约'
            };
            
            await saveReserveRecord(newReserve);
            closeAllModals();
            alert('预约成功！请1小时内到图书馆确认，书籍保留2天');
            this.reset();
        });

        function showRecommendForm() {
            document.getElementById('recommendModal').classList.remove('hidden');
        }

        document.getElementById('recommendForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newRecommend = {
                bookName: document.getElementById('recommendBookName').value,
                reason: document.getElementById('recommendReason').value,
                time: new Date().toLocaleString(),
                status: '已推荐'
            };
            
            await saveRecommendRecord(newRecommend);
            closeAllModals();
            alert('推荐成功，感谢你的建议！');
            this.reset();
            showUserRecommends(); // 刷新推荐列表
        });

        // 关键词搜索（全局所有书籍）
        function searchBooks() {
            const keyword = document.getElementById('keywordInput').value.toLowerCase();
            if (!keyword) {
                showLatestIssue();
                return;
            }
            
            const allBooks = libraryData.allBooks;
            const booksContainer = document.getElementById('booksContainer');
            booksContainer.innerHTML = '';
            
            // 搜索所有匹配的书籍
            const matchedBooks = allBooks.filter(book => 
                book.title.toLowerCase().includes(keyword) ||
                book.author.toLowerCase().includes(keyword) ||
                book.callNo.toLowerCase().includes(keyword) ||
                book.intro.toLowerCase().includes(keyword)
            );
            
            // 按3个一组显示
            let groupIndex = 0;
            matchedBooks.forEach((book, index) => {
                if (index % 3 === 0) {
                    groupIndex++;
                }
                
                const card = createBookCard(book);
                card.dataset.group = groupIndex;
                booksContainer.appendChild(card);
            });
            
            if (matchedBooks.length === 0) {
                booksContainer.innerHTML = '<p>没有找到匹配的书籍</p>';
            }
            
            showSection('posterSection');
            document.getElementById('currentIssueTitle').textContent = `搜索结果: "${keyword}"`;
        }

        // 显示指定区域，隐藏其他区域
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // 管理员登录/退出
        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            if (user === '123' && pass === '123') {
                closeAllModals();
                document.getElementById('adminPanel').classList.remove('hidden');
                renderReserveRecords();
                renderRecommendRecords();
            } else {
                alert('账号或密码错误');
            }
        });

        function logoutAdmin() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // 辅助函数
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
            });
        }

        function showWarning(elementId, text, color = '#f44336') {
            const warning = document.getElementById(elementId);
            warning.textContent = text;
            warning.style.color = color;
            setTimeout(() => { warning.textContent = ''; }, 3000);
        }

        // 全局函数声明
        window.switchIssue = switchIssue;
        window.showLatestIssue = showLatestIssue;
        window.showUserRecommends = showUserRecommends;
        window.searchBooks = searchBooks;
        window.uploadPoster = uploadPoster;
        window.deleteSinglePoster = deleteSinglePoster;
        window.deleteWholeIssue = deleteWholeIssueHandler;
        window.addNewIssue = addNewIssue;
        window.updateBookPosterSelect = updateBookPosterSelect;
        window.updateBookNumSelect = updateBookNumSelect;
        window.checkDuplicateTitle = checkDuplicateTitle;
        window.saveBookInfo = saveBookInfo;
        window.deleteBookInfo = deleteBookInfo;
        window.showReserveModal = showReserveModal;
        window.showRecommendForm = showRecommendForm;
        window.showAdminLogin = showAdminLogin;
        window.logoutAdmin = logoutAdmin;
        window.closeAllModals = closeAllModals;
        window.updateReserveStatus = updateReserveStatus;
        window.updateRecommendStatus = updateRecommendStatus;

        // 页面加载时从Firebase加载数据
        window.onload = loadData;
    </script>
    <style>
        /* 基础样式 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "PingFang SC", "Helvetica Neue", sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }
        button, input, select, textarea { padding: 8px 12px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #4CAF50; color: white; cursor: pointer; border: none; transition: background 0.3s; }
        button:hover { background: #45a049; }
        .delete-btn { background: #f44336; }
        .delete-btn:hover { background: #d32f2f; }
        .primary-btn { background: #2196F3; }
        .primary-btn:hover { background: #1976D2; }
        .content-section { margin: 20px 0; }

        /* 顶部区域 */
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #333; margin: 10px 0; }
        .issue-selector { margin: 15px 0; }

        /* 导航栏 */
        .nav-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin: 20px 0; padding: 10px; border-radius: 8px; }
        .nav-item { 
            background: #e0e0e0; 
            padding: 8px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
        }
        .nav-item:hover { background: #d0d0d0; }
        .keyword-search { margin-left: auto; }

        /* 分类下拉菜单 */
        .category-dropdown { position: relative; }
        .category-trigger { display: flex; align-items: center; gap: 5px; }
        .category-trigger::after {
            content: "▼";
            font-size: 0.8em;
        }
        .category-menu { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 10px; 
            width: 200px; 
            z-index: 10; 
            display: none; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 5px;
        }
        .category-menu.visible { display: block; }
        .category-item { padding: 8px; cursor: pointer; border-radius: 2px; }
        .category-item:hover { background: #f0f0f0; }

        /* 海报区 */
        .poster-section { margin: 30px 0; }
        .poster-thumbnails { 
            display: flex; 
            gap: 20px; 
            margin: 20px 0; 
            justify-content: center;
            width: 100%;
        }
        .poster-thumb { 
            flex: 1;
            max-width: 500px;
            height: auto; 
            min-height: 300px;
            object-fit: contain; 
            cursor: pointer; 
            border: 2px solid #ddd; 
            border-radius: 4px; 
            background: #f9f9f9; 
            padding: 10px;
            transition: border-color 0.3s;
        }
        .poster-thumb:hover { border-color: #2196F3; }
        .poster-thumb.placeholder { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #999; 
            font-size: 1.2em;
        }

        /* 书籍资料格 */
        .books-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        .book-card { 
            border: 1px solid #ddd; 
            padding: 15px; 
            border-radius: 8px; 
            transition: transform 0.2s; 
        }
        .book-card[data-group="1"],
        .book-card[data-group="3"],
        .book-card[data-group="5"] { background: #f9f9f9; }
        .book-card[data-group="2"],
        .book-card[data-group="4"],
        .book-card[data-group="6"] { background: #f0f9f0; }
        .book-card:hover { transform: translateY(-3px); }
        .book-cover { width: 100px; height: 150px; object-fit: cover; margin: 0 auto 10px; display: block; }
        .book-title { text-align: center; margin: 10px 0; color: #333; }
        .book-status-bar { 
            margin: 10px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .book-status { font-weight: bold; }
        .status-in { color: #4CAF50; }
        .status-out { color: #f44336; }
        .status-reserved { color: #ff9800; }
        .reserve-btn { background: #2196F3; }
        .reserve-btn:hover { background: #1976D2; }
        .book-callno { color: #666; font-size: 0.9em; margin-top: 5px; }

        /* 推荐购书区 */
        .user-recommends { 
            margin: 30px 0; 
            padding: 15px; 
            background: #f9f9f9; 
            border-radius: 8px; 
        }
        .user-recommends h3 { margin-bottom: 10px; }
        .recommend-list { 
            display: flex; 
            flex-direction: column;
            gap: 10px; 
            margin-top: 20px;
        }
        .recommend-item { 
            padding: 10px; 
            border: 1px solid #eee; 
            border-radius: 4px; 
            background: white;
            display: flex;
            align-items: center;
        }
        .recommend-index { 
            width: 30px; 
            text-align: center; 
            margin-right: 10px; 
            color: #666;
        }
        .recommend-name { 
            flex: 1;
        }
        .recommend-status { 
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em; 
            margin-left: 10px; 
        }
        .status-recorded { 
            background: #e8f5e9;
            color: #2e7d32; 
        }
        .status-invalid { 
            background: #ffebee;
            color: #c62828; 
        }
        .status-pending {
            background: #fff8e1;
            color: #f57c00;
        }
        .recommend-add-btn {
            margin-bottom: 15px;
        }

        /* 弹窗样式 */
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
        }
        .modal-content { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            width: 90%; 
            max-width: 400px; 
            position: relative; 
        }
        .close-modal { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            cursor: pointer; 
            font-size: 1.5em; 
        }
        .close-modal:hover { color: #f44336; }

        /* 编辑后台 */
        .admin-login { 
            position: fixed; 
            bottom: 10px; 
            right: 10px; 
            font-size: 0.8em; 
            color: #666; 
            cursor: pointer; 
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .admin-panel { 
            margin: 20px 0; 
            padding: 20px; 
            background: #f0f0f0; 
            border-radius: 8px; 
        }
        .form-group { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            background: white; 
        }
        .form-group h3 { margin-bottom: 15px; color: #333; }
        .book-editor { 
            margin: 10px 0; 
            padding: 10px; 
            border: 1px dashed #ccc; 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }
        .warning { color: #f44336; font-size: 0.9em; margin: 5px 0; }
        .record-item { 
            padding: 8px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .record-status { min-width: 100px; }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .books-grid { grid-template-columns: 1fr 1fr; }
            .poster-thumbnails { flex-direction: column; }
            .poster-thumb { max-width: 100%; }
            .nav-bar { flex-direction: column; align-items: stretch; }
            .keyword-search { margin-left: 0; width: 100%; }
            .keyword-search input { width: 70%; }
        }

        @media (max-width: 480px) {
            .books-grid { grid-template-columns: 1fr; }
            .keyword-search input { width: 60%; }
        }
    </style>
</head>
<body>
    <!-- 顶部区域 -->
    <div class="header">
        <h1>XX中学图书馆 | 每周新书速递</h1>
        <div class="issue-selector">
            <label>选择期数: </label>
            <select id="issueSelect" onchange="switchIssue(this.value)">
                <option value="1">第一期</option>
            </select>
        </div>
    </div>

    <!-- 导航栏 -->
    <div class="nav-bar">
        <div class="nav-item" onclick="showLatestIssue()">最新一期</div>
        <div class="nav-item category-dropdown">
            <span class="category-trigger">分类</span>
            <div class="category-menu" id="categoryMenu">
                <div class="category-item" data-category="all">全部</div>
                <div class="category-item" data-category="000">000 总类</div>
                <div class="category-item" data-category="100">100 哲学</div>
                <div class="category-item" data-category="200">200 宗教</div>
                <div class="category-item" data-category="300">300 科学</div>
                <div class="category-item" data-category="400">400 应用科学</div>
                <div class="category-item" data-category="500">500 社科</div>
                <div class="category-item" data-category="600">600 历史</div>
                <div class="category-item" data-category="700">700 世界史</div>
                <div class="category-item" data-category="800">800 语文</div>
                <div class="category-item" data-category="900">900 艺术</div>
            </div>
        </div>
        <div class="nav-item" onclick="showUserRecommends()">推荐购书</div>
        <div class="nav-item keyword-search">
            <label>关键词检索: </label>
            <input type="text" id="keywordInput" placeholder="输入书名/作者/索书号...">
            <button onclick="searchBooks()">搜索</button>
        </div>
    </div>

    <!-- 推荐购书展示区 -->
    <div class="user-recommends content-section hidden" id="userRecommendsSection">
        <h3>大家推荐的书籍</h3>
        <button class="recommend-add-btn primary-btn" onclick="showRecommendForm()">点击为图书馆推荐书籍</button>
        <div class="recommend-list" id="userRecommendList">
            <!-- 动态生成 -->
        </div>
    </div>

    <!-- 海报区 -->
    <div class="poster-section content-section" id="posterSection">
        <h2 id="currentIssueTitle">第一期海报</h2>
        <div class="poster-thumbnails" id="posterThumbContainer">
            <div class="poster-thumb placeholder" data-poster="1">
                海报1<br>[暂未上传]
            </div>
            <div class="poster-thumb placeholder" data-poster="2">
                海报2<br>[暂未上传]
            </div>
        </div>
        <div id="booksContainer" class="books-grid">
            <!-- 书籍卡片将动态生成 -->
        </div>
    </div>

    <!-- 预约弹窗 -->
    <div class="modal hidden" id="reserveModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>预约书籍</h3>
            <div id="bookReserveInfo"></div>
            <form id="reserveForm">
                <input type="hidden" id="reserveBookId">
                <div class="form-group">
                    <label>班级: </label>
                    <input type="text" id="className" required>
                </div>
                <div class="form-group">
                    <label>姓名: </label>
                    <input type="text" id="studentName" required>
                </div>
                <button type="submit">提交预约</button>
            </form>
        </div>
    </div>

    <!-- 推荐购书弹窗 -->
    <div class="modal hidden" id="recommendModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>推荐购买书籍</h3>
            <form id="recommendForm">
                <div class="form-group">
                    <label>书名: </label>
                    <input type="text" id="recommendBookName" required>
                </div>
                <div class="form-group">
                    <label>推荐理由: </label>
                    <textarea id="recommendReason" required></textarea>
                </div>
                <button type="submit">提交推荐</button>
            </form>
        </div>
    </div>

    <!-- 管理员登录弹窗 -->
    <div class="modal hidden" id="adminLoginModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>管理员登录</h3>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label>账号: </label>
                    <input type="text" id="adminUser" required>
                </div>
                <div class="form-group">
                    <label>密码: </label>
                    <input type="password" id="adminPass" required>
                </div>
                <button type="submit">登录</button>
            </form>
        </div>
    </div>

    <!-- 管理员后台 -->
    <div class="admin-panel hidden" id="adminPanel">
        <h2>管理员后台</h2>
        <button onclick="logoutAdmin()">退出登录</button>

        <!-- 1. 期数管理 -->
        <div class="form-group">
            <h3>1. 期数管理</h3>
            <button class="primary-btn" onclick="addNewIssue()">新增期数</button>
            <div class="warning" id="issueWarning"></div>
        </div>

        <!-- 2. 海报管理 -->
        <div class="form-group">
            <h3>2. 海报管理</h3>
            <label>选择期数: </label>
            <select id="posterIssueSelect" onchange="updatePosterNumSelect()">
                <option value="1">第一期</option>
            </select>
            <label>选择序号: </label>
            <select id="posterNumSelect">
                <option value="1">海报1</option>
                <option value="2">海报2</option>
            </select>
            <input type="file" id="posterUpload" accept="image/*">
            <button onclick="uploadPoster()">重新上传海报</button>
            <button class="delete-btn" onclick="deleteSinglePoster()">删除此海报</button>
            <button class="delete-btn" onclick="deleteWholeIssue()">删除整期海报</button>
            <div class="warning" id="posterWarning"></div>
        </div>

        <!-- 3. 书籍信息编辑 -->
        <div class="form-group">
            <h3>3. 书籍信息管理</h3>
            <div>
                <label>选择期数: </label>
                <select id="bookIssueSelect" onchange="updateBookPosterSelect()">
                    <option value="1">第一期</option>
                </select>
                <label>选择海报序号: </label>
                <select id="bookPosterSelect" onchange="updateBookNumSelect()">
                    <option value="1">海报1</option>
                    <option value="2">海报2</option>
                </select>
                <label>选择书籍序号: </label>
                <select id="bookNumSelect">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>
            
            <div class="book-editor">
                <input type="text" id="bookCallNo" placeholder="索书号">
                <input type="text" id="bookTitle" placeholder="书名" onblur="checkDuplicateTitle()">
                <div class="warning" id="titleWarning"></div>
                <label>分类代码: </label>
                <select id="bookClassCode">
                    <option value="000">000 总类</option>
                    <option value="100">100 哲学</option>
                    <option value="200">200 宗教</option>
                    <option value="300">300 科学</option>
                    <option value="400">400 应用科学</option>
                    <option value="500">500 社科</option>
                    <option value="600">600 历史</option>
                    <option value="700">700 世界史</option>
                    <option value="800">800 语文</option>
                    <option value="900">900 艺术</option>
                </select>
                <input type="text" id="bookAuthor" placeholder="作者">
                <textarea id="bookIntro" placeholder="简介"></textarea>
                <input type="text" id="bookSuitable" placeholder="适合人群">
                <select id="bookStatus">
                    <option value="in">在架（可预约）</option>
                    <option value="out">不在架</option>
                </select>
                <input type="file" id="bookCoverUpload" accept="image/*">
                <button onclick="saveBookInfo()">保存/修改书籍</button>
                <button class="delete-btn" onclick="deleteBookInfo()">删除书籍</button>
            </div>
        </div>

        <!-- 4. 数据查看 -->
        <div class="form-group">
            <h3>4. 预约记录管理</h3>
            <div id="reserveRecordsContainer">
                <!-- 动态生成 -->
            </div>
        </div>

        <div class="form-group">
            <h3>5. 推荐购书记录管理</h3>
            <div id="recommendRecordsContainer">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 编辑者入口 -->
    <div class="admin-login" onclick="showAdminLogin()">编辑者入口</div>
</body>
</html>